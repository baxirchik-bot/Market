<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Zalvo Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
  }

  body {
    background: #f1f4ff;
    color: #0f172a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .app {
    background: #f9fafb;
    width: 100%;
    max-width: 480px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
  }

  /* HEADER */
  .app-header {
    padding: 12px 16px 10px;
    background: #ffffff;
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .app-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .app-logo-small {
    width: 45px;
    height: 45px;
    border-radius: 9px;
  }

  .app-title {
    font-weight: 600;
    font-size: 16px;
    color: #0f172a;
  }

  .app-subtitle {
    font-size: 12px;
    color: #64748b;
  }

  /* SCREEN CONTAINER (–æ—Å–Ω–æ–≤–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ) */
  .screens {
    flex: 1;
    overflow-y: auto;
    padding: 12px 12px 72px;
  }

  .screen {
    display: none;
  }
  .screen.active {
    display: block;
  }

  .screen-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
  }

  /* SEARCH + FILTER BUTTON */
  .search-bar-row {
    display: flex;
    gap: 8px;
    margin-top: 4px;
    margin-bottom: 12px;
    align-items: stretch;
  }

  .search-bar {
    flex: 1;
  }

  .search-input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    font-size: 14px;
    padding-left: 32px;
    background: #ffffff
      url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 5a6 6 0 014.472 9.972l3.278 3.278a1 1 0 01-1.414 1.414l-3.278-3.278A6 6 0 1111 5zm0 2a4 4 0 100 8 4 4 0 000-8z' fill='%2394a3b8'/%3E%3C/svg%3E")
      no-repeat 10px center;
    background-size: 16px;
  }

  .filters-btn {
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    padding: 0 10px;
    font-size: 13px;
    background: #ffffff;
    color: #1d4ed8;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    white-space: nowrap;
  }

  /* QUICK ACTIONS */
  .quick-actions-title {
    font-size: 14px;
    color: #64748b;
    margin-bottom: 6px;
  }

  .primary-btn {
    width: 100%;
    border: none;
    border-radius: 999px;
    padding: 13px 16px;
    font-size: 15px;
    font-weight: 600;
    color: #ffffff;
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
    cursor: pointer;
  }

  /* –ü–†–û–ú–û-–ë–ê–ù–ù–ï–† –ü–û–î –ö–ù–û–ü–ö–û–ô */
  .promo-banner {
    margin: 8px 0 14px;
    border-radius: 18px;
    overflow: hidden;
    background: #000;
    cursor: pointer;
  }

  .promo-banner img {
    display: block;
    width: 100%;
    height: 195px;
    object-fit: cover;
  }

  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }

  .chip {
    border-radius: 999px;
    padding: 7px 12px;
    font-size: 13px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: #ffffff;
    color: #0f172a;
    cursor: pointer;
  }
  .chip.chip-filled {
    background: #1d4ed8;
    color: #ffffff;
    border-color: transparent;
    box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
  }

  .section-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    margin-top: 4px;
  }

  /* POPULAR CATEGORIES */
  .category-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
    margin-bottom: 12px;
  }

  .category-card {
    background: #ffffff;
    border-radius: 16px;
    padding: 10px 12px;
    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.06);
    font-size: 14px;
    cursor: pointer;
    border: 1px solid transparent;
  }

  .category-card-title {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .category-card-sub {
    font-size: 12px;
    color: #64748b;
  }

  .category-card.active {
    border-color: #1d4ed8;
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    background: #eff6ff;
  }

  /* LIST (TILE) */
  .ad-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }

  .ad-card {
    position: relative;
    display: flex;
    gap: 10px;
    background: #ffffff;
    border-radius: 16px;
    padding: 10px;
    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.06);
    cursor: pointer;
    overflow: hidden;
  }

  .ad-card-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    padding: 3px 8px;
    border-radius: 999px;
    font-size: 10px;
    font-weight: 600;
    background: linear-gradient(135deg, #fb923c, #f97316);
    color: #ffffff;
  }

  .ad-card-stats-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
    font-size: 11px;
    color: #94a3b8;
  }

  .ad-card-views {
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }

  .ad-card-views::before {
    content: "üëÅ";
    font-size: 11px;
  }

  .ad-list.grid-mode {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
  }
  .ad-list.grid-mode .ad-card {
    flex-direction: column;
    padding: 8px;
  }
  .ad-list.grid-mode .ad-image {
    width: 100%;
    height: 120px;
  }

  .ad-image {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    flex-shrink: 0;
    background-size: cover;
    background-position: center;
  }

  .ad-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .ad-title {
    font-size: 14px;
    font-weight: 600;
  }

  .ad-meta {
    font-size: 12px;
    color: #64748b;
  }

  .ad-price {
    font-size: 14px;
    font-weight: 600;
    color: #16a34a;
    margin-top: 2px;
  }

  .ad-photos-count {
    font-size: 11px;
    color: #64748b;
    margin-top: 2px;
  }

  /* PROFILE / SETTINGS ‚Äî Telegram style */
#screen-profile {
  padding: 0 0 16px;
}

/* –≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å —Å –∞–≤–∞—Ç–∞—Ä–æ–º, –∏–º–µ–Ω–µ–º, –Ω–æ–º–µ—Ä–æ–º */
.settings-header {
  padding: 32px 16px 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.settings-avatar {
  width: 110px;
  height: 110px;
  border-radius: 999px;
  background: #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 12px;
}

.settings-name {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
  text-align: center;
}

.settings-phone-row {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
}

.settings-phone-link,
.settings-username {
  color: #1d4ed8;
  text-decoration: none;
}

.settings-dot {
  color: #6b7280;
}

/* –±–µ–ª—ã–µ –∫–∞—Ä—Ç—ã, –∫–∞–∫ –≤ Telegram */
.settings-card {
  margin: 8px 12px 0;
  background: #ffffff;
  border-radius: 24px;
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
  overflow: hidden;
}

/* —Å—Ç—Ä–æ–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç—ã */
.settings-row {
  width: 100%;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border: none;
  background: transparent;
  cursor: pointer;
}

.settings-row + .settings-row {
  border-top: 1px solid #e5e7eb;
}

.settings-row-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ —Å–ª–µ–≤–∞ */
.settings-row-icon {
  width: 38px;
  height: 38px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

/* —Ü–≤–µ—Ç–∞ –∏–∫–æ–Ω–æ–∫ –ø–æ–¥ Telegram */
.icon-photo     { background: #eff6ff; color: #1d4ed8; }
.icon-profile   { background: #fee2e2; color: #b91c1c; }
.icon-wallet    { background: #dbeafe; color: #1d4ed8; }
.icon-fav       { background: #fef3c7; color: #f59e0b; }
.icon-recent    { background: #dcfce7; color: #16a34a; }
.icon-devices   { background: #ffedd5; color: #ea580c; }
.icon-folders   { background: #e0f2fe; color: #0284c7; }
.icon-bell      { background: #fee2e2; color: #b91c1c; }

.settings-row-title {
  font-size: 15px;
}

/* —Å—Ç—Ä–µ–ª–∫–∞ —Å–ø—Ä–∞–≤–∞ */
.settings-row-arrow {
  color: #cbd5f5;
  font-size: 18px;
}
    
  /* NEW AD FORM */
  .back-link {
    font-size: 13px;
    color: #1d4ed8;
    margin-bottom: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .form-group {
    margin-bottom: 10px;
  }

  .form-label {
    font-size: 13px;
    margin-bottom: 4px;
    display: block;
    color: #475569;
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    padding: 9px 10px;
    font-size: 14px;
    background: #ffffff;
  }

  .form-textarea {
    resize: vertical;
    min-height: 60px;
  }

  .hint {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 2px;
  }

  .step-tag {
    display: inline-block;
    font-size: 11px;
    padding: 3px 7px;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
    margin-left: 4px;
  }

  .photos-preview-row {
    display: flex;
    gap: 8px;
    flex-wrap: nowrap;
    overflow-x: auto;
    margin-top: 6px;
  }

  .photo-thumb {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    overflow: hidden;
    background: #e5e7eb;
    flex-shrink: 0;
  }
  .photo-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .hidden-input {
    display: none;
  }

  /* SUCCESS SCREEN */
  .success-icon {
    width: 64px;
    height: 64px;
    border-radius: 999px;
    background: #dcfce7;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    margin: 12px auto;
  }

  .success-text-main {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-top: 6px;
  }

  .success-text-sub {
    font-size: 13px;
    color: #6b7280;
    text-align: center;
    margin-top: 4px;
    margin-bottom: 16px;
  }

  /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º .screens, —á—Ç–æ–±—ã –¥–∞—Ç—å –∑–∞–ø–∞—Å –ø–æ–¥ —Ç–∞–±-–±–∞—Ä */
  .screens {
    flex: 1;
    overflow-y: auto;
    padding: 12px 12px 120px;
    position: relative;
    z-index: 1;
  }

  /* === iOS-style tab bar === */
  .bottom-nav {
    position: fixed;
    bottom: 32px;
    left: 0;
    right: 0;
    width: 100%;
    padding: 4px 10px 6px;
    background: transparent;
    z-index: 50;
    display: flex;
    justify-content: center;
  }

  .bottom-nav-inner {
  width: 100%;
  max-width: 480px;

  background: rgba(255, 255, 255, 0.45); /* –±—ã–ª–æ 0.96 ‚Üí —Å—Ç–∞–ª–æ –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */

  border-radius: 26px;

  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.20);

  padding: 6px 10px;

  display: flex;
  justify-content: space-between;
  align-items: stretch;

  backdrop-filter: blur(28px) saturate(180%); /* —Å–∏–ª—å–Ω–æ–µ —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ */
  -webkit-backdrop-filter: blur(28px) saturate(180%);
}
    
  /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –∏ —Ç–µ–∫—Å—Ç */
.nav-btn {
  flex: 1;
  border: none;
  background: transparent;
  border-radius: 999px;

  min-height: 64px;               /* –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç–∞ */
  padding: 6px 8px;               /* —á—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø—ã */

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  gap: 4px;                       /* –±–æ–ª—å—à–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∏–∫–æ–Ω–∫–æ–π –∏ —Ç–µ–∫—Å—Ç–æ–º */

  font-size: 13px;                /* —Ç–µ–∫—Å—Ç –±–æ–ª—å—à–µ */
  color: #111827;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  outline: none;
  pointer-events: auto;
}

/* —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏ */
.nav-btn .icon {
  font-size: 23px;                /* ***–ò–∫–æ–Ω–∫–∞ –±–æ–ª—å—à–µ*** */
  line-height: 1;
  pointer-events: none;
}

.nav-btn span {
  pointer-events: none;
  font-weight: 500;               /* —á—É—Ç—å —á—ë—Ç—á–µ */
}

/* –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ */
.nav-btn.active {
  background: #ffffff;
  color: #007aff;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
}

.nav-btn.active .icon {
  color: #007aff;
}

  /* HEADER –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è */
  .ad-view-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .ad-view-back-btn {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    background: #ffffff;
    cursor: pointer;
    font-size: 18px;
  }

  .ad-view-header-title {
    font-size: 17px;
    font-weight: 600;
  }

  .ad-view-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 12px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
  }

  #detailMainImage {
    width: 100%;
    height: 260px;
    border-radius: 16px;
    background: #e5e7eb;
    margin-bottom: 12px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    display: flex;
  }

  .detail-main-slide {
    min-width: 100%;
    height: 100%;
    flex-shrink: 0;
    scroll-snap-align: center;
    background-size: cover;
    background-position: center;
    border-radius: 16px;
  }

  .detail-thumbs {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    margin-bottom: 10px;
  }

  .detail-thumb {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: #e5e7eb;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
  }

  .ad-view-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
    margin-top: 8px;
    margin-bottom: 4px;
  }

  .ad-view-title-box {
    flex: 1;
    min-width: 0;
  }

  .ad-view-icon-row {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .icon-circle-btn {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    cursor: pointer;
    padding: 0;
  }
  .icon-circle-btn:active {
    transform: scale(0.96);
  }

  .ad-view-main-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .ad-view-price {
    font-size: 18px;
    font-weight: 700;
    color: #16a34a;
    margin-bottom: 2px;
  }

  .ad-view-meta {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 2px;
  }

  .ad-view-description-title {
    font-size: 14px;
    font-weight: 600;
    margin-top: 8px;
    margin-bottom: 4px;
  }

  .ad-view-description {
    font-size: 14px;
    color: #374151;
    margin-bottom: 8px;
  }

  .ad-view-seller-card {
    margin-top: 8px;
    padding: 10px;
    border-radius: 16px;
    background: #f9fafb;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  .ad-view-seller-card:hover {
    background: #eef2ff;
  }

  .ad-view-seller-info-main {
    font-size: 14px;
    font-weight: 600;
  }

  .ad-view-seller-info-sub {
    font-size: 12px;
    color: #6b7280;
  }

  .ad-view-seller-status {
    font-size: 12px;
    color: #16a34a;
    margin-top: 2px;
  }

  .ad-view-actions-row {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    align-items: stretch;
  }

  .call-btn,
  .msg-btn {
    flex: 1;
    padding: 13px 0;
    font-size: 15px;
    font-weight: 600;
    border-radius: 999px;
    text-align: center;
    text-decoration: none;
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .call-btn {
    background: #22c55e;
  }

  .msg-btn {
    background: #3b82f6;
  }

  .similar-section {
    margin-top: 16px;
  }

  .similar-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .similar-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .similar-card {
    display: flex;
    gap: 8px;
    padding: 8px;
    border-radius: 12px;
    background: #f9fafb;
    cursor: pointer;
  }

  .similar-image {
    width: 52px;
    height: 52px;
    border-radius: 12px;
    background: #e5e7eb;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
  }

  .similar-content-title {
    font-size: 13px;
    font-weight: 600;
  }

  .similar-content-meta {
    font-size: 11px;
    color: #6b7280;
  }

  .similar-content-price {
    font-size: 13px;
    font-weight: 600;
    color: #16a34a;
  }

  /* –õ–∞–π—Ç–±–æ–∫—Å */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .lightbox.visible {
    display: flex;
  }

  .lightbox img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .lightbox-close-hint {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
  }

  .lightbox-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: none;
    background: rgba(15, 23, 42, 0.6);
    color: #ffffff;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .lightbox-prev {
    left: 12px;
  }

  .lightbox-next {
    right: 12px;
  }

  /* –§–ò–õ–¨–¢–†–´ –≠–ö–†–ê–ù */
  .filters-section-title {
    font-size: 14px;
    font-weight: 600;
    margin: 10px 0 6px;
  }

  .filters-actions-row {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }

  /* Promo screen */
  .promo-screen-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 14px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    margin-bottom: 14px;
  }

  .promo-screen-subtitle {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 10px;
  }

  .promo-plan-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .promo-plan {
    border-radius: 16px;
    padding: 10px 12px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .promo-plan-main {
    flex: 1;
    min-width: 0;
  }

  .promo-plan-name {
    font-size: 14px;
    font-weight: 600;
  }

  .promo-plan-desc {
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
  }

  .promo-plan-price {
    font-size: 14px;
    font-weight: 600;
    color: #16a34a;
    white-space: nowrap;
  }

  .promo-plan-tag {
    display: inline-block;
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
    margin-top: 4px;
  }

  .promo-help-text {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 10px;
  }

  /* Toast */
  .toast {
    position: fixed;
    left: 50%;
    bottom: 80px;
    transform: translateX(-50%) translateY(120%);
    opacity: 0;
    transition: all 0.25s ease-out;
    max-width: 460px;
    width: calc(100% - 40px);
    z-index: 9998;
  }

  .toast-inner {
    background: #0f172a;
    color: #f9fafb;
    border-radius: 999px;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
  }

  .toast-icon {
    font-size: 16px;
  }

  .toast-text-main {
    font-weight: 600;
  }

  .toast-text-sub {
    font-size: 12px;
    color: #e5e7eb;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  
  /* Admin */
  .admin-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 14px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    margin-bottom: 14px;
  }

  .admin-section-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .admin-stat-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }

  .admin-stat {
    flex: 1;
    background: #f9fafb;
    border-radius: 16px;
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
  }

  .admin-stat-number {
    font-size: 16px;
    font-weight: 700;
    color: #1d4ed8;
  }

  .admin-stat-label {
    font-size: 12px;
    color: #6b7280;
  }

  .admin-list {
    margin-top: 4px;
  }

  .admin-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #e5e7eb;
    font-size: 13px;
  }

  .admin-list-item:last-child {
    border-bottom: none;
  }

  .admin-list-label {
    color: #475569;
  }

  .admin-list-value {
    font-weight: 600;
    color: #0f172a;
  }

  .admin-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    background: #fee2e2;
    color: #b91c1c;
  }

    .settings-list {
  margin-top: 8px;
  background: #ffffff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 3px 10px rgba(15, 23, 42, 0.06);
}

.settings-item {
  width: 100%;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  border: none;
  background: #ffffff;
  border-bottom: 1px solid #e5e7eb;
  cursor: pointer;
  text-align: left;
}

.settings-item:last-child {
  border-bottom: none;
}

.settings-item-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.settings-item-icon {
  font-size: 18px;
}

.settings-item-chevron {
  font-size: 14px;
  color: #cbd5e1;
}

    /* ===== –ü—Ä–æ—Ñ–∏–ª—å / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤ —Å—Ç–∏–ª–µ –¢–µ–ª–µ–≥—Ä–∞–º–∞) ===== */

.settings-profile-header {
  padding: 24px 16px 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.settings-avatar-big {
  width: 96px;
  height: 96px;
  border-radius: 999px;
  background: #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 12px;
}

.settings-name {
  font-size: 22px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 4px;
}

.settings-username {
  font-size: 13px;
  color: #64748b;
}

.settings-link {
  color: #1d4ed8;
  text-decoration: none;
}

.settings-card {
  margin: 10px 12px 0;
  background: #ffffff;
  border-radius: 24px;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
  overflow: hidden;
}

.settings-row {
  width: 100%;
  padding: 13px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  background: transparent;
  border: none;
  border-top: 1px solid #f1f5f9;
  font: inherit;
  cursor: pointer;
}

.settings-row:first-child {
  border-top: none;
}

.settings-icon {
  width: 34px;
  height: 34px;
  border-radius: 12px;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 19px;
}

.settings-title {
  flex: 1;
  text-align: left;
  font-size: 15px;
  color: #111827;
}

.settings-arrow {
  font-size: 16px;
  color: #cbd5f5;
}

    /* === ZALVO BIZNES UCHUN SCREEN === */

#screen-business {
  padding: 12px 16px 24px;
}

.business-header {
  text-align: left;
  margin-bottom: 16px;
}

.business-icon-wrap {
  margin: 10px 0 12px;
  display: flex;
  justify-content: center;
}

.business-icon-inner {
  width: 96px;
  height: 96px;
  border-radius: 999px;
  background: radial-gradient(circle at 30% 20%, #a855f7, #6366f1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  color: #ffffff;
  box-shadow: 0 16px 40px rgba(79, 70, 229, 0.35);
}

.business-title {
  font-size: 24px;
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 6px;
  text-align: center; 
}

.business-subtitle {
  font-size: 14px;
  color: #6b7280;
  text-align: center;
  max-width: 320px;
  margin: 0 auto;
}

/* –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏ */
.business-card {
  margin-top: 16px;
  background: #ffffff;
  border-radius: 22px;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
  padding: 10px 0 8px;
}

.business-feature-row {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  gap: 10px;
}

.business-divider {
  height: 1px;
  background: #e5e7eb;
  margin: 0 14px;
}

.business-feature-icon {
  width: 34px;
  height: 34px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: #ffffff;
}

/* —Ü–≤–µ—Ç–∞ –∏–∫–æ–Ω–æ–∫ */
.business-feature-icon-orange {
  background: #f97316;
}
.business-feature-icon-blue {
  background: #3b82f6;
}
.business-feature-icon-pink {
  background: #ec4899;
}
.business-feature-icon-gold {
  background: #f59e0b;
}

.business-feature-main {
  flex: 1;
}

.business-feature-title {
  font-size: 15px;
  font-weight: 600;
  color: #111827;
}

.business-feature-sub {
  font-size: 13px;
  color: #6b7280;
}

/* beta text */
.business-beta {
  font-size: 13px;
  color: #4b5563;
  padding: 10px 14px 12px;
  border-top: 1px solid #e5e7eb;
  margin-top: 2px;
}

/* CTA */
.business-cta {
  margin-top: 18px;
}

.business-cta-btn {
  width: 100%;
  border: none;
  border-radius: 999px;
  padding: 13px 16px;
  font-size: 15px;
  font-weight: 600;
  color: #ffffff;
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  box-shadow: 0 10px 26px rgba(79, 70, 229, 0.4);
  cursor: pointer;
}

.business-cta-btn:active {
  transform: scale(0.97);
}

.business-cta-hint {
  margin-top: 6px;
  font-size: 12px;
  color: #9ca3af;
  text-align: center;
}

 /* --- –ë–ê–ó–û–í–´–ô –§–û–ù –î–õ–Ø –≠–ö–†–ê–ù–ê –ú–ê–ì–ê–ó–ò–ù–ê --- */
.store-page {
  background: #f5f6fa;
  min-height: 100vh;
  padding: 0 0 16px 0;
  display: flex;
  flex-direction: column;
  align-items: center; /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë –ø–æ —ç–∫—Ä–∞–Ω—É */
  gap: 12px;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
}

/* --- –û–ë–õ–û–ñ–ö–ê –° –§–û–ù–û–ú –¢–ï–õ–ï–§–û–ù–û–í --- */
.store-cover {
  position: relative;
  height: 190px;
  width: 100vw;            /* —à–∏—Ä–∏–Ω–∞ –ø–æ —ç–∫—Ä–∞–Ω—É */
  max-width: 480px;        /* —á—Ç–æ–±—ã –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –Ω–µ —Ä–∞–∑—ä–µ–∑–∂–∞–ª–æ—Å—å */
  border-radius: 22px;
  overflow: visible;
  box-shadow: 0 14px 32px rgba(15, 23, 42, 0.16);
  background: #e5e7eb;
}

.store-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
    
/* --- –ê–í–ê–¢–ê–† –° –õ–û–ì–û–¢–ò–ü–û–ú --- */
.store-avatar {
  position: absolute;
  left: 50%;
  bottom: -40px;           /* –æ—Ç—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ–±—ã –ù–ï –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç */
  transform: translateX(-50%);
  width: 96px;
  height: 96px;
  border-radius: 50%;
  background: #ffffff;
  padding: 6px;
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.28);
  z-index: 2;
}

.store-avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

/* --- –û–ë–©–ò–ô –°–¢–ò–õ–¨ –ö–ê–†–¢–û–ß–ï–ö (iOS card view) --- */
.store-card {
  background: #ffffff;
  border-radius: 18px;
  padding: 16px 16px;
  box-shadow: 0 10px 26px rgba(15, 23, 42, 0.10);
  width: calc(100vw - 24px); /* —à–∏—Ä–∏–Ω–∞ = —ç–∫—Ä–∞–Ω - 12px —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ */
  max-width: 472px;          /* 480 - 8 –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
}

/* --- –ö–ê–†–¢–û–ß–ö–ê –ü–†–û–§–ò–õ–Ø –ú–ê–ì–ê–ó–ò–ù–ê --- */
.store-profile {
  margin-top: -14px;         /* —Å–ª–µ–≥–∫–∞ –∑–∞–ª–µ–∑–∞–µ–º –Ω–∞ —Ñ–æ–Ω */
  padding-top: 54px;         /* –¥–∞—ë–º –º–µ—Å—Ç–æ –ø–æ–¥ –∞–≤–∞—Ç–∞—Ä–∫—É */
  text-align: center;
}

.store-name {
  font-size: 20px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 4px;
}

.store-subs {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 8px;
}

.store-rating {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 12px;
}

.store-rating-stars {
  color: #fbbf24;
  letter-spacing: 2px;
  font-size: 14px;
}

.store-rating-count {
  color: #6b7280;
}

/* --- –†–Ø–î –ö–ù–û–ü–û–ö: OBUNA, YOZISH, ... --- */
.store-actions {
  display: grid;
  grid-template-columns: 1.3fr 1.3fr 0.6fr;
  gap: 8px;
  margin-top: 4px;
}

.store-btn {
  border-radius: 999px;
  padding: 10px 0;
  border: none;
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.store-btn-primary {
  background: #5a4bff;
  color: #ffffff;
}

.store-btn-secondary {
  background: #f3f4f6;
  color: #111827;
}

.store-btn-more {
  background: #f3f4f6;
  color: #111827;
  font-size: 20px;
}

/* --- –ö–ê–°–¢–û–ú–ù–´–ï –ò–ö–û–ù–ö–ò --- */
.icon-pill {
  width: 20px;
  height: 20px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: #ffffff;
}

.icon-pill-bell { background: #5a4bff; }
.icon-pill-msg  { background: #10b981; }

/* --- –ö–ê–†–¢–û–ß–ö–ê –ö–û–ù–¢–ê–ö–¢–û–í --- */
.store-section-title {
  font-size: 15px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 8px;
}

.store-contacts-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 13px;
  color: #111827;
}

.store-contact-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.store-contact-icon {
  width: 22px;
  height: 22px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  color: #ffffff;
}

.store-contact-icon.phone { background: #5a4bff; }
.store-contact-icon.tg    { background: #1d9bf0; }
.store-contact-icon.ig    { background: #e11d48; }
.store-contact-icon.loc   { background: #f97316; }
.store-contact-icon.clock { background: #10b981; }

.store-contact-row a {
  color: #2563eb;
  text-decoration: none;
}

.store-contact-row small {
  color: #6b7280;
}

.store-about-text {
  font-size: 13px;
  color: #6b7280;
  line-height: 1.4;
}

/* --- –ë–õ–û–ö E‚ÄòLONLAR: –ó–ê–ì–û–õ–û–í–û–ö + –ü–û–ò–°–ö + –§–ò–õ–¨–¢–† --- */
.store-ads-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.store-ads-title {
  font-size: 16px;
  font-weight: 600;
  color: #111827;
}

.store-search-row {
  display: flex;
  gap: 8px;
  margin-bottom: 4px;
}

.store-search-input {
  flex: 1;
  background: #f3f4f6;
  border-radius: 999px;
  border: none;
  padding: 9px 12px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.store-search-input input {
  border: none;
  background: transparent;
  outline: none;
  font-size: 13px;
  width: 100%;
}

.store-search-input span {
  color: #6b7280;
}

.store-filter-btn {
  width: 40px;
  border-radius: 999px;
  background: #f3f4f6;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

/* --- –ö–ê–†–¢–û–ß–ö–ê –û–ë–™–Ø–í–õ–ï–ù–ò–Ø --- */
.store-ad-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 10px;
  display: flex;
  gap: 10px;
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.10);
}

.store-ad-img {
  width: 90px;
  height: 90px;
  border-radius: 12px;
  overflow: hidden;
  background: #e5e7eb;
  flex-shrink: 0;
}

.store-ad-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.store-ad-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.store-ad-title {
  font-size: 14px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 2px;
}

.store-ad-price {
  font-size: 15px;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 4px;
}

.store-ad-meta {
  font-size: 11px;
  color: #6b7280;
  display: flex;
  justify-content: space-between;
}

    /* ===== GRID –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –º–∞–≥–∞–∑–∏–Ω–∞ ===== */
#screen-my-shop .ad-list{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

    /* –∫–∞—Ä—Ç–æ—á–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ */
#screen-my-shop .ad-card{
  flex-direction: column;
  padding: 8px;
  border-radius: 16px;
}

    #screen-my-shop .ad-image{
  width: 100%;
  aspect-ratio: 1 / 1;   /* üî• –∫–≤–∞–¥—Ä–∞—Ç */
  height: auto;
  border-radius: 12px;
  margin-bottom: 6px;
}

    #screen-my-shop .ad-title{
  font-size: 13px;
  line-height: 1.3;
}

#screen-my-shop .ad-price{
  font-size: 14px;
  font-weight: 700;
}

#screen-my-shop .ad-meta{
  font-size: 11px;
}
    
@keyframes sheetUp {
  from { transform: translateY(40px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}

  /* –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ –∫ –±–æ–∫–∞–º */
  @media (max-width: 480px) {
    .store-page {
      padding: 12px;
    }
  }

    /* –û–±—ë—Ä—Ç–∫–∞, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –Ω–∞–¥ —Ñ–æ–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–∞ */
.store-back-wrapper {
  position: relative;
  z-index: 3;
  padding: 16px 0 0 16px; /* –æ—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è –∏ —Å–ª–µ–≤–∞ */
}

/* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤ —Å—Ç–∏–ª–µ iOS */
.store-back-button {
  width: 40px;
  height: 40px;
  border-radius: 999px;
  border: none;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;

  background: rgba(255, 255, 255, 0.92);
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.18);

  cursor: pointer;
}

/* –ë–ª—é—Ä, –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è */
@supports (backdrop-filter: blur(16px)) {
  .store-back-button {
    background: rgba(255, 255, 255, 0.72);
    backdrop-filter: blur(16px);
  }
}

.store-back-icon {
  width: 18px;
  height: 18px;
  fill: #111827;
}

    /* ===== iOS BACK BUTTON (global) ===== */
.ios-back-btn {
  width: 40px;
  height: 40px;
  border-radius: 999px;
  border: none;
  padding: 0;
  display: none;              /* —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.92);
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.14);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
@supports (backdrop-filter: blur(16px)) {
  .ios-back-btn {
    background: rgba(255, 255, 255, 0.70);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
}
.ios-back-btn svg {
  width: 18px;
  height: 18px;
  fill: #111827;
}
.ios-back-btn:active {
  transform: scale(0.96);
}

/* –º–∞–ª–µ–Ω—å–∫–∏–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥ –∏ –ª–æ–≥–æ—Ç–∏–ø–æ–º */
.app-header-left {
  gap: 10px;
}

/* ===== iOS-like slide animation on back ===== */
.screens.ios-back-anim {
  transition: transform 0.22s ease-out, opacity 0.22s ease-out;
  transform: translateX(22px);
  opacity: 0.92;
}

/* ===== STORE BOTTOM SHEET (–≤–µ—Ä–Ω—É–ª —Ç–æ, —á—Ç–æ —Ç—ã —Å–ª—É—á–∞–π–Ω–æ ‚Äú—Å–ª–æ–º–∞–ª‚Äù) ===== */
.store-sheet-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 999;
}

.store-sheet-backdrop.active {
  display: flex;
}

.store-sheet {
  width: 100%;
  max-width: 480px;
  background: #ffffff;
  border-radius: 24px 24px 0 0;
  padding: 10px 16px 18px;
  box-shadow: 0 -10px 30px rgba(15, 23, 42, 0.25);
  animation: sheetUp 0.18s ease-out;
}

.store-sheet-handle {
  width: 40px;
  height: 4px;
  border-radius: 999px;
  background: #e5e7eb;
  margin: 4px auto 10px;
}

.store-sheet-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.store-sheet-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 15px;
  color: #111827;
  padding: 10px 6px;
  border-radius: 12px;
}

.store-sheet-item:active {
  background: #f3f4f6;
}

.store-sheet-icon {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  color: #ffffff;
}

.store-sheet-icon.block { background: #6b7280; }
.store-sheet-icon.share { background: #2563eb; }
.store-sheet-icon.report { background: #ef4444; }

    /* iOS-style secondary / outline button */
.outline-btn {
  width: 100%;
  border-radius: 999px;
  padding: 13px 16px;
  font-size: 15px;
  font-weight: 500;

  background: #f3f4f6;        /* —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π –∫–∞–∫ iOS */
  color: #111827;

  border: 1px solid #e5e7eb;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.outline-btn:active {
  transform: scale(0.97);
  background: #e5e7eb;
}

    /* –ù–∏–∂–Ω–∏–π –±–∞—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∫–ª–∏–∫–∏ –ø–æ —ç–∫—Ä–∞–Ω—É */
.bottom-nav {
  pointer-events: none;
}

/* –ù–æ —Å–∞–º–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ */
.bottom-nav-inner,
.nav-btn {
  pointer-events: auto;
}

    .filters-actions-row {
  position: relative;
  z-index: 100;
}
    /* toast –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –æ–Ω hidden */
.toast {
  pointer-events: none;
}

    /* --- –†–Ø–î –ö–ù–û–ü–û–ö: OBUNA (big) + YOZISH (icon) + ‚Ä¶ (icon) --- */
.store-actions{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
  flex-wrap: nowrap;
}

.store-btn{
  height: 46px;
  border-radius: 999px;
  border: none;
  font-size: 14px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

/* –±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ */
.store-btn-primary{
  flex: 1;
  min-width: 0;
  padding: 0 16px;
  background: #5a4bff;
  color: #fff;
}

/* –º–∞–ª–µ–Ω—å–∫–∏–µ –∏–∫–æ–Ω–∫–∏ */
.store-btn-icon{
  width: 46px;
  padding: 0;
  background: #f3f4f6;
  color: #111827;
  font-size: 18px;
  font-weight: 700;
}

/* —á—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –Ω–µ –ª–æ–≤–∏–ª–∞ –∫–ª–∏–∫–∏ */
.store-btn-icon span,
.store-btn-primary span{
  pointer-events: none;
}

    /* ================== SHOPS UI ================== */
.shops-search-row{
  display:flex;
  gap:8px;
  align-items:stretch;
  margin-top:6px;
  margin-bottom:6px;
}
.shops-search{
  flex:1;
}
.shops-search-input{
  width:100%;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.6);
  font-size:14px;
  padding-left:32px;
  background:#ffffff
    url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 5a6 6 0 014.472 9.972l3.278 3.278a1 1 0 01-1.414 1.414l-3.278-3.278A6 6 0 1111 5zm0 2a4 4 0 100 8 4 4 0 000-8z' fill='%2394a3b8'/%3E%3C/svg%3E")
    no-repeat 10px center;
  background-size:16px;
}
.shops-filter-btn{
  width:44px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,0.6);
  background:#ffffff;
  color:#1d4ed8;
  cursor:pointer;
}

.top-shops-row{
  display:flex;
  gap:10px;
  overflow-x:auto;
  padding-bottom:4px;
}
.shop-mini{
  min-width:180px;
  background:#ffffff;
  border-radius:18px;
  padding:10px;
  box-shadow:0 3px 10px rgba(15,23,42,0.06);
  border:1px solid transparent;
  cursor:pointer;
}
.shop-mini:hover{ background:#eff6ff; border-color:rgba(37,99,235,0.25); }
.shop-mini-head{
  display:flex;
  gap:10px;
  align-items:center;
}
.shop-mini-avatar{
  width:46px;
  height:46px;
  border-radius:14px;
  background:linear-gradient(135deg,#eff6ff,#dbeafe);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:#1d4ed8;
}
.shop-mini-title{
  font-weight:700;
  font-size:14px;
}
.shop-mini-sub{
  font-size:12px;
  color:#64748b;
  margin-top:1px;
}
.shop-mini-badges{
  display:flex;
  gap:6px;
  margin-top:8px;
  flex-wrap:wrap;
}
.shop-badge{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  background:#f1f5f9;
  color:#0f172a;
}
.shop-badge.verified{ background:#dcfce7; color:#16a34a; }

.shops-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-bottom:10px;
}
.shop-card{
  display:flex;
  gap:10px;
  background:#ffffff;
  border-radius:18px;
  padding:10px;
  box-shadow:0 3px 10px rgba(15,23,42,0.06);
  cursor:pointer;
}
.shop-card-avatar{
  width:56px;
  height:56px;
  border-radius:16px;
  background:linear-gradient(135deg,#eff6ff,#dbeafe);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:#1d4ed8;
  flex-shrink:0;
}
.shop-card-main{ flex:1; min-width:0; }
.shop-card-title{
  font-size:14px;
  font-weight:700;
}
.shop-card-meta{
  font-size:12px;
  color:#64748b;
  margin-top:2px;
}
.shop-card-stats{
  display:flex;
  gap:10px;
  margin-top:6px;
  font-size:12px;
  color:#64748b;
}
.shop-stat{
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.shop-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
  justify-content:center;
}
.shop-open-btn{
  border:none;
  border-radius:999px;
  padding:9px 12px;
  font-size:13px;
  font-weight:700;
  background:#1d4ed8;
  color:#ffffff;
  cursor:pointer;
}
.shop-msg-btn{
  border:none;
  border-radius:999px;
  padding:9px 12px;
  font-size:13px;
  font-weight:700;
  background:#f3f4f6;
  color:#111827;
  cursor:pointer;
}

    /* ‚úÖ –ö–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç –ª—é–±–æ–π bottom-sheet ‚Äî –ø—Ä—è—á–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
body.sheet-open .bottom-nav {
  opacity: 0;
  pointer-events: none;
  transform: translateY(18px);
  transition: all 0.18s ease-out;
}

/* ‚úÖ Bottom-sheet –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é */
.store-sheet-backdrop {
  z-index: 3000 !important;
}
.store-sheet {
  z-index: 3001 !important;
}

/* ‚úÖ –ß—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —É–ø–∏—Ä–∞–ª—Å—è */
.store-sheet {
  padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px));
}

    /* ‚úÖ Bottom-sheet –≤—Å–µ–≥–¥–∞ –°–í–ï–†–•–£ –≤—Å–µ–≥–æ */
.store-sheet-backdrop { z-index: 99999 !important; }
.store-sheet         { z-index: 100000 !important; }

/* ‚úÖ 100% –≤—ã–∫–ª—é—á–∞–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç sheet */
body.sheet-open .bottom-nav {
  display: none !important;
}

    .shop-view-avatar{
  width: 100%;
  height: 100%;
  border-radius: 999px;
  background: linear-gradient(135deg,#eff6ff,#dbeafe);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:#1d4ed8;
  font-size: 30px;
}

    /* –∫–Ω–æ–ø–∫–∞ ‚ãØ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.shop-card{ position: relative; }
.shop-more-btn{
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 44px;
  height: 44px;
  border-radius: 16px;
  border: 0;
  background: rgba(0,0,0,.06);
  font-size: 22px;
  line-height: 1;
}

    /* ===== SHOPS ACTION SHEET (–∫–∞–∫ –≤ "–ú–æ–π –º–∞–≥–∞–∑–∏–Ω") ===== */
.store-sheet-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,.35);
  display: none;
  align-items: flex-end;
  justify-content: center;
  padding: 12px;
  z-index: 99999 !important;
}

.store-sheet-backdrop.active{ display:flex; }

.store-sheet{
  width: 100%;
  max-width: 480px;
  background: #fff;
  border-radius: 24px;
  padding: 10px 16px 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
}

.store-sheet-handle{
  width: 42px;
  height: 5px;
  border-radius: 999px;
  background: #e5e7eb;
  margin: 6px auto 12px;
}

.shop-sheet-title{
  font-size: 20px;
  font-weight: 900;
  color: #0f172a;
  margin-bottom: 10px;
}

.store-sheet-list{
  display:flex;
  flex-direction: column;
  gap: 10px;
}

.store-sheet-item{
  width: 100%;
  border: 0;
  background: #fff;
  border-radius: 18px;
  padding: 14px 12px;
  font-size: 16px;
  font-weight: 700;
  display:flex;
  align-items:center;
  gap: 12px;
  cursor:pointer;
  box-shadow: 0 2px 10px rgba(15,23,42,.06);
}

.store-sheet-item:active{
  transform: scale(0.99);
  background: #f8fafc;
}

.store-sheet-item.danger{
  color: #dc2626;
}

.store-sheet-icon{
  width: 38px;
  height: 38px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 16px;
  color:#fff;
}

.store-sheet-icon.share{ background:#2563eb; }
.store-sheet-icon.report{ background:#ef4444; }

/* –ü—Ä—è—á–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç sheet */
body.sheet-open .bottom-nav{ display:none !important; }

    /* ===== TOP SHOPS (Instagram-like) ===== */
#topShopsRow{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding:10px 2px 2px;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
}
#topShopsRow::-webkit-scrollbar{ display:none; }

.top-shop-ig{
  flex:0 0 235px;
  background:#fff;
  border-radius:18px;
  padding:12px 12px 14px;
  box-shadow:0 8px 20px rgba(15,23,42,.06);
  scroll-snap-align:start;
  position:relative;
}

.top-shop-ig-menu{
  position:absolute;
  top:10px;
  right:10px;
  width:34px;
  height:34px;
  border-radius:12px;
  border:0;
  background:#f1f5f9;
  color:#0f172a;
  font-size:20px;
  line-height:34px;
}

.top-shop-ig-center{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  padding-top:14px;
}

.top-shop-ig-avatar{
  width:86px;
  height:86px;
  border-radius:999px;
  background:#eef2ff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:26px;
  color:#1d4ed8;
  margin-bottom:10px;
}

.top-shop-ig-name{
  font-weight:900;
  font-size:17px;
  line-height:1.1;
  max-width:190px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.top-shop-ig-meta{
  margin-top:6px;
  font-size:13px;
  color:#64748b;
  line-height:1.2;
  max-width:200px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.top-shop-ig-meta2{
  margin-top:6px;
  font-size:13px;
  color:#94a3b8;
  max-width:200px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.top-shop-ig-btn{
  margin-top:12px;
  width:100%;
  border:0;
  border-radius:14px;
  padding:12px 12px;
  font-weight:900;
  font-size:15px;
  background:#2563eb;
  color:#fff;
}

.top-shop-ig-btn.subscribed{
  background:#e2e8f0;
  color:#0f172a;
}

    /* ===== Smart Header Hide/Show ===== */
.app-header{
  position: sticky;
  top: 0;
  z-index: 50;
  transition: transform .22s ease, box-shadow .22s ease;
  will-change: transform;
}

.app-header.header-hidden{
  transform: translateY(-110%);
  box-shadow: none;
}

#reportSheetBackdrop { pointer-events: auto; }
#reportSheetBackdrop .store-sheet { pointer-events: auto; }
#reportCancelBtn { pointer-events: auto; position: relative; z-index: 5; }

    /* Universal cancel button (iOS style) */
.store-sheet-cancel {
  width: 100%;
  margin-top: 12px;
  padding: 14px 16px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 14px;
  border: none;
  background: #f1f5f9;
  color: #0f172a;
  cursor: pointer;
}

.store-sheet-cancel:active {
  transform: scale(0.98);
  background: #e5e7eb;
}

    /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤ 1 —Å—Ç—Ä–æ–∫—É */
#shopsCategoryRow{
  display: flex;
  flex-wrap: nowrap;          /* ‚úÖ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */
  gap: 10px;
  overflow-x: auto;           /* ‚úÖ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
  overflow-y: hidden;
  white-space: nowrap;
  padding: 6px 2px 10px;
  -webkit-overflow-scrolling: touch;  /* iOS –ø–ª–∞–≤–Ω–æ */
  scrollbar-width: none;      /* Firefox —Å–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
}

#shopsCategoryRow::-webkit-scrollbar{
  display: none;              /* Chrome/Safari —Å–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
}

/* –ß—Ç–æ–±—ã –∫–∞–∂–¥–∞—è chip –Ω–µ —Å–∂–∏–º–∞–ª–∞—Å—å */
#shopsCategoryRow .chip{
  flex: 0 0 auto;
}

    .shop-subscribe-btn{
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  transition: transform .12s ease, filter .12s ease, opacity .12s ease;
}

.shop-subscribe-btn:active{
  transform: scale(0.98);
  filter: brightness(0.98);
}

.shop-subscribe-btn.pulse{
  animation: subPulse 260ms ease-out;
}

@keyframes subPulse{
  0%   { transform: scale(1); }
  50%  { transform: scale(1.03); }
  100% { transform: scale(1); }
}

    /* –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –º–∞–≥–∞–∑–∏–Ω–∞ */
.shop-subscribe-btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;

  min-height: 44px;        /* iOS —Å—Ç–∞–Ω–¥–∞—Ä—Ç */
  padding: 0 18px;

  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;

  background: #eef2ff;    /* —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
  color: #4f46e5;

  border: none;
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;

  transition:
    transform .12s ease,
    box-shadow .12s ease,
    background .12s ease,
    color .12s ease;
}

/* –ê–∫—Ç–∏–≤–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ */
.shop-subscribe-btn:active{
  transform: scale(0.96);
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω */
.shop-subscribe-btn.subscribed{
  background: #4f46e5;
  color: #fff;
}

/* –ü—É–ª—å—Å –ø—Ä–∏ –∫–ª–∏–∫–µ */
.shop-subscribe-btn.pulse{
  animation: subPulse 260ms ease-out;
}

@keyframes subPulse{
  0%   { transform: scale(1); }
  50%  { transform: scale(1.05); }
  100% { transform: scale(1); }
}

    /* –†—è–¥ –∫–Ω–æ–ø–æ–∫ */
.shop-actions-row {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
}

/* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
.shop-subscribe-btn {
  flex: 1; /* üî• –∑–∞–Ω–∏–º–∞–µ—Ç –í–°–Å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
  height: 48px;

  display: flex;
  align-items: center;
  justify-content: center;

  background: #4f46e5;
  color: #fff;
  font-weight: 600;
  font-size: 15px;

  border: none;
  border-radius: 14px;
  cursor: pointer;

  transition: transform 0.15s ease, background 0.15s ease;
}

.shop-subscribe-btn:active {
  transform: scale(0.97);
}

/* –ö–Ω–æ–ø–∫–∞ ‚ãØ */
.shop-more-btn {
  width: 48px;
  height: 48px;

  border-radius: 50%;
  border: none;

  background: #f1f5f9;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;

  transition: background 0.15s ease;
}

.shop-more-btn:active {
  background: #e2e8f0;
}

/* =========================
   TOP SHOPS ‚Äì SUBSCRIBE BTN (FIX COLOR)
   ========================= */

.top-shop-ig-btn {
  width: 100%;
  height: 44px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;

  background: #4f46e5;   /* –í–°–ï–ì–î–ê —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
  color: #ffffff;

  border: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∞–Ω–∏–º–∞—Ü–∏—è */
.top-shop-ig-btn:active {
  transform: scale(0.97);
}

/* —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ø–æ–¥–ø–∏—Å–∞–Ω" ‚Äî –ë–ï–ó —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–∞ */
.top-shop-ig-btn.subscribed {
  background: #4f46e5;   /* —Ç–æ—Ç –∂–µ —Ü–≤–µ—Ç */
  color: #ffffff;
}

/* –∏–∫–æ–Ω–∫–∞ */
.top-shop-ig-btn::before {
  content: "üîî";
  font-size: 14px;
}

    /* –ø–æ–¥–ø–∏—Å–∫–∞ ‚Äî –æ–±—â–∏–π —Å—Ç–∏–ª—å */
.shop-subscribe-btn,
.top-shop-ig-btn,
.store-btn.store-btn-primary{
  background:#4f46e5;
  color:#fff;
  border:none;
}

/* —Å–æ—Å—Ç–æ—è–Ω–∏–µ subscribed ‚Äî —Ç–æ—Ç –∂–µ —Ü–≤–µ—Ç */
.shop-subscribe-btn.subscribed,
.top-shop-ig-btn.subscribed,
.store-btn.store-btn-primary.subscribed{
  background:#4f46e5;
  color:#fff;
}

/* –∞–Ω–∏–º–∞—Ü–∏—è */
.pulse{
  animation:pulseAnim .22s ease-out;
}
@keyframes pulseAnim{
  0%{ transform:scale(1); }
  50%{ transform:scale(0.97); }
  100%{ transform:scale(1); }
}

    /* ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –∫–Ω–æ–ø–∫–∏ "Obuna bo‚Äòlish" –≤–µ–∑–¥–µ (–ø–æ–ª—É-–∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è) */
#storeSubscribeBtn,
#shopViewSubBtn,
.top-shop-ig-btn {
  border-radius: 14px !important; /* –±—ã–ª–æ 999px / pill */
}

/* –ï—Å–ª–∏ –≤ "Mening do‚Äòkonim" –∫–Ω–æ–ø–∫–∞ —Ç—è–Ω–µ—Ç—Å—è –∫–∞–∫ –∫–∞–ø—Å—É–ª–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É/—Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ */
#storeSubscribeBtn {
  height: 44px;           /* –º–æ–∂–Ω–æ 42‚Äì46 –ø–æ –≤–∫—É—Å—É */
  padding: 0 16px;
}

    /* ===== Ellipsis (‚ãØ) button ===== */
.more-btn,
.ad-more-btn,
.shop-more-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: #f1f5f9; /* –º—è–≥–∫–∏–π —Å–µ—Ä–æ-–±–µ–ª—ã–π */
  color: #475569;      /* —Å–ø–æ–∫–æ–π–Ω—ã–π —Å–µ—Ä—ã–π */
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;

  transition: 
    background 0.15s ease,
    transform 0.1s ease,
    box-shadow 0.15s ease;

  box-shadow:
    0 1px 2px rgba(0,0,0,0.08);
}

/* hover (desktop / web) */
.more-btn:hover,
.ad-more-btn:hover,
.shop-more-btn:hover {
  background: #e5e7eb;
}

/* active (tap on mobile) */
  .more-btn:active,
.ad-more-btn:active,
.shop-more-btn:active {
  transform: scale(0.92);
  background: #ede9fe;
  color: #7c3aed;
}  

/* —É–±—Ä–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π iOS highlight */
.more-btn,
.ad-more-btn,
.shop-more-btn {
  -webkit-tap-highlight-color: transparent;
}

    #adMoreBtn:active {
  background: #ede9fe;
  color: #7c3aed;
}

.icon-circle-btn:active {
  background: #ede9fe;
  color: #7c3aed;
}

    /* ===== iOS-style circle icon button (‚ãØ) ===== */
.icon-circle-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;

  background: #f1f5f9;
  color: #475569;

  font-size: 22px;
  font-weight: 700;
  line-height: 1;

  display: flex;
  align-items: center;
  justify-content: center;

  box-shadow: 0 1px 2px rgba(0,0,0,0.08);

  transition:
    background 0.15s ease,
    transform 0.12s ease,
    box-shadow 0.15s ease;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

/* hover (desktop) */
.icon-circle-btn:hover {
  background: #e5e7eb;
}

/* pressed (REAL iOS tap) */
.icon-circle-btn.is-pressed {
  background: #ede9fe;   /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π Zalvo */
  color: #7c3aed;
  transform: scale(0.92);
  box-shadow: 0 0 0 rgba(0,0,0,0);
}

    .ad-view-seller-card {
  position: relative;
  z-index: 5;
  cursor: pointer;
}

    .shop-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  background:#f1f5f9;
  color:#334155;
  font-weight:700;
  font-size:12px;
  margin-top:6px;
}
.shop-badge.is-user{
  background:#ecfeff;
  color:#0e7490;
}
.shop-badge.is-shop{
  background:#ede9fe;
  color:#6d28d9;
}

/* —Å–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
.shopview-hide-for-user{
  display:none !important;
}

    .category-card {
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.category-card:active {
  transform: scale(0.97);
}

    .category-card {
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.category-card.active {
  border-color: rgba(124, 58, 237, 0.55);
  background: #f5f3ff;
  box-shadow: 0 8px 22px rgba(124, 58, 237, 0.18);
  transform: translateY(-1px);
}

.category-card.active .category-card-title {
  color: #7c3aed;
  font-weight: 800;
}

    /* Center "+" button in bottom nav */
.nav-add-btn{
  width: 48px;              /* –±—ã–ª–æ 56 */
  height: 48px;
  border-radius: 50%;
  border: none;
  font-size: 26px;          /* –±—ã–ª–æ 34 */
  font-weight: 800;
  line-height: 48px;
  text-align: center;
  cursor: pointer;

  background: #2563eb;
  color: #fff;

  position: relative;
  top: -14px;               /* –±—ã–ª–æ -18 ‚Üí –º—è–≥—á–µ */
  box-shadow: 0 6px 14px rgba(37,99,235,.28);
  -webkit-tap-highlight-color: transparent;
}

.nav-add-btn:active{
  transform: scale(.95);
}

    .big-search-btn{
  width: 100%;
  border: none;
  border-radius: 14px;
  padding: 10px 14px;        /* –±—ã–ª–æ 16px ‚Üí –¥–µ–ª–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ */
  font-size: 18px;           /* –±—ã–ª–æ 28px ‚Üí –∫–∞–∫ —Ä–∞–Ω—å—à–µ */
  font-weight: 600;          /* —Å–ø–æ–∫–æ–π–Ω–µ–µ */
  background: #1d4ed8;
  color: #fff;
  box-shadow: 0 6px 12px rgba(29,78,216,.18);
  -webkit-tap-highlight-color: transparent;
}

.big-search-btn:active{
  transform: scale(.98);
}

    /* ===== PLUS BUTTON POP ANIMATION ===== */
.nav-add-btn{
  transform-origin: 50% 80%;
  animation: navAddPop .45s cubic-bezier(.2,.9,.2,1) both;
}

@keyframes navAddPop{
  0%   { transform: translateY(8px) scale(.72); opacity: 0; }
  60%  { transform: translateY(-2px) scale(1.05); opacity: 1; }
  100% { transform: translateY(0) scale(1); opacity: 1; }
}

    /* ===== HIDE BOTTOM NAV ON NEW AD SCREENS ===== */
.bottom-nav.nav-hidden{
  transform: translateY(120%);
  opacity: 0;
  pointer-events: none;
  transition: transform .22s ease, opacity .22s ease;
}

    /* –ë–∞–Ω–Ω–µ—Ä –≤—Å–µ–≥–¥–∞ —Ä–æ–≤–Ω–æ –ø–æ —à–∏—Ä–∏–Ω–µ –±–ª–æ–∫–∞ */
.promo-banner{
  width: 100%;
  overflow: hidden;
  border-radius: 16px;   /* –µ—Å–ª–∏ —É —Ç–µ–±—è –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
}

/* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏ –Ω–µ —Å—ä–µ–∑–∂–∞–µ—Ç */
.promo-banner img{
  width: 100%;
  height: auto;
  display: block;
}

    .unblock-btn{
  border: 1px solid #e5e7eb;
  background:#fff;
  border-radius: 12px;
  padding: 8px 12px;
  font-weight: 700;
  color:#111827;
  cursor:pointer;
}
.unblock-btn:active{
  background:#ede9fe;
  border-color:#c4b5fd;
  color:#7c3aed;
}

.blocked-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:10px 0;
}
.blocked-row .left{
  flex:1;
  min-width:0;
}
.blocked-row .meta{
  font-size:13px;
  opacity:.75;
  margin-top:2px;
}

    .settings-sub{
  font-size: 13px;
  opacity: .65;
  margin-top: 4px;
}

/* –ø—Ä–æ—Å—Ç–∞—è ‚Äúsheet‚Äù –∫–∞–∫ —É —Ç–µ–±—è, –Ω–æ –µ—Å–ª–∏ –∫–ª–∞—Å—Å—ã —É–∂–µ –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å */
.sheet-backdrop{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 999;
}
.sheet{
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: 18px;
  width: min(520px, calc(100% - 24px));
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(18px);
  border-radius: 18px;
  padding: 14px;
  z-index: 1000;
  box-shadow: 0 18px 50px rgba(15,23,42,.25);
}
.sheet-handle{
  width: 48px; height: 5px;
  border-radius: 99px;
  background: rgba(0,0,0,.15);
  margin: 0 auto 10px;
}
.sheet-title{
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 10px;
  text-align: center;
}
.sheet-body{
  padding: 6px 4px 12px;
}
.sheet-actions{
  display: flex;
  gap: 10px;
}
.btn-secondary, .btn-primary{
  flex: 1;
  height: 44px;
  border-radius: 14px;
  border: none;
  font-weight: 700;
}
.btn-secondary{ background: rgba(15,23,42,.08); }
.btn-primary{ background: #2563eb; color: #fff; }

.hidden{ display:none !important; }

.profile-input{
  width: 100%;
  height: 46px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.12);
  padding: 0 14px;
  font-size: 15px;
  outline: none;
  background: rgba(255,255,255,.9);
}
.profile-help{
  margin-top: 8px;
  font-size: 12px;
  opacity: .65;
  line-height: 1.35;
}
.profile-row{
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  align-items: center;
}
.profile-mini-btn{
  height: 46px;
  padding: 0 14px;
  border-radius: 14px;
  border: none;
  background: rgba(15,23,42,.08);
  font-weight: 700;
}
    /* —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç sheet */
body.sheet-open .bottom-nav {
  transform: translateY(120%);
  transition: transform 0.25s ease;
}

/* –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ */
.bottom-nav {
  transition: transform 0.25s ease;
}

    /* 100% –ø—Ä—è—á–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç –ª—é–±–æ–π sheet */
body.sheet-open .bottom-nav{
  transform: translateY(200%) !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

/* –ø–ª–∞–≤–Ω–æ—Å—Ç—å */
.bottom-nav{
  transition: transform .25s ease, opacity .2s ease !important;
}

    /* ================== CHAT UI ================== */
.chat-wrap{ width:100%; }

.chat-view{ display:none; }
.chat-view.active{ display:block; }

.chat-topbar{
  display:flex; align-items:center; justify-content:space-between;
  padding: 12px 14px;
}
.chat-topbar-title{ font-weight:900; font-size:18px; }
.chat-topbar-btn{
  border:none; background:#eaf1ff; font-weight:900;
  border-radius:12px; padding:8px 10px;
}

.chat-search{ padding: 0 14px 10px; }
.chat-search input{
  width:100%; border:none; outline:none;
  background:#f1f4ff; padding:12px 12px; border-radius:14px;
  font-weight:700;
}

.chat-threads{ padding: 0 10px 16px; display:flex; flex-direction:column; gap:10px; }
.chat-thread{
  display:flex; gap:12px; align-items:center;
  padding: 12px 12px;
  background: rgba(255,255,255,0.75);
  border-radius: 18px;
  box-shadow: 0 10px 25px rgba(2,6,23,0.06);
}
.chat-thread-avatar{
  width:46px; height:46px; border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  background:#eaf1ff; font-weight:900;
}
.chat-thread-main{ flex:1; min-width:0; }
.chat-thread-title{ font-weight:900; }
.chat-thread-last{ opacity:.7; font-weight:700; font-size:13px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; margin-top:3px; }
.chat-thread-meta{
  display:flex; flex-direction:column; align-items:flex-end; gap:6px;
  min-width:70px;
}
.chat-thread-time{ opacity:.6; font-size:12px; font-weight:800; }
.chat-thread-badge{
  background:#2563eb; color:white; font-weight:900; font-size:12px;
  padding:4px 8px; border-radius:999px;
}
.chat-thread-pin{ opacity:.7; font-size:12px; font-weight:900; }

.chat-empty{
  padding: 26px 16px;
  text-align:center;
  opacity:.7;
  font-weight:800;
}

/* ROOM */
.chat-room-topbar{
  display:flex; align-items:center; gap:10px;
  padding: 10px 12px;
}
.chat-room-back{
  border:none; background:#eaf1ff;
  width:40px; height:36px; border-radius:12px; font-size:22px; font-weight:900;
}
.chat-room-more{
  border:none; background:#eaf1ff;
  width:44px; height:36px; border-radius:12px; font-size:22px; font-weight:900;
}
.chat-room-peer{ flex:1; display:flex; align-items:center; gap:10px; min-width:0; }
.chat-room-avatar{
  width:42px; height:42px; border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  background:#eaf1ff; font-weight:900;
}
.chat-room-peerinfo{ min-width:0; }
.chat-room-title{ font-weight:900; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.chat-room-status{ font-size:12px; font-weight:800; opacity:.65; margin-top:2px; }

.chat-messages{
  padding: 10px 12px;        /* ‚úÖ —É–±–∏—Ä–∞–µ–º 90px, –æ–Ω –∏ —Å–æ–∑–¥–∞—ë—Ç –ª–∏—à–Ω–∏–π –Ω–∏–∑ */
  display:flex;
  flex-direction:column;
  gap:10px;
}
    
.chat-bubble{
  max-width: 78%;
  padding: 10px 12px;
  border-radius: 16px;
  font-weight:700;
  position:relative;
  line-height:1.25;
  word-wrap:break-word;
}
.chat-bubble.me{
  align-self:flex-end;
  background:#2563eb;
  color:white;
  border-bottom-right-radius: 6px;
}
.chat-bubble.other{
  align-self:flex-start;
  background: rgba(255,255,255,0.85);
  border-bottom-left-radius: 6px;
  box-shadow: 0 10px 25px rgba(2,6,23,0.05);
}
.chat-bubble-meta{
  margin-top:6px;
  font-size:11px;
  font-weight:900;
  opacity:.75;
  display:flex;
  gap:6px;
  align-items:center;
  justify-content:flex-end;
}
.chat-bubble.other .chat-bubble-meta{ justify-content:flex-start; }

.chat-image{
  width:100%;
  border-radius: 12px;
  margin-top: 6px;
  display:block;
}

.chat-typing{
  padding: 0 14px 8px;
  font-weight:800;
  opacity:.65;
  font-size:12px;
}

.chat-attach, .chat-send{
  border:none; background:#eaf1ff;
  width:44px; height:44px; border-radius:14px;
  font-size:18px; font-weight:900;
}
.chat-input{
  flex:1;
  border:none; outline:none;
  background:white;
  padding: 12px 12px;
  border-radius: 14px;
  font-weight:800;
}

/* –ö–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç chatRoomSheetBackdrop (–∫–∞–∫ –∏ –¥—Ä—É–≥–∏–µ sheet), –º–æ–∂–Ω–æ –ø—Ä—è—Ç–∞—Ç—å –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
body.sheet-open .bottom-nav{ display:none !important; }

/* ===== CHAT ROOM: TRUE FULLSCREEN (FLEX, NO GAPS) ===== */

body.chat-room-open{
  overflow: hidden;
}

/* –ø—Ä—è—á–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –∏ –≤–µ—Ä—Ö–Ω—é—é —à–∞–ø–∫—É —Å–∞–π—Ç–∞ */
body.chat-room-open .bottom-nav{ display:none !important; }
body.chat-room-open .app-header{ display:none !important; }

/* —ç–∫—Ä–∞–Ω —á–∞—Ç–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
body.chat-room-open #screen-chat{
  position: fixed !important;
  inset: 0 !important;
  z-index: 9999 !important;
  padding: 0 !important;
  margin: 0 !important;
  background: #f1f4ff !important;
  height: calc(var(--vvh, 1vh) * 100) !important;
  overflow: hidden !important;
}

/* chatRoomView = flex-–∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
body.chat-room-open #chatRoomView.chat-view.active{
  display: flex !important;
  flex-direction: column !important;

  /* iOS FIX: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É, –∫–æ—Ç–æ—Ä—É—é —Ç—ã —Å—Ç–∞–≤–∏—à—å —á–µ—Ä–µ–∑ JS (--vvh) */
  height: var(--vvh, 100vh) !important;
  min-height: var(--vvh, 100vh) !important;

  padding-top: env(safe-area-inset-top) !important;
  padding-bottom: 0 !important;
}

/* –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
body.chat-room-open .chat-room-topbar{
  flex: 0 0 auto !important;
  background: rgba(241,244,255,0.95) !important;
  backdrop-filter: blur(12px);
}

/* —Å–æ–æ–±—â–µ–Ω–∏—è: –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—ë –º–µ—Å—Ç–æ –∏ —Å–∫—Ä–æ–ª–ª—è—Ç—Å—è */
body.chat-room-open #chatMessages{
  flex: 1 1 auto !important;
  min-height: 0 !important;            /* ‚úÖ –∫–ª—é—á –¥–ª—è iOS */
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
  padding: 10px 12px !important;
  margin: 0 !important;
  padding-bottom: calc(var(--composer-h, 90px) + 10px) !important;
}

/* composer-wrap: —à–∏—Ä–µ, –Ω–∏–∂–µ, –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É (–±–µ–∑ fixed) */
body.chat-room-open #chatComposerWrap{
  position: fixed !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  z-index: 10000 !important;

  background: rgba(241,244,255,0.95) !important;
  backdrop-filter: blur(12px);

  padding: 12px 8px calc(14px + env(safe-area-inset-bottom)) !important;
  margin: 0 !important;

  border-top-left-radius: 18px;
  border-top-right-radius: 18px;

  /* –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è JS –ø—Ä–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ */
  transform: translateY(var(--kbd-shift, 0px)) !important;
  will-change: transform;
}
    
/* composer –≤–Ω—É—Ç—Ä–∏: –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ, —á—Ç–æ–±—ã input —Å—Ç–∞–ª —à–∏—Ä–µ */
body.chat-room-open .chat-composer{
  padding: 0 !important;
  display: flex !important;
  gap: 8px !important;
  align-items: center !important;
  background: transparent !important;
}

/* –∫–Ω–æ–ø–∫–∏ —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã input —Å—Ç–∞–ª –¥–ª–∏–Ω–Ω–µ–µ */
body.chat-room-open .chat-attach,
body.chat-room-open .chat-send{
  width: 40px !important;
  height: 40px !important;
  border-radius: 12px !important;
  flex: 0 0 auto !important;
}

/* input –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–∏—Ä–æ–∫–∏–π */
body.chat-room-open .chat-input{
  flex: 1 1 auto !important;
  width: auto !important;
  padding: 12px 14px !important;
  border-radius: 16px !important;
}

    /* ================== iOS TYPOGRAPHY (CHAT OVERRIDE) ================== */

/* –æ–±—â–∏–π iOS-—à—Ä–∏—Ñ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–∞ */
#screen-chat, #screen-chat *{
  font-family: -apple-system, BlinkMacSystemFont,
               "SF Pro Text","SF Pro Display",
               system-ui, sans-serif !important;
}

/* —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
.chat-topbar-title{
  font-weight: 700 !important;
  font-size: 20px !important;
}

.chat-thread-title{
  font-weight: 700 !important;
  font-size: 16px !important;
}

.chat-thread-last{
  font-weight: 400 !important;
  font-size: 14px !important;
  opacity: .65 !important;
}

.chat-thread-time{
  font-weight: 400 !important;
  font-size: 12px !important;
  opacity: .55 !important;
}

.chat-thread-avatar{
  font-weight: 700 !important;
}

/* ROOM topbar */
.chat-room-title{
  font-weight: 700 !important;
  font-size: 17px !important;   /* –∫–∞–∫ iOS header */
}

.chat-room-status{
  font-weight: 400 !important;
  font-size: 13px !important;
  opacity: .55 !important;
}

/* –ø—É–∑—ã—Ä—å–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
.chat-bubble{
  font-weight: 400 !important;
  font-size: 16px !important;   /* iMessage —Ä–∞–∑–º–µ—Ä */
  line-height: 1.35 !important;
}

.chat-bubble-meta{
  font-weight: 400 !important;
  font-size: 12px !important;
  opacity: .55 !important;
}

/* –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
.chat-input{
  font-weight: 400 !important;
  font-size: 16px !important;
}

.chat-search input{
  font-weight: 400 !important;
  font-size: 16px !important;
}

    /* ===== Chat Ad Card ===== */
.chat-adcard{
  padding: 8px 12px 6px;
}

.chat-adcard-inner{
  display:flex;
  align-items:center;
  gap:10px;
  background: rgba(255,255,255,0.85);
  border-radius: 16px;
  padding: 10px 10px;
  box-shadow: 0 10px 25px rgba(2,6,23,0.06);
}

.chat-adcard-img{
  width:52px;
  height:52px;
  border-radius: 14px;
  background:#eaf1ff;
  flex:0 0 auto;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:#1d4ed8;
}

.chat-adcard-img img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.chat-adcard-info{ flex:1; min-width:0; }
.chat-adcard-title{
  font-weight:800;
  font-size:15px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.chat-adcard-sub{
  margin-top:4px;
  font-size:12px;
  font-weight:600;
  opacity:.7;
  display:flex;
  gap:8px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.chat-adcard-open{
  border:none;
  background:#2563eb;
  color:#fff;
  font-weight:800;
  padding:10px 12px;
  border-radius: 14px;
  flex:0 0 auto;
}

    .chat-ad-img{
  width: 44px;
  height: 44px;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #eaf1ff;
  font-weight: 700;
}

.chat-ad-img img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

    .chat-thread-avatar{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  overflow: hidden;
  background: #eaf1ff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}

.chat-thread-avatar img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.chat-thread-avatar span{
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
    
  @media (max-width: 480px) {
    body {
      align-items: stretch;
    }
    .app {
      border-radius: 0;
      box-shadow: none;
    }
  }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-left">
        <img src="zalvo-logo.png" alt="MarketHub" class="app-logo-small" />
        <div>
          <div class="app-title">Zalvo</div>
          <div class="app-subtitle">Uzbekiston ¬∑ elonlari</div>
        </div>
      </div>
    </header>

    <!-- SCREENS -->
    <main class="screens">

      <!-- ================= HOME SCREEN ================= -->
      <section id="screen-home" class="screen active">
        <div class="search-bar-row">
          <div class="search-bar">
            <input
              type="text"
              placeholder="Nima qidiryapsiz?"
              class="search-input"
            />
          </div>
          <button id="openFiltersBtn" class="filters-btn">‚öôÔ∏è Filtr</button>
        </div>

        <button id="btnSearchFake" class="big-search-btn" type="button">Qidirish</button>

        <div id="promoBanner" class="promo-banner">
  <img src="Zalvo-banner.png" alt="Zalvo ‚Äî biznesingiz uchun yangi mijozlar" 
    alt="MarketHub promo"
  />
</div>

        <div class="section-title">Mashhur bo‚Äòlimlar</div>
        <div id="homeCategoryGrid" class="category-grid">
  <div class="category-card" data-category="Transport">
    <div class="category-card-title">Transport</div>
    <div class="category-card-sub">Mashinalar, mopedlar</div>
  </div>

  <div class="category-card" data-category="Ko‚Äòchmas mulk">
    <div class="category-card-title">Ko'chmas mulk</div>
    <div class="category-card-sub">Ijaraga, sotiladi</div>
  </div>

  <div class="category-card" data-category="Elektronika">
    <div class="category-card-title">Elektronika</div>
    <div class="category-card-sub">Telefon, laptop</div>
  </div>

  <div class="category-card" data-category="Xizmatlar">
    <div class="category-card-title">Xizmatlar</div>
    <div class="category-card-sub">Usta, servis</div>
  </div>
</div>

        <div class="hint" style="margin-bottom:10px;">
          üìå Kategoriyani yana bir marta bosing ‚Äî barcha e‚Äôlonlar qaytadi
        </div>

        <div id="feedList" class="ad-list grid-mode"></div>
      </section>

      <!-- ================= FAVORITES ================= -->
      <section id="screen-favorites" class="screen">
        <div class="screen-title">Sevimlilar</div>
        <div id="favoritesList" class="ad-list"></div>
      </section>

      <section id="screen-my-ads" class="screen">
  <div class="screen-title">Mening e‚Äôlonlarim</div>
  <div id="myAdsList" class="ad-list"></div>
</section>

      <!-- ================= FILTERS SCREEN ================= -->
      <section id="screen-filters" class="screen">
        <div class="screen-title">Filtrlar</div>

        <div class="filters-section-title">Turi</div>
        <div class="filters-section-title">Kategoriya</div>
<div id="filterCategoryRow" class="chip-row">
  <div class="chip chip-filled" data-category="all">Hammasi</div>
  <div class="chip" data-category="Transport">Transport</div>
  <div class="chip" data-category="Ko‚Äòchmas mulk">Ko‚Äòchmas mulk</div>
  <div class="chip" data-category="Elektronika">Elektronika</div>
  <div class="chip" data-category="Xizmatlar">Xizmatlar</div>
  <div class="chip" data-category="Ish">Ish</div>
  <div class="chip" data-category="Uy-rozg‚Äòor">Uy-rozg‚Äòor</div>
  <div class="chip" data-category="Bolalar">Bolalar</div>
  <div class="chip" data-category="Hayvonlar">Hayvonlar</div>
  <div class="chip" data-category="Hobbi/Sport">Hobbi/Sport</div>
  <div class="chip" data-category="Boshqa">Boshqa</div>
</div>

        <div class="filters-section-title">Viloyat</div>

<select id="filterCity" class="form-select">
  <option value="all">Hammasi</option>

  <option value="Toshkent shahri">Toshkent shahri</option>
  <option value="Toshkent viloyati">Toshkent viloyati</option>
  <option value="Andijon">Andijon</option>
  <option value="Buxoro">Buxoro</option>
  <option value="Farg‚Äòona">Farg‚Äòona</option>
  <option value="Jizzax">Jizzax</option>
  <option value="Xorazm">Xorazm</option>
  <option value="Namangan">Namangan</option>
  <option value="Navoiy">Navoiy</option>
  <option value="Qashqadaryo">Qashqadaryo</option>
  <option value="Samarqand">Samarqand</option>
  <option value="Sirdaryo">Sirdaryo</option>
  <option value="Surxondaryo">Surxondaryo</option>
  <option value="Qoraqalpog‚Äòiston">Qoraqalpog‚Äòiston</option>
</select>

        <div class="filters-section-title">Valyuta</div>
        <div id="filterCurrencyRow" class="chip-row">
          <div class="chip" data-currency="sum">So‚Äòm</div>
          <div class="chip" data-currency="usd">USD</div>
        </div>

        <div class="filters-section-title">Qo‚Äòshimcha</div>
        <div id="filterPhotoChip" class="chip">Faqat rasmlar bilan</div>

        <div class="filters-section-title">Saralash</div>
        <select id="filterSort" class="form-select">
          <option value="default">Standart</option>
          <option value="date">Yangi e‚Äôlonlar</option>
          <option value="cheap">Arzon</option>
          <option value="expensive">Qimmat</option>
        </select>

        <div class="filters-actions-row">
          <button id="filtersApplyBtn" class="primary-btn">Natijalarni ko‚Äòrsatish</button>
          <button id="filtersResetBtn" class="outline-btn">Tozalash</button>
          <button id="filtersBack" class="outline-btn">Orqaga</button>
        </div>
      </section>

      <!-- ================= AD DETAILS ================= -->
      <section id="screen-ad-details" class="screen">
        <div class="ad-view-header">
        </div>

        <div class="ad-view-card">
          <div id="detailMainImage"></div>
          <div id="detailThumbs" class="detail-thumbs"></div>

          <div class="ad-view-title-row">
            <div class="ad-view-title-box">
              <div id="detailTitle" class="ad-view-main-title"></div>
              <div id="detailPrice" class="ad-view-price"></div>
              <div id="detailMeta" class="ad-view-meta"></div>
            </div>
            <div class="ad-view-icon-row">
  <button id="adMoreBtn" class="icon-circle-btn" type="button">‚Ä¶</button>
</div>
          </div>

          <div class="ad-view-description-title">Tavsif</div>
          <div id="detailDescription" class="ad-view-description"></div>

          <div id="sellerCard" class="ad-view-seller-card">
            <div>
              <div class="ad-view-seller-info-main">Baxir B-R (@Baxir1987)</div>
              <div class="ad-view-seller-info-sub">‚≠ê 4.9 ¬∑ 23 sharh ¬∑ 12 e‚Äôlon</div>
              <div class="ad-view-seller-status">üü¢ Oxirgi marta: yaqinda</div>
            </div>
          </div>

          <div class="ad-view-actions-row">
            <a id="callSellerBtn" href="#" class="call-btn">üìû Qo‚Äòng‚Äòiroq</a>
            <a id="msgSellerBtn" href="#" class="msg-btn">‚úâÔ∏è Yozish</a>
          </div>

          <div class="similar-section">
            <div class="similar-title">O‚Äòxshash e‚Äôlonlar</div>
            <div id="similarList" class="similar-list"></div>
          </div>
        </div>
      </section>

      <!-- ================= PROFILE / SETTINGS (Telegram style) ================= -->
<section id="screen-profile" class="screen">
  <!-- –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
  <div class="settings-profile-header">
  <div id="profileAvatar" class="settings-avatar-big">B</div>
    <div class="settings-name">Baxir B-R</div>
    <div class="settings-username">
      <a href="tel:+16195479977" class="settings-link">+1 619 547 9977</a>
      ¬∑
      <span class="settings-link">@Baxir1987</span>
    </div>
  </div>

  <input
  id="profilePhotoInput"
  type="file"
  accept="image/*"
  class="hidden-input"
/>
  
  <!-- 1. Rasmini o‚Äòzgartirish -->
  <div class="settings-card">
    <button id="settingsChangePhoto" class="settings-row">
      <div class="settings-icon">üì∑</div>
      <div class="settings-title">Rasmini o‚Äòzgartirish</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>
  </div>

  <!-- 2. Profil / Dokon / E'lonlar / Sevimlilar / Tarix -->
  <div class="settings-card">
    <button id="settingsProfileRow" class="settings-row">
      <div class="settings-icon">üë§</div>
      <div class="settings-title">Profilim</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsMyShopRow" class="settings-row">
      <div class="settings-icon">üè¨</div>
      <div class="settings-title">Mening do‚Äòkonim</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsMyAdsRow" class="settings-row">
      <div class="settings-icon">üìã</div>
      <div class="settings-title">Mening e‚Äôlonlarim</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsFavoritesRow" class="settings-row">
      <div class="settings-icon">‚≠ê</div>
      <div class="settings-title">Izbranlar</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsBlocksRow" class="settings-row">
  <div class="settings-icon">üö´</div>
  <div class="settings-title">Bloklar</div>
  <div class="settings-arrow">‚Ä∫</div>
</button>

    <button id="settingsHistoryRow" class="settings-row">
      <div class="settings-icon">üïí</div>
      <div class="settings-title">Ko‚Äòrish tarixi</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>
  </div>

  <!-- 3. Til / Pullik / Admin / Biznes -->
  <div class="settings-card">
    <button id="settingsLangRow" class="settings-row">
      <div class="settings-icon">üåê</div>
      <div class="settings-title">Tilni tanlash (uz/ru)</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsPaidRow" class="settings-row">
      <div class="settings-icon">üíé</div>
      <div class="settings-title">Pullik xizmatlar</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsAdminRow" class="settings-row">
      <div class="settings-icon">üõ†</div>
      <div class="settings-title">Admin paneli</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsBusinessRow" class="settings-row">
      <div class="settings-icon">üìä</div>
      <div class="settings-title">Zalvo biznes uchun</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>
  </div>

  <!-- 4. Yordam / Savollar -->
  <div class="settings-card">
    <button id="settingsHelpRow" class="settings-row">
      <div class="settings-icon">‚ùì</div>
      <div class="settings-title">Yordam</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button id="settingsQuestionsRow" class="settings-row">
      <div class="settings-icon">üí¨</div>
      <div class="settings-title">Zalvo haqida savollar</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>
  </div>
</section>

            <!-- ================= MY SHOP (MENING DO‚ÄòKONIM) ================= -->
      <section id="screen-my-shop" class="screen">
        <div class="store-page">
          
          <!-- –û–ë–õ–û–ñ–ö–ê + –ê–í–ê–¢–ê–† -->
          <div class="store-cover">
            <!-- –ó–ê–ú–ï–ù–ò –ø—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ –ø–æ–¥ —Å–µ–±—è -->
            <img src="iphone14-pro.jpg" alt="Telefonlar">
            <div class="store-avatar">
              <!-- —Å—é–¥–∞ —Å—Ç–∞–≤–∏—à—å –ª–æ–≥–æ—Ç–∏–ø ZALVO -->
              <img src="zalvo-logo.png" alt="Zalvo logo">
            </div>
          </div>

          <!-- –ö–ê–†–¢–û–ß–ö–ê –ü–†–û–§–ò–õ–Ø –ú–ê–ì–ê–ó–ò–ù–ê -->
          <div class="store-card store-profile">
            <div class="store-name">Zalvo Phone Shop</div>
            <div class="store-subs">451 obunachi</div>

            <div class="store-rating">
              <span class="store-rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
              <span class="store-rating-count">4.9 (451 baho)</span>
            </div>

      <div class="store-actions">
  <button class="store-btn store-btn-primary" id="storeSubscribeBtn" type="button">
    <span class="icon-pill icon-pill-bell">üîî</span>
    <span>Obuna bo‚Äòlish</span>
  </button>

  <button class="store-btn store-btn-icon" id="storeMsgBtn" type="button" aria-label="Yozish">
    ‚úâÔ∏è
  </button>

  <button class="store-btn store-btn-icon" id="storeMoreBtn" type="button" aria-label="Ko‚Äòproq">
    ‚Ä¶
  </button>
</div>
          </div>
        
          <!-- –ö–û–ù–¢–ê–ö–¢–´ -->
          <div class="store-card">
            <div class="store-section-title">Kontaktlar</div>

            <div class="store-contacts-list">
              <div class="store-contact-row">
                <span class="store-contact-icon phone">üìû</span>
                <a href="tel:+998991234567">+998 99 123 45 67</a>
              </div>

              <div class="store-contact-row">
                <span class="store-contact-icon tg">‚úàÔ∏è</span>
                <a href="https://t.me/gulzor_shop" target="_blank">@gulzor_shop</a>
              </div>

              <div class="store-contact-row">
                <span class="store-contact-icon ig">üì∏</span>
                <a href="https://instagram.com/zalvo_shop" target="_blank">@zalvo_shop</a>
              </div>

              <div class="store-contact-row">
                <span class="store-contact-icon loc">üìç</span>
                <span>Mirzo Ulug‚Äòbek tumani, Toshkent</span>
              </div>

              <div class="store-contact-row">
                <span class="store-contact-icon clock">‚è∞</span>
                <span>
                  <strong>Bugun ochiq</strong>: Du‚ÄìJu 09:00‚Äì20:00, Ju 09:00‚Äì18:00
                </span>
              </div>
            </div>
          </div>

          <!-- –û –ú–ê–ì–ê–ó–ò–ù–ï -->
          <div class="store-card">
            <div class="store-section-title">Do‚Äòkon haqida</div>
            <p class="store-about-text">
              Zalvo Phone Shop ‚Äî original smartfonlar va aksessuarlar do‚Äòkoni.
              Kafolat, tezkor yetkazib berish va qulay narxlar.
            </p>
          </div>

          <!-- E‚ÄòLONLAR DO‚ÄòKON ICHIDA -->
          <div class="store-card">
            <div class="store-ads-header">
              <div class="store-ads-title">E‚Äòlonlar</div>
            </div>

            <div class="store-search-row">
              <div class="store-search-input">
                <span>üîç</span>
                <input id="shopAdsSearchInput" type="text" placeholder="E‚Äòlonlar ichidan qidirish">
              </div>
              <button class="store-filter-btn" id="shopAdsFilterBtn">‚â°</button>
            </div>

            <!-- –í–ê–ñ–ù–û: –û–°–¢–ê–í–õ–Ø–ï–ú –≠–¢–û–¢ DIV, –ß–¢–û–ë–´ –†–ê–ë–û–¢–ê–õ –ö–û–î renderMyShopAds() -->
            <div id="myShopAdsList" class="ad-list"></div>
          </div>

        </div>
      </section>
      
      <!-- ================= PROMOTION SCREEN ================= -->
      <section id="screen-promo" class="screen">
        <div class="screen-title">E‚Äôlonni ilgari surish</div>

        <div class="promo-screen-card">
          <div class="promo-screen-subtitle">
            E‚Äôloningizni yuqori o‚Äòringa olib chiqing!
          </div>

          <div class="promo-plan-list">
            <div class="promo-plan">
              <div class="promo-plan-main">
                <div class="promo-plan-name">TOP 24 soat</div>
                <div class="promo-plan-desc">E‚Äôlon 1 kun yuqorida turadi</div>
              </div>
              <div class="promo-plan-price">6 000 so‚Äòm</div>
            </div>

            <div class="promo-plan">
              <div class="promo-plan-main">
                <div class="promo-plan-name">TOP 7 kun</div>
                <div class="promo-plan-desc">E‚Äôlon hafta davomida ustida turadi</div>
              </div>
              <div class="promo-plan-price">25 000 so‚Äòm</div>
            </div>

            <div class="promo-plan">
              <div class="promo-plan-main">
                <div class="promo-plan-name">Super-Tezkor</div>
                <div class="promo-plan-desc">E‚Äôloningiz birinchi qatorga chiqadi</div>
                <div class="promo-plan-tag">Tavsiya etiladi</div>
              </div>
              <div class="promo-plan-price">40 000 so‚Äòm</div>
            </div>
          </div>

          <div class="promo-help-text">
            üí° Tezkor sotish uchun ‚ÄúSuper-Tezkor‚Äù paket tavsiya qilinadi.
          </div>
        </div>
      </section>

      <section class="screen" id="screen-blocks">
  <div class="section-title">Bloklar</div>

  <div class="chips-row" id="blocksTabs">
    <button class="chip chip-filled" data-tab="ads">E‚Äôlonlar</button>
    <button class="chip" data-tab="shops">Do‚Äòkonlar</button>
  </div>

  <div id="blockedAdsBox">
    <div id="blockedAdsList"></div>
  </div>

  <div id="blockedShopsBox" style="display:none;">
    <div id="blockedShopsList"></div>
  </div>

  <div style="padding:12px 0;">
    <button id="unblockAllBtn" class="primary-btn" type="button">
      Hammasini blokdan chiqarish
    </button>
  </div>
</section>
      
      <!-- ================= CHAT ================= -->
      <section id="screen-chat" class="screen">
        <!-- CHAT: Threads + Room -->
<div class="chat-wrap">

  <!-- 1) THREADS (—Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤) -->
  <div id="chatThreadsView" class="chat-view active">
    <div class="chat-topbar">
      <div class="chat-topbar-title">Chat</div>
      <button id="chatNewDialogBtn" class="chat-topbar-btn" type="button">Ôºã</button>
    </div>

    <div class="chat-search">
      <input id="chatThreadsSearch" type="text" placeholder="Qidirish..." />
    </div>

    <div id="chatThreadsList" class="chat-threads"></div>

    <div id="chatThreadsEmpty" class="chat-empty" style="display:none;">
      Hozircha chat yo‚Äòq
    </div>
  </div>

  <!-- 2) ROOM (–ø–µ—Ä–µ–ø–∏—Å–∫–∞) -->
  <div id="chatRoomView" class="chat-view">
    <div class="chat-room-topbar">
      <button id="chatRoomBackBtn" class="chat-room-back" type="button">‚Äπ</button>

      <div class="chat-room-peer">
        <div id="chatRoomAvatar" class="chat-room-avatar">S</div>
        <div class="chat-room-peerinfo">
          <div id="chatRoomTitle" class="chat-room-title">Sotuvchi</div>
          <div id="chatRoomStatus" class="chat-room-status">online</div>
        </div>
      </div>

      <button id="chatRoomMoreBtn" class="chat-room-more" type="button">‚ãØ</button>
    </div>

    <!-- AD CONTEXT CARD -->
<div id="chatAdCard" class="chat-adcard" style="display:none;">
  <div class="chat-adcard-inner">
    <div id="chatAdImg" class="chat-adcard-img"></div>

    <div class="chat-adcard-info">
      <div id="chatAdTitle" class="chat-adcard-title">E‚Äôlon</div>
      <div class="chat-adcard-sub">
        <span id="chatAdPrice"></span>
        <span id="chatAdCity"></span>
      </div>
    </div>

    <button id="chatAdOpenBtn" class="chat-adcard-open" type="button">–û—Ç–∫—Ä—ã—Ç—å</button>
  </div>
</div>
    
    <div id="chatMessages" class="chat-messages"></div>

    <div id="chatTyping" class="chat-typing" style="display:none;">Sotuvchi yozmoqda‚Ä¶</div>

   <div class="chat-composer-wrap" id="chatComposerWrap">
  <div class="chat-composer">
    <input id="chatFileInput" type="file" accept="image/*" style="display:none;" />
    <button id="chatAttachBtn" class="chat-attach" type="button">üìé</button>

    <input id="chatInput" class="chat-input" type="text" placeholder="Xabar yozing‚Ä¶" />

    <button id="chatSendBtn" class="chat-send" type="button">‚û§</button>
  </div>
</div>

  <!-- 3) ROOM ACTION SHEET -->
  <div id="chatRoomSheetBackdrop" class="store-sheet-backdrop">
    <div class="store-sheet">
      <div class="store-sheet-title" id="chatRoomSheetTitle">Chat</div>

      <button id="chatActionPin" class="store-sheet-item" type="button">
        <span class="store-sheet-icon share">üìå</span> Pin / Unpin
      </button>

      <button id="chatActionMute" class="store-sheet-item" type="button">
        <span class="store-sheet-icon share">üîï</span> Mute / Unmute
      </button>

      <button id="chatActionClear" class="store-sheet-item" type="button">
        <span class="store-sheet-icon warn">üßπ</span> Chatni tozalash
      </button>

      <button id="chatActionDelete" class="store-sheet-item" type="button">
        <span class="store-sheet-icon warn">üóëÔ∏è</span> Chatni o‚Äòchirish
      </button>

      <button id="chatActionReport" class="store-sheet-item" type="button">
        <span class="store-sheet-icon warn">‚ö†Ô∏è</span> Shikoyat
      </button>

      <button id="chatRoomSheetCancel" class="store-sheet-cancel" type="button">Bekor qilish</button>
    </div>
  </div>

</div>
      </section>

      <!-- ================= HISTORY ================= -->
      <section id="screen-history" class="screen">
        <div class="screen-title">Ko‚Äòrish tarixi</div>
        <div id="historyList" class="ad-list"></div>
      </section>

            <!-- ================= SHOPS (DO'KONLAR) ================= -->
<section id="screen-shops" class="screen">
  <div class="screen-title">Do‚Äòkonlar</div>

  <!-- Search + filter -->
  <div class="shops-search-row">
    <div class="shops-search">
      <input id="shopsSearchInput" class="shops-search-input" type="text" placeholder="Do‚Äòkon qidirish..." />
    </div>
    <button id="shopsFilterBtn" class="shops-filter-btn" type="button">‚öôÔ∏è</button>
  </div>

  <!-- Category chips -->
  <div id="shopsCategoryRow" class="chip-row" style="margin-top:6px;">
    <div class="chip chip-filled" data-shopcat="all">Hammasi</div>
    <div class="chip" data-shopcat="Elektronika">Elektronika</div>
    <div class="chip" data-shopcat="Avto">Avto</div>
    <div class="chip" data-shopcat="Uy-rozg‚Äòor">Uy-rozg‚Äòor</div>
    <div class="chip" data-shopcat="Xizmatlar">Xizmatlar</div>
    <div class="chip" data-shopcat="Kiyim">Kiyim</div>
  </div>

  <!-- Top shops -->
  <div class="section-title" style="margin-top:10px;">Top do‚Äòkonlar</div>
  <div id="topShopsRow" class="top-shops-row"></div>

  <!-- All shops list -->
  <div class="section-title" style="margin-top:12px;">Barcha do‚Äòkonlar</div>
  <div id="shopsList" class="shops-list"></div>

  <div id="shopsEmpty" class="ad-meta" style="display:none; margin-top:10px;">
    Do‚Äòkonlar topilmadi
  </div>
</section>

<!-- ===== Shops filter sheet ===== -->
<div class="store-sheet-backdrop" id="shopsFilterSheet">
  <div class="store-sheet">
    <div class="store-sheet-handle"></div>

    <div style="font-weight:700; font-size:16px; margin-bottom:10px;">Do‚Äòkonlar filtri</div>

    <div style="display:flex; flex-direction:column; gap:10px;">
      <div>
        <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">Viloyat</div>
        <select id="shopsFilterCity" class="form-select">
          <option value="all">Hammasi</option>
          <option value="Toshkent shahri">Toshkent shahri</option>
          <option value="Toshkent viloyati">Toshkent viloyati</option>
          <option value="Andijon">Andijon</option>
          <option value="Buxoro">Buxoro</option>
          <option value="Farg‚Äòona">Farg‚Äòona</option>
          <option value="Jizzax">Jizzax</option>
          <option value="Xorazm">Xorazm</option>
          <option value="Namangan">Namangan</option>
          <option value="Navoiy">Navoiy</option>
          <option value="Qashqadaryo">Qashqadaryo</option>
          <option value="Samarqand">Samarqand</option>
          <option value="Sirdaryo">Sirdaryo</option>
          <option value="Surxondaryo">Surxondaryo</option>
          <option value="Qoraqalpog‚Äòiston">Qoraqalpog‚Äòiston</option>
        </select>
      </div>

      <div>
        <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">Saralash</div>
        <select id="shopsSort" class="form-select">
          <option value="popular">Mashhur</option>
          <option value="new">Yangi</option>
          <option value="rating">Reyting</option>
        </select>
      </div>

      <button id="shopsOnlyVerified" class="chip" type="button">Faqat tasdiqlangan</button>

      <div style="display:flex; gap:10px; margin-top:6px;">
        <button id="shopsApply" class="primary-btn" type="button" style="margin:0;">Qo‚Äòllash</button>
        <button id="shopsReset" class="outline-btn" type="button" style="margin:0;">Tozalash</button>
      </div>
    </div>
  </div>
</div>

      <!-- ================= SHOP VIEW (ANY SHOP) ================= -->
<section id="screen-shop-view" class="screen">
  <div class="store-page">

    <div class="store-cover">
      <img id="shopViewCover" src="iphone14-pro.jpg" alt="Cover">
      <div class="store-avatar">
        <div id="shopViewAvatar" class="shop-view-avatar">Z</div>
      </div>
    </div>

    <div class="store-card store-profile">
      <div id="shopViewName" class="store-name">Do‚Äòkon</div>
      <div id="shopViewBadge" class="shop-badge" style="display:none;"></div>
      <div id="shopViewSubs" class="store-subs">0 obunachi</div>

      <div class="store-rating">
        <span id="shopViewStars" class="store-rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
        <span id="shopViewRating" class="store-rating-count">0.0 (0 baho)</span>
      </div>

      <div class="store-actions">
        <button id="shopViewSubBtn" class="shop-subscribe-btn" type="button">
  üîî Obuna bo‚Äòlish
</button>

        <button class="store-btn store-btn-icon" id="shopViewMsgBtn" type="button" aria-label="Yozish">‚úâÔ∏è</button>
        <button class="store-btn store-btn-icon" id="shopViewMoreBtn" type="button" aria-label="Ko‚Äòproq">‚Ä¶</button>
      </div>
    </div>

    <div class="store-card">
      <div class="store-section-title">Kontaktlar</div>
      <div class="store-contacts-list">
        <div class="store-contact-row">
          <span class="store-contact-icon phone">üìû</span>
          <a id="shopViewPhone" href="#" style="display:none;">Telefon</a>
          <span id="shopViewPhoneText" style="display:none;">Telefon yo‚Äòq</span>
        </div>

        <div class="store-contact-row">
          <span class="store-contact-icon tg">‚úàÔ∏è</span>
          <a id="shopViewTg" href="#" target="_blank">@shop</a>
        </div>

        <div class="store-contact-row">
          <span class="store-contact-icon loc">üìç</span>
          <span id="shopViewCity">Shahar</span>
        </div>
      </div>
    </div>

    <div class="store-card">
      <div class="store-ads-header">
        <div class="store-ads-title">E‚Äòlonlar</div>
      </div>

      <div class="store-search-row">
        <div class="store-search-input">
          <span>üîç</span>
          <input id="shopViewAdsSearchInput" type="text" placeholder="E‚Äòlonlar ichidan qidirish">
        </div>
        <button class="store-filter-btn" id="shopViewAdsFilterBtn">‚â°</button>
      </div>

      <div id="shopViewAdsList" class="ad-list"></div>
    </div>

  </div>
</section>
      
      <!-- ================= ZALVO BIZNES UCHUN ================= -->
<section id="screen-business" class="screen">
  <div class="business-header">
    <div class="back-link" id="businessBack">‚Üê Orqaga</div>

    <div class="business-icon-wrap">
      <div class="business-icon-inner">
        üîí
      </div>
    </div>

    <h1 class="business-title">Zalvo biznes uchun</h1>
    <p class="business-subtitle">
      Oddiy ZALVO akkauntingizni to‚Äòliq biznes-profilga aylantiring.
      Do‚Äòkoningiz, manzilingiz, ish vaqtingiz va mahsulotlaringiz bir joyda.
    </p>
  </div>

  <div class="business-card">
    <div class="business-feature-row">
      <div class="business-feature-icon business-feature-icon-orange">üìç</div>
      <div class="business-feature-main">
        <div class="business-feature-title">Manzil</div>
        <div class="business-feature-sub">
          xaridorlar sizni xaritada ko‚Äòra oladi
        </div>
      </div>
    </div>

    <div class="business-divider"></div>

    <div class="business-feature-row">
      <div class="business-feature-icon business-feature-icon-blue">üïí</div>
      <div class="business-feature-main">
        <div class="business-feature-title">Ish vaqti</div>
        <div class="business-feature-sub">
          qaysi kuni nechagacha ishlashingiz ko‚Äòrinadi
        </div>
      </div>
    </div>

    <div class="business-divider"></div>

    <div class="business-feature-row">
      <div class="business-feature-icon business-feature-icon-pink">üè¨</div>
      <div class="business-feature-main">
        <div class="business-feature-title">Do‚Äòkon sahifasi</div>
        <div class="business-feature-sub">
          barcha mahsulotlaringiz bitta sahifada
        </div>
      </div>
    </div>

    <div class="business-divider"></div>

    <div class="business-feature-row">
      <div class="business-feature-icon business-feature-icon-gold">‚≠ê</div>
      <div class="business-feature-main">
        <div class="business-feature-title">Reyting</div>
        <div class="business-feature-sub">
          mijozlar fikri ishonchni oshiradi
        </div>
      </div>
    </div>

    <div class="business-beta">
      <strong>Beta davri</strong> ‚Äî hozircha do‚Äòkon ochish mutlaqo bepul.
      Keyinchalik oylik obuna narxi qo‚Äòshiladi.
    </div>
  </div>

  <div class="business-cta">
    <button id="businessOpenShopBtn" class="business-cta-btn">
  Do‚Äòkonni bepul ochish
</button>
    <div class="business-cta-hint">
      Hoziroq bepul ulaning ‚Äî keyin pullik obunaga o‚Äòtish ixtiyoriy bo‚Äòladi.
    </div>
  </div>
</section>
      
      <!-- ================= ADMIN PANEL ================= -->
      <section id="screen-admin" class="screen">
        <div class="screen-title">Admin Panel</div>

        <div class="admin-card">
          <div class="admin-section-title">Statistika</div>

          <div class="admin-stat-row">
            <div class="admin-stat">
              <div class="admin-stat-number" id="adminTotalAds">0</div>
              <div class="admin-stat-label">E‚Äôlonlar</div>
            </div>

            <div class="admin-stat">
              <div class="admin-stat-number" id="adminNewToday">0</div>
              <div class="admin-stat-label">Bugun yangi</div>
            </div>
          </div>

          <div class="admin-section-title">So‚Äònggi 10 ta e‚Äôlon</div>
          <div class="admin-list" id="adminLastAds"></div>
        </div>
      </section>

      <!-- ================= NEW AD: STEP 1 ================= -->
      <section id="screen-new-ad-step1" class="screen">
        <div class="screen-title">Yangi e‚Äôlon</div>

        <div class="form-group">
          <label class="form-label">Shahar</label>
          <select id="inputCity" class="form-select">
            <option value="Toshkent shahri">Toshkent shahri</option>
<option value="Toshkent viloyati">Toshkent viloyati</option>
<option value="Andijon">Andijon</option>
<option value="Buxoro">Buxoro</option>
<option value="Farg‚Äòona">Farg‚Äòona</option>
<option value="Jizzax">Jizzax</option>
<option value="Xorazm">Xorazm</option>
<option value="Namangan">Namangan</option>
<option value="Navoiy">Navoiy</option>
<option value="Qashqadaryo">Qashqadaryo</option>
<option value="Samarqand">Samarqand</option>
<option value="Sirdaryo">Sirdaryo</option>
<option value="Surxondaryo">Surxondaryo</option>
<option value="Qoraqalpog‚Äòiston">Qoraqalpog‚Äòiston</option>
          </select>
        </div>

        <div class="form-group">
  <label class="form-label">Kategoriya</label>
  <select id="inputCategory" class="form-select">
    <option value="Transport">Transport</option>
    <option value="Ko‚Äòchmas mulk">Ko‚Äòchmas mulk</option>
    <option value="Elektronika">Elektronika</option>
    <option value="Xizmatlar">Xizmatlar</option>
    <option value="Uy va bog‚Äò">Uy va bog‚Äò</option>
    <option value="Kiyim-kechak">Kiyim-kechak</option>
    <option value="Bolalar">Bolalar</option>
    <option value="Hayvonlar">Hayvonlar</option>
    <option value="Ish">Ish</option>
    <option value="Boshqa">Boshqa</option>
  </select>
</div>
        
        <div class="form-group">
          <label class="form-label">Sarlavha</label>
          <input id="inputTitle" type="text" class="form-input" />
        </div>

        <div class="form-group">
          <label class="form-label">Narx (so‚Äòm)</label>
          <input id="inputPrice" type="text" inputmode="numeric" class="form-input" placeholder="Masalan: 123 456 789" />
        </div>

        <div class="form-group">
          <label class="form-label">Tavsif</label>
          <textarea id="inputDescription" class="form-textarea"></textarea>
        </div>

        <button id="btnNewAdStep1Next" class="primary-btn">Davom etish</button>
      </section>

      <!-- ================= NEW AD: STEP 2 ================= -->
      <section id="screen-new-ad-step2" class="screen">
        <div class="back-link" id="backFromNewAd2">‚Üê Orqaga</div>
        <div class="screen-title">Rasmlar</div>

        <button id="btnUploadPhotos" class="primary-btn">Rasmlar yuklash</button>
        <input id="inputPhotos" type="file" multiple class="hidden-input" />

        <div id="photosPreview" class="photos-preview-row"></div>

        <button id="btnNewAdStep2Next" class="primary-btn">Davom etish</button>
      </section>

      <!-- ================= NEW AD: STEP 3 ================= -->
      <section id="screen-new-ad-step3" class="screen">
        <div class="back-link" id="backFromNewAd3">‚Üê Orqaga</div>
        <div class="screen-title">Tasdiqlash</div>

        <div id="summaryTitle" class="screen-title"></div>
        <div id="summaryCityType"></div>
        <div id="summaryPrice"></div>
        <div id="summaryDescription" class="ad-view-description"></div>
        <div id="summaryPhotosInfo" class="ad-view-meta"></div>

        <button id="btnPublishAd" class="primary-btn">E‚Äôlonni joylash</button>
      </section>

      <!-- ================= SUCCESS ================= -->
      <section id="screen-new-ad-success" class="screen">
        <div class="success-icon">‚úî</div>
        <div class="success-text-main">E‚Äôlon joylandi!</div>
        <div class="success-text-sub">Moderatsiyadan o‚Äòtishi kutilmoqda.</div>

        <button id="btnGoHome" class="primary-btn">Bosh sahifa</button>
      </section>

      <!-- ================== PROFILIM (EDIT) ================== -->
<section id="screen-profile-edit" class="screen">
  <div class="screen-pad">
    <div class="section-title">Profilim</div>

    <div class="settings-card">
      <!-- Phone -->
      <button id="editPhoneRow" class="settings-row">
        <div class="settings-icon">üì±</div>
        <div class="settings-title">
          Telefon raqami
          <div id="profilePhoneValue" class="settings-sub">‚Äî</div>
        </div>
        <div class="settings-arrow">‚Ä∫</div>
      </button>

      <!-- Email -->
      <button id="editEmailRow" class="settings-row">
        <div class="settings-icon">‚úâÔ∏è</div>
        <div class="settings-title">
          Elektron pochta
          <div id="profileEmailValue" class="settings-sub">‚Äî</div>
        </div>
        <div class="settings-arrow">‚Ä∫</div>
      </button>

      <!-- Password -->
      <button id="editPasswordRow" class="settings-row">
        <div class="settings-icon">üîí</div>
        <div class="settings-title">
          Parol
          <div class="settings-sub">O‚Äòzgartirish</div>
        </div>
        <div class="settings-arrow">‚Ä∫</div>
      </button>
    </div>
  </div>

  <!-- Simple modal (reuse one) -->
  <div id="profileEditBackdrop" class="sheet-backdrop hidden"></div>

  <div id="profileEditSheet" class="sheet hidden" role="dialog" aria-modal="true">
    <div class="sheet-handle"></div>
    <div id="profileEditTitle" class="sheet-title">‚Äî</div>

    <div id="profileEditBody" class="sheet-body">
      <!-- dynamic -->
    </div>

    <div class="sheet-actions">
      <button id="profileEditCancel" class="btn-secondary" type="button">Bekor qilish</button>
      <button id="profileEditSave" class="btn-primary" type="button">Saqlash</button>
    </div>
  </div>
</section>

      <!-- ================= TILNI TANLASH (UZ/RU) ================= -->
<section id="screen-language" class="screen">
  <div class="screen-title">Tilni tanlash</div>

  <div class="settings-card">
    <button class="settings-row" id="languageUz">
      <div class="settings-icon">üá∫üáø</div>
      <div class="settings-title">O‚Äòzbek tili</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>

    <button class="settings-row" id="languageRu">
      <div class="settings-icon">üá∑üá∫</div>
      <div class="settings-title">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</div>
      <div class="settings-arrow">‚Ä∫</div>
    </button>
  </div>
</section>
    </main>

<!-- BOTTOM SHEET: FILTER (Do‚Äòkon e‚Äòlonlari uchun) -->
<div class="store-sheet-backdrop" id="shopAdsFilterSheet">
  <div class="store-sheet">
    <div class="store-sheet-handle"></div>

    <div style="font-weight:700; font-size:16px; margin-bottom:10px;">Filtr</div>

    <div style="display:flex; flex-direction:column; gap:10px;">

      <div>
        <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">Saralash</div>
        <select id="shopAdsSort" class="form-select">
          <option value="new">Yangi e‚Äôlonlar</option>
          <option value="cheap">Arzon</option>
          <option value="expensive">Qimmat</option>
        </select>
      </div>

      <div>
        <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">Narx (so‚Äòm)</div>
        <div style="display:flex; gap:8px;">
          <input id="shopAdsMinPrice" class="form-input" type="number" placeholder="Min" />
          <input id="shopAdsMaxPrice" class="form-input" type="number" placeholder="Max" />
        </div>
        <div class="hint">Bo‚Äòsh qoldirsangiz ‚Äî cheklanmaydi</div>
      </div>

      <button id="shopAdsOnlyPhoto" class="chip" type="button">Faqat rasmlar bilan</button>

      <div style="display:flex; gap:10px; margin-top:6px;">
        <button id="shopAdsApply" class="primary-btn" type="button" style="margin:0;">Qo‚Äòllash</button>
        <button id="shopAdsReset" class="outline-btn" type="button" style="margin:0;">Tozalash</button>
      </div>

    </div>
  </div>
</div>

    <!-- Shops Action Sheet (iOS style) -->
<div class="store-sheet-backdrop" id="shopSheetBackdrop">
  <div class="store-sheet" role="dialog" aria-modal="true">
    <div class="store-sheet-handle"></div>

    <div class="shop-sheet-title" id="shopSheetTitle">Shop</div>

    <div class="store-sheet-list">
      <button class="store-sheet-item" id="shopSheetFav" type="button">
        <span class="store-sheet-icon share">‚≠ê</span>
        Izbranlarga qo‚Äòshish
      </button>

      <button class="store-sheet-item" id="shopSheetShare" type="button">
        <span class="store-sheet-icon share">üîó</span>
        Ulashish
      </button>

      <button class="store-sheet-item danger" id="shopSheetBlock" type="button">
        <span class="store-sheet-icon report">‚õî</span>
        Bloklash
      </button>

      <!-- ‚úÖ FIX: —Ç–µ–ø–µ—Ä—å –∂–∞–ª–æ–±–∞ ‚Äî —Ç–∞–∫–∞—è –∂–µ –∫–Ω–æ–ø–∫–∞, –∫–∞–∫ –æ—Å—Ç–∞–ª—å–Ω—ã–µ -->
      <button class="store-sheet-item" id="shopSheetReport" type="button">
        <span class="store-sheet-icon report">‚ö†Ô∏è</span>
        Shikoyat qilish
      </button>
    </div>

    <button id="shopSheetCancelBtn" type="button" class="store-sheet-cancel">
  Bekor qilish
</button>
  </div>
</div>

<!-- Report Sheet -->
<div id="reportSheetBackdrop" class="store-sheet-backdrop">
  <div class="store-sheet" role="dialog" aria-modal="true">
    <div class="store-sheet-handle"></div>

    <div class="store-sheet-title">Shikoyat qilish</div>

    <button class="store-sheet-item report-option" data-reason="fake" type="button">Soxta do‚Äòkon</button>
    <button class="store-sheet-item report-option" data-reason="rules" type="button">Qoidabuzarlik</button>
    <button class="store-sheet-item report-option" data-reason="scam" type="button">Firibgarlik</button>
    <button class="store-sheet-item report-option" data-reason="wrong" type="button">Noto‚Äòg‚Äòri ma‚Äôlumot</button>
    <button class="store-sheet-item report-option" data-reason="other" type="button">Boshqa</button>

    <button id="reportCancelBtn" class="store-sheet-cancel" type="button">
  Bekor qilish
</button>
  </div>
</div>

    <!-- ================= AD ACTION SHEET (E'lonlar uchun) ================= -->
<div class="store-sheet-backdrop" id="adSheetBackdrop">
  <div class="store-sheet" role="dialog" aria-modal="true">
    <div class="store-sheet-handle"></div>

    <div class="shop-sheet-title" id="adSheetTitle">E‚Äôlon</div>

    <div class="store-sheet-list">
      <button class="store-sheet-item" id="adSheetFav" type="button">
        <span class="store-sheet-icon share">‚≠ê</span>
        Izbranlarga qo‚Äòshish
      </button>

      <button class="store-sheet-item" id="adSheetShare" type="button">
        <span class="store-sheet-icon share">üîó</span>
        Ulashish
      </button>

      <button class="store-sheet-item danger" id="adSheetBlock" type="button">
        <span class="store-sheet-icon report">‚õî</span>
        Bloklash
      </button>

      <button class="store-sheet-item" id="adSheetReport" type="button">
        <span class="store-sheet-icon report">‚ö†Ô∏è</span>
        Shikoyat qilish
      </button>
    </div>

    <button id="adSheetCancelBtn" type="button" class="store-sheet-cancel">Bekor qilish</button>
  </div>
</div>

<!-- ================= AD REPORT SHEET ================= -->
<div id="adReportSheetBackdrop" class="store-sheet-backdrop">
  <div class="store-sheet" role="dialog" aria-modal="true">
    <div class="store-sheet-handle"></div>

    <div class="store-sheet-title">Shikoyat qilish</div>

    <button class="store-sheet-item ad-report-option" data-reason="fake" type="button">Soxta e‚Äôlon</button>
    <button class="store-sheet-item ad-report-option" data-reason="rules" type="button">Qoidabuzarlik</button>
    <button class="store-sheet-item ad-report-option" data-reason="scam" type="button">Firibgarlik</button>
    <button class="store-sheet-item ad-report-option" data-reason="wrong" type="button">Noto‚Äòg‚Äòri ma‚Äôlumot</button>
    <button class="store-sheet-item ad-report-option" data-reason="other" type="button">Boshqa</button>

    <button id="adReportCancelBtn" class="store-sheet-cancel" type="button">Bekor qilish</button>
  </div>
</div>
    
    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <button type="button" class="nav-btn active" data-screen="home">
      <span class="icon">üîç</span>
      <span>Qidirish</span>
    </button>
    <button type="button" class="nav-btn" data-screen="shops">
      <span class="icon">üè™</span>
      <span>Do‚Äòkonlar</span>
    </button>
    <!-- ‚úÖ NEW: center + button -->
<button id="navAddBtn" class="nav-add-btn" type="button" aria-label="E‚Äôlon joylash">+</button>
    <button type="button" class="nav-btn" data-screen="chat">
      <span class="icon">üí¨</span>
      <span>Chat</span>
    </button>
    <button type="button" class="nav-btn" data-screen="profile">
  <span class="icon">‚öôÔ∏è</span>
  <span>Sozlamalar</span>
</button>
  </div>
</nav>
  </div>

  <!-- LIGHTBOX -->
  <div id="imageLightbox" class="lightbox">
    <button id="lightboxPrev" class="lightbox-arrow lightbox-prev">‚Üê</button>
    <img id="lightboxImg" src="" alt="Preview" />
    <button id="lightboxNext" class="lightbox-arrow lightbox-next">‚Üí</button>
    <div class="lightbox-close-hint">Yopish uchun ekranga bosing</div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    <div class="toast-inner">
      <div class="toast-icon">üöÄ</div>
      <div>
        <div class="toast-text-main">E‚Äôlon yuqoriga ko‚Äòtarildi!</div>
        <div class="toast-text-sub">Odamlarga ko‚Äòproq ko‚Äòrinadi</div>
      </div>
    </div>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  try {
    // ================== –ù–ê–°–¢–†–û–ô–ö–ò / –ö–û–ù–°–¢–ê–ù–¢–´ ==================
    const ADS_API_URL    = "https://baxir.pythonanywhere.com/ads";
    const ADD_AD_API_URL = "https://baxir.pythonanywhere.com/api/add_ad";

    const DEFAULT_PHONE    = "+998901234567";
    const DEFAULT_TELEGRAM = "Baxir1987";

    const EXCHANGE_RATE = 12500; // 1 USD = X so'm

    // ImgBB
    const IMGBB_API_KEY     = "d6a3eac7b36101df3effee3f7d0c7493";
    const IMGBB_UPLOAD_URL  = "https://api.imgbb.com/1/upload";

    // Infinite scroll
    const FEED_CHUNK_SIZE = 10;

    // localStorage keys
    const FAVORITES_KEY = "mh_favorites";
    const HISTORY_KEY   = "mh_history";
    const PROFILE_PHOTO_KEY = "zalvo_profile_photo";
    const SHOP_FAVORITES_KEY = "zalvo_shop_favorites";
    const PROFILE_KEY = "zalvo_profile"; // ‚úÖ Profilim: phone/email/password (local, ready for DB)

    // ================== DOM-–≠–õ–ï–ú–ï–ù–¢–´ ==================
    const screensContainer = document.querySelector(".screens");

    // Screens
    const screenHome        = document.getElementById("screen-home");
    const screenFavorites   = document.getElementById("screen-favorites");
    const screenFilters     = document.getElementById("screen-filters");
    const screenAdDetails   = document.getElementById("screen-ad-details");
    const screenProfile     = document.getElementById("screen-profile");
    const screenPromo       = document.getElementById("screen-promo");
    const screenChat        = document.getElementById("screen-chat");
    const screenHistory     = document.getElementById("screen-history");
    const screenAdmin       = document.getElementById("screen-admin");
    const screenNewAd1      = document.getElementById("screen-new-ad-step1");
    const screenNewAd2      = document.getElementById("screen-new-ad-step2");
    const screenNewAd3      = document.getElementById("screen-new-ad-step3");
    const screenNewAdSuccess= document.getElementById("screen-new-ad-success");
    const screenShops       = document.getElementById("screen-shops");
    const screenSettings    = document.getElementById("screen-settings");
    
    // ===== PROFILIM (edit) =====
const screenProfileEdit = document.getElementById("screen-profile-edit");
const settingsProfileRow = document.getElementById("settingsProfileRow");

const editPhoneRow    = document.getElementById("editPhoneRow");
const editEmailRow    = document.getElementById("editEmailRow");
const editPasswordRow = document.getElementById("editPasswordRow");

const profilePhoneValue = document.getElementById("profilePhoneValue");
const profileEmailValue = document.getElementById("profileEmailValue");

const profileEditBackdrop = document.getElementById("profileEditBackdrop");
const profileEditSheet    = document.getElementById("profileEditSheet");
const profileEditTitle    = document.getElementById("profileEditTitle");
const profileEditBody     = document.getElementById("profileEditBody");
const profileEditCancel   = document.getElementById("profileEditCancel");
const profileEditSave     = document.getElementById("profileEditSave");

    const settingsLangRow   = document.getElementById("settingsLangRow");
    const screenLanguage    = document.getElementById("screen-language");
    const languageUz        = document.getElementById("languageUz");
    const languageRu        = document.getElementById("languageRu");

    const screenMyAds       = document.getElementById("screen-my-ads");
    const myAdsList         = document.getElementById("myAdsList");
    const settingsMyAdsRow  = document.getElementById("settingsMyAdsRow");

    const profileAvatar       = document.getElementById("profileAvatar");
    const profilePhotoInput   = document.getElementById("profilePhotoInput");
    const settingsChangePhoto = document.getElementById("settingsChangePhoto");

    const screenMyShop      = document.getElementById("screen-my-shop");
    const myShopAdsList     = document.getElementById("myShopAdsList");
    const settingsMyShopRow = document.getElementById("settingsMyShopRow");

    const screenBusiness    = document.getElementById("screen-business");
    const businessBackBtn   = document.getElementById("businessBack");
    const businessOpenShopBtn  = document.getElementById("businessOpenShopBtn");

    // ‚úÖ –í–ê–ñ–ù–û: storeMoreBtn –æ–±—ä—è–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó
    const storeMoreBtn      = document.getElementById("storeMoreBtn");
    const storeSheet        = document.getElementById("storeSheet"); // –æ—Å—Ç–∞–≤–∏–ª, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å
    const storeMsgBtn       = document.getElementById("storeMsgBtn");
    const storeSubscribeBtn = document.getElementById("storeSubscribeBtn");

    const filterCategoryRow = document.getElementById("filterCategoryRow");

    if (storeMsgBtn) {
      storeMsgBtn.addEventListener("click", () => {
        showScreen("chat");
      });
    }

    // ===== Shop View screen elements =====
    const screenShopView = document.getElementById("screen-shop-view");

    const shopViewName   = document.getElementById("shopViewName");
    const shopViewSubs   = document.getElementById("shopViewSubs");
    const shopViewRating = document.getElementById("shopViewRating");
    const shopViewStars  = document.getElementById("shopViewStars");
    const shopViewCity   = document.getElementById("shopViewCity");
    const shopViewTg     = document.getElementById("shopViewTg");
    const shopViewPhone  = document.getElementById("shopViewPhone");
    const shopViewPhoneText = document.getElementById("shopViewPhoneText");
    const shopViewAvatar = document.getElementById("shopViewAvatar");

    const shopViewMsgBtn = document.getElementById("shopViewMsgBtn");
    const shopViewMoreBtn = document.getElementById("shopViewMoreBtn");
    const shopViewSubBtn = document.getElementById("shopViewSubBtn");

    const shopViewAdsList = document.getElementById("shopViewAdsList");
    const shopViewAdsSearchInput = document.getElementById("shopViewAdsSearchInput");
    const shopViewAdsFilterBtn = document.getElementById("shopViewAdsFilterBtn");

    // ===== Shop Ads Filter DOM (shared sheet) =====
    const shopAdsFilterBtn   = document.getElementById("shopAdsFilterBtn");
    const shopAdsFilterSheet = document.getElementById("shopAdsFilterSheet");

    const shopAdsSearchInput = document.getElementById("shopAdsSearchInput");
    const shopAdsSort        = document.getElementById("shopAdsSort");
    const shopAdsMinPrice    = document.getElementById("shopAdsMinPrice");
    const shopAdsMaxPrice    = document.getElementById("shopAdsMaxPrice");
    const shopAdsOnlyPhotoBtn= document.getElementById("shopAdsOnlyPhoto");
    const shopAdsApplyBtn    = document.getElementById("shopAdsApply");
    const shopAdsResetBtn    = document.getElementById("shopAdsReset");

    const shopAdsFilterState = {
      sort: "new",
      minPrice: "",
      maxPrice: "",
      onlyWithPhoto: false,
    };

        // ===== AD Action Sheet (E'lon) =====
    const adMoreBtn        = document.getElementById("adMoreBtn");
    const adSheetBackdrop  = document.getElementById("adSheetBackdrop");
    const adSheetTitle     = document.getElementById("adSheetTitle");
    const adSheetFav       = document.getElementById("adSheetFav");
    const adSheetShare     = document.getElementById("adSheetShare");
    const adSheetBlock     = document.getElementById("adSheetBlock");
    const adSheetReport    = document.getElementById("adSheetReport");
    const adSheetCancelBtn = document.getElementById("adSheetCancelBtn");

    const adReportBackdrop = document.getElementById("adReportSheetBackdrop");
    const adReportOptions  = document.querySelectorAll(".ad-report-option");
    const adReportCancelBtn= document.getElementById("adReportCancelBtn");
    
    // Settings rows
    const settingsFavoritesRow = document.getElementById("settingsFavoritesRow");
    const settingsHistoryRow   = document.getElementById("settingsHistoryRow");
    const settingsPaidRow      = document.getElementById("settingsPaidRow");
    const settingsBusinessRow  = document.getElementById("settingsBusinessRow");
    const settingsShopRow      = document.getElementById("settingsMyShopRow");

    // Lists
    const feedList          = document.getElementById("feedList");
    const favoritesList     = document.getElementById("favoritesList");
    const historyListEl     = document.getElementById("historyList");
    const adminLastAdsEl    = document.getElementById("adminLastAds");

    // Admin stats
    const adminTotalAdsEl   = document.getElementById("adminTotalAds");
    const adminNewTodayEl   = document.getElementById("adminNewToday");

    // Search / filters
    const searchInput       = document.querySelector(".search-input");
    const btnSearchFake = document.getElementById("btnSearchFake");
    const openFiltersBtn    = document.getElementById("openFiltersBtn");
    const homeCategoryGrid  = document.getElementById("homeCategoryGrid");

   // ===== Mashhur bo‚Äòlimlar: filter + active highlight =====
function setActiveHomeCategory(activeCategory) {
  if (!homeCategoryGrid) return;

  homeCategoryGrid.querySelectorAll(".category-card").forEach(card => {
    const c = card.dataset.category || "";
    card.classList.toggle("active", c === activeCategory);
  });
}

if (homeCategoryGrid && !homeCategoryGrid.dataset.bound) {
  homeCategoryGrid.dataset.bound = "1";

  homeCategoryGrid.addEventListener("click", (e) => {
    const card = e.target.closest(".category-card");
    if (!card) return;

    const category = card.dataset.category;
    if (!category) return;

    // toggle
    if (filterState.category === category) {
      filterState.category = "all";
      setActiveHomeCategory(null); // —É–±—Ä–∞—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É
    } else {
      filterState.category = category;
      setActiveHomeCategory(category); // –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
    }

    applyAllFilters();
    resetFeedRender();
    showScreen("home", { resetStack: true });
  });
}
    
    const filterTypeRow     = document.getElementById("filterTypeRow");
    const filterCitySelect  = document.getElementById("filterCity");
    const filterCurrencyRow = document.getElementById("filterCurrencyRow");
    const filterPhotoChip   = document.getElementById("filterPhotoChip");
    const filterSortSelect  = document.getElementById("filterSort");
    const filtersApplyBtn   = document.getElementById("filtersApplyBtn");
    const filtersResetBtn   = document.getElementById("filtersResetBtn");
    const filtersBackBtn    = document.getElementById("filtersBack");

    // New ad
    const btnOpenNewAd      = document.getElementById("btnOpenNewAd");
    const backFromNewAd1    = document.getElementById("backFromNewAd1");
    const backFromNewAd2    = document.getElementById("backFromNewAd2");
    const backFromNewAd3    = document.getElementById("backFromNewAd3");
    const btnNewAdStep1Next = document.getElementById("btnNewAdStep1Next");
    const btnNewAdStep2Next = document.getElementById("btnNewAdStep2Next");
    const btnPublishAd      = document.getElementById("btnPublishAd");
    const btnGoHome         = document.getElementById("btnGoHome");

    const inputCity         = document.getElementById("inputCity");
    const inputTitle        = document.getElementById("inputTitle");
    const inputPrice        = document.getElementById("inputPrice");
    const inputDescription  = document.getElementById("inputDescription");
    const btnUploadPhotos   = document.getElementById("btnUploadPhotos");
    const inputPhotos       = document.getElementById("inputPhotos");
    const photosPreview     = document.getElementById("photosPreview");
    const summaryTitle      = document.getElementById("summaryTitle");
    const summaryCityType   = document.getElementById("summaryCityType");
    const summaryPrice      = document.getElementById("summaryPrice");
    const summaryDescription= document.getElementById("summaryDescription");
    const summaryPhotosInfo = document.getElementById("summaryPhotosInfo");
    const inputCategory     = document.getElementById("inputCategory");

    // Ad details
    const detailMainImage   = document.getElementById("detailMainImage");
    const detailThumbs      = document.getElementById("detailThumbs");
    const detailTitle       = document.getElementById("detailTitle");
    const detailPrice       = document.getElementById("detailPrice");
    const detailMeta        = document.getElementById("detailMeta");
    const detailDescription = document.getElementById("detailDescription");
    const detailBackBtn     = document.getElementById("detailBackBtn");
    const similarList       = document.getElementById("similarList");
    const favoriteBtn       = document.getElementById("favoriteBtn");
    const shareBtn          = document.getElementById("shareBtn");
    const callSellerBtn     = document.getElementById("callSellerBtn");
    const msgSellerBtn      = document.getElementById("msgSellerBtn");

    // Lightbox
    const imageLightbox     = document.getElementById("imageLightbox");
    const lightboxImg       = document.getElementById("lightboxImg");
    const lightboxPrev      = document.getElementById("lightboxPrev");
    const lightboxNext      = document.getElementById("lightboxNext");

    // Toast
    const toastEl           = document.getElementById("toast");

    // Promo
    const promoBanner       = document.getElementById("promoBanner");

    // Chat
    const chatMessagesEl    = document.getElementById("chatMessages");
    const chatInput         = document.getElementById("chatInput");
    const chatSendBtn       = document.getElementById("chatSendBtn");

    // ===== Chat NEW DOM =====
const chatThreadsView = document.getElementById("chatThreadsView");
const chatRoomView = document.getElementById("chatRoomView");

const chatThreadsList = document.getElementById("chatThreadsList");
const chatThreadsEmpty = document.getElementById("chatThreadsEmpty");
const chatThreadsSearch = document.getElementById("chatThreadsSearch");
const chatNewDialogBtn = document.getElementById("chatNewDialogBtn");

const chatRoomBackBtn = document.getElementById("chatRoomBackBtn");
const chatRoomMoreBtn = document.getElementById("chatRoomMoreBtn");
const chatRoomAvatar = document.getElementById("chatRoomAvatar");
const chatRoomTitle = document.getElementById("chatRoomTitle");
const chatRoomStatus = document.getElementById("chatRoomStatus");
const chatTyping = document.getElementById("chatTyping");

    // Ad card DOM
const chatAdCard   = document.getElementById("chatAdCard");
const chatAdImg    = document.getElementById("chatAdImg");
const chatAdTitle  = document.getElementById("chatAdTitle");
const chatAdPrice  = document.getElementById("chatAdPrice");
const chatAdCity   = document.getElementById("chatAdCity");
const chatAdOpenBtn = document.getElementById("chatAdOpenBtn");
const chatAttachBtn = document.getElementById("chatAttachBtn");
const chatFileInput = document.getElementById("chatFileInput");

    // ===== CHAT FULLSCREEN ROOM (only for –ø–µ—Ä–µ–ø–∏—Å–∫–∞) =====
function openChatRoomFullscreen(){
  document.body.classList.add("chat-room-open");

  // –ø—Ä—è—á–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É
  if (chatThreadsView) chatThreadsView.classList.remove("active");
  if (chatRoomView) chatRoomView.classList.add("active");

  // –Ω–∞ –≤—Å—è–∫–∏–π: –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é —Å–∫—Ä—ã–≤–∞–µ–º
  if (bottomNav) bottomNav.classList.add("nav-hidden");

  // —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
  requestAnimationFrame(() => {
    if (chatMessagesEl) chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  });
}

function closeChatRoomFullscreen(){
  document.body.classList.remove("chat-room-open");

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤, –ø—Ä—è—á–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É
  if (chatRoomView) chatRoomView.classList.remove("active");
  if (chatThreadsView) chatThreadsView.classList.add("active");

  // –≤–µ—Ä–Ω—É—Ç—å –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é (–µ—Å–ª–∏ –º—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ chat)
  if (currentScreen === "chat" && bottomNav) bottomNav.classList.remove("nav-hidden");
}

// Back –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ
if (chatRoomBackBtn && !chatRoomBackBtn.dataset.bound) {
  chatRoomBackBtn.dataset.bound = "1";
  chatRoomBackBtn.addEventListener("click", (e) => {
    e.preventDefault();
    closeChatRoomFullscreen();
  });
}
    
// Sheet
const chatRoomSheetBackdrop = document.getElementById("chatRoomSheetBackdrop");
const chatRoomSheetTitle = document.getElementById("chatRoomSheetTitle");
const chatRoomSheetCancel = document.getElementById("chatRoomSheetCancel");
const chatActionPin = document.getElementById("chatActionPin");
const chatActionMute = document.getElementById("chatActionMute");
const chatActionClear = document.getElementById("chatActionClear");
const chatActionDelete = document.getElementById("chatActionDelete");
const chatActionReport = document.getElementById("chatActionReport");

    // Bottom nav
    const navButtons        = document.querySelectorAll(".nav-btn");
    const navAddBtn = document.getElementById("navAddBtn");
    const bottomNav = document.querySelector(".bottom-nav");

    const screenBlocks = document.getElementById("screen-blocks");
    const settingsBlocksRow = document.getElementById("settingsBlocksRow");

    const blocksTabs = document.getElementById("blocksTabs");
    const blockedAdsBox = document.getElementById("blockedAdsBox");
    const blockedShopsBox = document.getElementById("blockedShopsBox");

    const blockedAdsList = document.getElementById("blockedAdsList");
    const blockedShopsList = document.getElementById("blockedShopsList");

    const unblockAllBtn = document.getElementById("unblockAllBtn");
    
    // ================== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ==================
    let allAds        = [];
    let filteredAds   = [];
    let favoritesSet  = loadFavoritesFromStorage();
    let historyArray  = loadHistoryFromStorage();
    let currentAd     = null;
    let currentScreen = "home";

    // ===== GLOBAL BACK NAV =====
    const navStack = [];
    let backBtnEl = null;

    function ensureGlobalBackButton() {
      const headerLeft = document.querySelector(".app-header-left");
      if (!headerLeft) return;
      if (backBtnEl) return;

      backBtnEl = document.createElement("button");
      backBtnEl.className = "ios-back-btn";
      backBtnEl.type = "button";
      backBtnEl.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15.5 5.5a1 1 0 0 1 0 1.4L10.4 12l5.1 5.1a1 1 0 1 1-1.4 1.4l-5.8-5.8a1 1 0 0 1 0-1.4l5.8-5.8a1 1 0 0 1 1.4 0z"/>
        </svg>
      `;
      headerLeft.prepend(backBtnEl);

      backBtnEl.addEventListener("click", () => {
        if (!navStack.length) return;

        if (screensContainer) {
          screensContainer.classList.add("ios-back-anim");
          setTimeout(() => screensContainer.classList.remove("ios-back-anim"), 230);
        }
        const prev = navStack.pop();
        showScreen(prev, { push: false });
      });
    }

    function updateBackButtonVisibility() {
      if (!backBtnEl) return;
      backBtnEl.style.display = navStack.length ? "inline-flex" : "none";
    }

    // Hide header
    const appHeader = document.querySelector(".app-header");
    let lastScrollTop = 0;

    function setHeaderHidden(hidden){
      if (!appHeader) return;
      appHeader.classList.toggle("header-hidden", !!hidden);
    }

    if (screensContainer) {
      screensContainer.addEventListener("scroll", () => {
        if (!appHeader) return;
        const st = screensContainer.scrollTop;

        if (st <= 5) {
          setHeaderHidden(false);
          lastScrollTop = st;
          return;
        }

        const delta = st - lastScrollTop;
        if (Math.abs(delta) < 6) return;

        setHeaderHidden(delta > 0);
        lastScrollTop = st;
      }, { passive: true });
    }

    // ===== APP INSETS (header + bottom nav heights) =====
function setAppInsetsVars(){
  try{
    const hh = appHeader ? Math.round(appHeader.getBoundingClientRect().height) : 0;
    const nh = bottomNav ? Math.round(bottomNav.getBoundingClientRect().height) : 0;

    document.documentElement.style.setProperty("--app-header-h", hh + "px");
    document.documentElement.style.setProperty("--bottom-nav-h", nh + "px");
  } catch {}
}

setAppInsetsVars();
window.addEventListener("resize", setAppInsetsVars);
    
    // lightbox
    let lightboxImages = [];
    let lightboxIndex  = 0;

    // infinite scroll
    let feedRenderedCount = 0;

    // new ad draft
    let newAdDraft = {
      city: "Toshkent",
      category: "Transport",
      title: "",
      price: "",
      description: "",
      photos: []
    };

    // chat
    let chatHistory = [];

    // filters
    const filterState = {
      type: "all",
      city: "all",
      currency: "sum",
      onlyWithPhoto: false,
      sort: "default",
      category: "all"
    };

    // ====== SHOP ADS FILTER SHEET ======
    function openShopAdsFilterSheet() {
      if (!shopAdsFilterSheet) return;
      shopAdsFilterSheet.classList.add("active");
      document.body.classList.add("sheet-open");
    }
    function closeShopAdsFilterSheet() {
      if (!shopAdsFilterSheet) return;
      shopAdsFilterSheet.classList.remove("active");
      document.body.classList.remove("sheet-open");
    }
    function syncShopAdsFilterUI() {
      if (shopAdsSort) shopAdsSort.value = shopAdsFilterState.sort;
      if (shopAdsMinPrice) shopAdsMinPrice.value = shopAdsFilterState.minPrice;
      if (shopAdsMaxPrice) shopAdsMaxPrice.value = shopAdsFilterState.maxPrice;
      if (shopAdsOnlyPhotoBtn) {
        shopAdsOnlyPhotoBtn.classList.toggle("chip-filled", shopAdsFilterState.onlyWithPhoto);
      }
    }

    if (shopAdsFilterBtn) {
      shopAdsFilterBtn.addEventListener("click", () => {
        syncShopAdsFilterUI();
        openShopAdsFilterSheet();
      });
    }
    if (shopViewAdsFilterBtn) {
      shopViewAdsFilterBtn.addEventListener("click", () => {
        syncShopAdsFilterUI();
        openShopAdsFilterSheet();
      });
    }

    if (shopAdsFilterSheet) {
      shopAdsFilterSheet.addEventListener("click", (e) => {
        if (e.target === shopAdsFilterSheet) closeShopAdsFilterSheet();
      });
      const inner = shopAdsFilterSheet.querySelector(".store-sheet");
      if (inner) inner.addEventListener("click", (e) => e.stopPropagation());
    }

    if (shopAdsOnlyPhotoBtn) {
      shopAdsOnlyPhotoBtn.addEventListener("click", () => {
        shopAdsFilterState.onlyWithPhoto = !shopAdsFilterState.onlyWithPhoto;
        syncShopAdsFilterUI();
      });
    }

    function rerenderShopAdsForCurrentScreen(){
      if (currentScreen === "myShop") renderMyShopAds();
      if (currentScreen === "shopView") renderShopViewAds();
    }

    if (shopAdsApplyBtn) {
      shopAdsApplyBtn.addEventListener("click", () => {
        shopAdsFilterState.sort = (shopAdsSort?.value || "new");
        shopAdsFilterState.minPrice = (shopAdsMinPrice?.value || "").trim();
        shopAdsFilterState.maxPrice = (shopAdsMaxPrice?.value || "").trim();
        closeShopAdsFilterSheet();
        rerenderShopAdsForCurrentScreen();
      });
    }

    if (shopAdsResetBtn) {
      shopAdsResetBtn.addEventListener("click", () => {
        shopAdsFilterState.sort = "new";
        shopAdsFilterState.minPrice = "";
        shopAdsFilterState.maxPrice = "";
        shopAdsFilterState.onlyWithPhoto = false;

        if (shopAdsSearchInput) shopAdsSearchInput.value = "";
        syncShopAdsFilterUI();
        rerenderShopAdsForCurrentScreen();
        closeShopAdsFilterSheet();
      });
    }

    if (shopAdsSearchInput) {
      shopAdsSearchInput.addEventListener("input", () => {
        if (currentScreen === "myShop") renderMyShopAds();
      });
    }

    // ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ==================
    function formatNumberWithSpaces(num) {
      const s = String(num);
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function getAdCategory(ad) {
      return String(ad?.category || ad?.type || "Boshqa").trim();
    }
    function formatInputNumberSpaces(value) {
      const digits = String(value || "").replace(/\D/g, "");
      return digits.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function setCaretByDigits(el, digitsPos) {
      const str = el.value;
      let digitsSeen = 0;
      for (let i = 0; i <= str.length; i++) {
        if (i === str.length) { el.setSelectionRange(i, i); return; }
        if (/\d/.test(str[i])) digitsSeen++;
        if (digitsSeen >= digitsPos) { el.setSelectionRange(i + 1, i + 1); return; }
      }
    }

    if (inputPrice) {
      inputPrice.addEventListener("input", () => {
        const el = inputPrice;
        const caret = el.selectionStart || 0;
        const leftPart = el.value.slice(0, caret);
        const digitsPos = leftPart.replace(/\D/g, "").length;

        const formatted = formatInputNumberSpaces(el.value);
        el.value = formatted;
        setCaretByDigits(el, digitsPos);
      });
    }

    function formatPrice(price) {
      if (price === null || price === undefined || price === "") return "Narx kelishiladi";
      const p = Number(price || 0);
      if (!isFinite(p) || p <= 0) return "Narx kelishiladi";
      if (filterState.currency === "usd") {
        const usd = p / EXCHANGE_RATE;
        const rounded = Math.round(usd * 100) / 100;
        return formatNumberWithSpaces(rounded) + " USD";
      }
      return formatNumberWithSpaces(p) + " so‚Äòm";
    }

    function formatDateShort(iso) {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${dd}.${mm}`;
      } catch { return ""; }
    }

    // ================== PROFILIM (localStorage, ready for DB) ==================
function loadProfileFromStorage(){
  try{
    const raw = localStorage.getItem(PROFILE_KEY);
    if (raw) return JSON.parse(raw);
  }catch(e){}
  return {
    phone: "",
    email: "",
    emailVerified: false,
    passwordHash: "" // demo flag, later real hash in DB
  };
}
function saveProfileToStorage(profile){
  try{ localStorage.setItem(PROFILE_KEY, JSON.stringify(profile)); } catch {}
}
let profileState = loadProfileFromStorage();

function renderProfileEditValues(){
  if (profilePhoneValue) profilePhoneValue.textContent = profileState.phone || "‚Äî";
  if (profileEmailValue) {
    const emailTxt = profileState.email || "‚Äî";
    const badge = profileState.email
      ? (profileState.emailVerified ? " ‚úÖ" : " (tasdiqlanmagan)")
      : "";
    profileEmailValue.textContent = emailTxt + badge;
  }
}

// ----- Sheet open/close -----
function openProfileSheet(title, html, onSave){
  if (!profileEditSheet || !profileEditBackdrop) return;

  if (profileEditTitle) profileEditTitle.textContent = title;
  if (profileEditBody)  profileEditBody.innerHTML = html;

  profileEditSheet.classList.remove("hidden");
  profileEditBackdrop.classList.remove("hidden");

  // ‚úÖ –í–û–¢ –≠–¢–û –î–û–ë–ê–í–¨
  document.body.classList.add("sheet-open");

  // store callback
  if (profileEditSave) profileEditSave._onSave = onSave;
}

function closeProfileSheet(){
  if (!profileEditSheet || !profileEditBackdrop) return;

  profileEditSheet.classList.add("hidden");
  profileEditBackdrop.classList.add("hidden");

  // ‚úÖ –ò –í–û–¢ –≠–¢–û –î–û–ë–ê–í–¨
  document.body.classList.remove("sheet-open");

  if (profileEditSave) profileEditSave._onSave = null;
}

if (profileEditBackdrop && !profileEditBackdrop.dataset.bound) {
  profileEditBackdrop.dataset.bound = "1";
  profileEditBackdrop.addEventListener("click", closeProfileSheet);
}
if (profileEditCancel && !profileEditCancel.dataset.bound) {
  profileEditCancel.dataset.bound = "1";
  profileEditCancel.addEventListener("click", closeProfileSheet);
}
if (profileEditSave && !profileEditSave.dataset.bound) {
  profileEditSave.dataset.bound = "1";
  profileEditSave.addEventListener("click", () => {
    if (typeof profileEditSave._onSave === "function") profileEditSave._onSave();
  });
}
// ================== /PROFILIM ==================
    
    function loadFavoritesFromStorage() {
      try {
        const raw = localStorage.getItem(FAVORITES_KEY);
        if (!raw) return new Set();
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? new Set(arr) : new Set();
      } catch { return new Set(); }
    }
    function saveFavoritesToStorage() {
      try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(Array.from(favoritesSet))); } catch {}
    }

    function loadShopFavoritesFromStorage(){
  try{
    const raw = localStorage.getItem(SHOP_FAVORITES_KEY);
    if (!raw) return new Set();
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? new Set(arr) : new Set();
  } catch { return new Set(); }
}

function saveShopFavoritesToStorage(set){
  try{
    localStorage.setItem(SHOP_FAVORITES_KEY, JSON.stringify(Array.from(set)));
  } catch {}
}

function isShopFav(shopId){
  return loadShopFavoritesFromStorage().has(shopId);
}

function toggleShopFav(shopId){
  const set = loadShopFavoritesFromStorage();
  const on = set.has(shopId) ? (set.delete(shopId), false) : (set.add(shopId), true);
  saveShopFavoritesToStorage(set);
  return on;
}
    
    function loadHistoryFromStorage() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveHistoryToStorage() {
      try { localStorage.setItem(HISTORY_KEY, JSON.stringify(historyArray)); } catch {}
    }

    let toastTimeout = null;
    function showToast(mainText = "E‚Äôlon yuqoriga ko‚Äòtarildi!", subText = "Endi odamlarga ko‚Äòproq ko‚Äòrinadi") {
      if (!toastEl) return;
      const mainEl = toastEl.querySelector(".toast-text-main");
      const subEl  = toastEl.querySelector(".toast-text-sub");
      if (mainEl) mainEl.textContent = mainText;
      if (subEl)  subEl.textContent  = subText;

      toastEl.classList.add("show");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toastEl.classList.remove("show"), 3000);
    }

    function createAdCard(ad) {
      const card = document.createElement("div");
      card.className = "ad-card";

      const title  = ad.title || "E‚Äôlon";
      const city   = ad.city || "Shahar";
      const category = getAdCategory(ad);
      const price  = formatPrice(ad.price);
      const date   = formatDateShort(ad.created_at);
      const image  = ad.images && ad.images.length ? ad.images[0] : null;

      card.innerHTML = `
        <div class="ad-image" style="${image ? `background-image:url('${image}');` : ""}"></div>
        <div class="ad-content">
          <div class="ad-title">${title}</div>
          <div class="ad-meta">üìç ${city} ¬∑ ${category}${date ? " ¬∑ " + date : ""}</div>
          <div class="ad-price">${price}</div>
        </div>
      `;

      card.addEventListener("click", () => openAdDetails(ad));
      return card;
    }

      function createHistoryCard(item) {
      const ad = allAds.find(a => a.id === item.id);
      if (!ad) return null;
      if (isAdBlocked(ad.id)) return null;
      return createAdCard(ad);
    }

    function applyAllFilters() {
      if (!allAds.length) { filteredAds = []; return; }
      const q = (searchInput?.value || "").toLowerCase().trim();

      filteredAds = allAds.filter(ad => {
                // ‚ùå blocked ads ‚Äì hide from feed
        if (isAdBlocked(ad.id)) return false;
        if (filterState.category !== "all") {
          if (getAdCategory(ad) !== filterState.category) return false;
        }
        if (filterState.city !== "all") {
          if ((ad.city || "").trim() !== filterState.city) return false;
        }
        if (filterState.onlyWithPhoto) {
          if (!ad.images || !Array.isArray(ad.images) || !ad.images.length) return false;
        }
        if (q) {
          const text = (ad.title || "") + " " + (ad.description || "");
          if (!text.toLowerCase().includes(q)) return false;
        }
        return true;
      });

      filteredAds.sort((a, b) => {
        const pa = Number(a.price || 0);
        const pb = Number(b.price || 0);
        const da = a.created_at ? new Date(a.created_at).getTime() : 0;
        const db = b.created_at ? new Date(b.created_at).getTime() : 0;

        switch (filterState.sort) {
          case "cheap":      return pa - pb;
          case "expensive":  return pb - pa;
          case "date":
          case "default":
          default:           return db - da;
        }
      });
    }

    function resetFeedRender() {
      if (!feedList) return;
      feedList.innerHTML = "";
      feedRenderedCount = 0;
      appendMoreToFeed();
    }

    function appendMoreToFeed() {
      if (!feedList) return;
      const start = feedRenderedCount;
      const end   = Math.min(filteredAds.length, start + FEED_CHUNK_SIZE);

      if (start >= end) {
        if (!filteredAds.length && !feedRenderedCount) {
          feedList.innerHTML = "<div class='ad-meta'>E‚Äôlonlar topilmadi</div>";
        }
        return;
      }

      for (let i = start; i < end; i++) {
        feedList.appendChild(createAdCard(filteredAds[i]));
      }
      feedRenderedCount = end;
    }

    function renderFavorites() {
  if (!favoritesList) return;
  favoritesList.innerHTML = "";

  // --- ADS ---
  removeBlockedFromFavorites();
  const adIds = Array.from(favoritesSet);
  const favAds = allAds.filter(ad => adIds.includes(ad.id) && !isAdBlocked(ad.id));

  // --- SHOPS ---
  const shopFavSet = loadShopFavoritesFromStorage();
  const favShops = (shopsData || []).filter(s => shopFavSet.has(s.id) && !getBlockedSet().has(s.id));

  if (!favAds.length && !favShops.length) {
    favoritesList.innerHTML = "<div class='ad-meta'>Izbranlar hozircha bo‚Äòsh</div>";
    return;
  }

  // 1) –º–∞–≥–∞–∑–∏–Ω—ã —Å–≤–µ—Ä—Ö—É
  if (favShops.length) {
    const h = document.createElement("div");
    h.className = "section-title";
    h.textContent = "Do‚Äòkonlar";
    favoritesList.appendChild(h);

    favShops.forEach(shop => {
      favoritesList.appendChild(shopCard(shop)); // –∫–ª–∏–∫–∞–µ—Ç—Å—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç shopView
    });
  }

  // 2) –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∏–∂–µ
  if (favAds.length) {
    const h2 = document.createElement("div");
    h2.className = "section-title";
    h2.textContent = "E‚Äôlonlar";
    favoritesList.appendChild(h2);

    favAds.forEach(ad => favoritesList.appendChild(createAdCard(ad)));
  }
}

    function renderHistory() {
      if (!historyListEl) return;
      historyListEl.innerHTML = "";
      if (!historyArray.length) {
        historyListEl.innerHTML = "<div class='ad-meta'>Tarix bo‚Äòsh</div>";
        return;
      }
      const sorted = [...historyArray].sort((a,b)=>b.ts - a.ts);
      sorted.forEach(item => {
        const card = createHistoryCard(item);
        if (card) historyListEl.appendChild(card);
      });
    }

    function renderMyAds() {
      if (!myAdsList) return;
      myAdsList.innerHTML = "";

      const myPhone = DEFAULT_PHONE.replace(/\s+/g, "");
      const myTg    = DEFAULT_TELEGRAM.replace(/^@/, "").toLowerCase();

      const myAds = allAds.filter(ad => {
        const adPhone = (ad.phone || "").replace(/\s+/g, "");
        const adTg    = (ad.telegram || "").replace(/^@/, "").toLowerCase();
        return (adPhone && adPhone === myPhone) || (adTg && adTg === myTg);
      });

      if (!myAds.length) {
        myAdsList.innerHTML = "<div class='ad-meta'>Hozircha sizning e‚Äôlonlaringiz yo‚Äòq</div>";
        return;
      }
      myAds.forEach(ad => myAdsList.appendChild(createAdCard(ad)));
    }

    async function loadAds() {
      try {
        const res = await fetch(ADS_API_URL);
        if (!res.ok) throw new Error("Bad response");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("Not array");

        allAds = data;
        window.__getAllAds = () => allAds; // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
        applyAllFilters();
        resetFeedRender();
        renderFavorites();
        updateAdminPanel();
      } catch (e) {
        console.error("Error loadAds:", e);
        if (feedList) feedList.innerHTML = "<div class='ad-meta'>E‚Äôlonlarni yuklashda xatolik</div>";
      }
    }

    // ================== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í ==================
    const screens = {
      home: screenHome,
      favorites: screenFavorites,
      filters: screenFilters,
      adDetails: screenAdDetails,
      profile: screenProfile,
      promo: screenPromo,
      history: screenHistory,
      admin: screenAdmin,
      newAd1: screenNewAd1,
      newAd2: screenNewAd2,
      newAd3: screenNewAd3,
      newAdSuccess: screenNewAdSuccess,
      shops: screenShops,
      language: screenLanguage,
      myAds: screenMyAds,
      business: screenBusiness,
      myShop: screenMyShop,
      shopView: screenShopView,
      blocks: screenBlocks,
      profileEdit: screenProfileEdit,
      chatList: screenChat,  // —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–º–µ–Ω—é –≤–∏–¥–Ω–æ)
      chat: screenChat,      // –ø–µ—Ä–µ–ø–∏—Å–∫–∞ (–º–µ–Ω—é —Å–∫—Ä—ã—Ç–æ)
    };

    function showScreen(name, opts = {}) {
      ensureGlobalBackButton();

      const push = opts.push !== false;
      const resetStack = opts.resetStack === true;

      if (resetStack) navStack.length = 0;

      if (push && currentScreen && currentScreen !== name) {
        navStack.push(currentScreen);
      }

      const hideNavScreens = new Set(["newAd1","newAd2","newAd3","newAdSuccess","chat"]);
if (bottomNav) bottomNav.classList.toggle("nav-hidden", hideNavScreens.has(name));
      
      currentScreen = name;

      Object.values(screens).forEach(el => {
        if (!el) return;
        el.classList.remove("active");
        el.style.display = "none";
      });

      const target = screens[name];
      if (target) {
        target.classList.add("active");
        target.style.display = "block";
      }

      if (name === "home") popPlusBtn();

      navButtons.forEach(btn => {
        const s = btn.getAttribute("data-screen");
        btn.classList.toggle("active", s === name);
      });

      if (settingsBlocksRow) {
  settingsBlocksRow.addEventListener("click", () => showScreen("blocks"));
}
      if (name === "blocks") {
  setBlocksTab(blocksTab || "ads");
}
      if (screensContainer) screensContainer.scrollTop = 0;

      if (name === "favorites") renderFavorites();
      if (name === "history")   renderHistory();
      if (name === "filters")   syncFiltersUIFromState();
      if (name === "home") {
  setActiveHomeCategory(filterState.category === "all" ? null : filterState.category);
  resetFeedRender();
}
      
      if (name === "myAds")     renderMyAds();
      if (name === "shopView")  renderShopView();
      if (name === "myShop") {  renderMyShopAds();
  if (myShop?.id) setSubscribeUI(storeSubscribeBtn, myShop.id, { mode:"short" });
}

      if (name === "shops") {
  renderShopCategoryChips();
  syncShopsFilterUI();
  ensureShopsLoaded().then(() => renderShops());
}

      updateBackButtonVisibility();
    }
      if (name === "profileEdit") renderProfileEditValues(); 
    
    function popPlusBtn() {
  const addBtn = document.getElementById("navAddBtn");
  if (!addBtn) return;

  // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
  addBtn.style.animation = "none";
  void addBtn.offsetWidth;
  addBtn.style.animation = "navAddPop .45s cubic-bezier(.2,.9,.2,1) both";
}
      
    // ===== Shop View =====
    let currentShop = null;

    function starsText(rating){
      const r = Math.max(0, Math.min(5, Number(rating||0)));
      const full = Math.round(r);
      return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0, full) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0, 5-full);
    }

    function getShopAds(shop){
      if (!shop) return [];
      const ownerTg = String(shop.ownerTelegram||"").replace(/^@/,"").toLowerCase();
      const ownerPhone = String(shop.ownerPhone||"").replace(/\s+/g,"");

      return allAds.filter(ad => {
        const adTg = String(ad.telegram||"").replace(/^@/,"").toLowerCase();
        const adPhone = String(ad.phone||"").replace(/\s+/g,"");
        if (ownerTg && adTg && adTg === ownerTg) return true;
        if (ownerPhone && adPhone && adPhone === ownerPhone) return true;
        return false;
      });
    }

    function openShop(shop){
      currentShop = shop;
      showScreen("shopView");
    }

    function renderShopView(){
      if (!currentShop) return;

      const isVirtualUser = !!currentShop._virtual === true; // –ø—Ä–∏–∑–Ω–∞–∫ "–æ–±—ã—á–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü"
      
      if (shopViewName) shopViewName.textContent = currentShop.name || "Do‚Äòkon";

      const badge = document.getElementById("shopViewBadge");
if (badge) {
  if (isVirtualUser) {
    badge.style.display = "inline-flex";
    badge.className = "shop-badge is-user";
    badge.textContent = "üë§ Oddiy sotuvchi (do‚Äòkon emas)";
  } else {
    badge.style.display = "inline-flex";
    badge.className = "shop-badge is-shop";
    badge.textContent = "üè™ Do‚Äòkon";
  }
}
      
      if (shopViewSubs) shopViewSubs.textContent = `${currentShop.subs || 0} obunachi`;

      if (shopViewStars) shopViewStars.textContent = starsText(currentShop.rating);
      if (shopViewRating) shopViewRating.textContent = `${currentShop.rating || 0} (${currentShop.reviews || 0} baho)`;

      // —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const hideEls = [shopViewSubs, shopViewStars, shopViewRating].filter(Boolean);

hideEls.forEach(el => {
  if (isVirtualUser) el.classList.add("shopview-hide-for-user");
  else el.classList.remove("shopview-hide-for-user");
});
      
      if (shopViewCity) shopViewCity.textContent = currentShop.city || "Shahar";

      const tg = String(currentShop.ownerTelegram || "").replace(/^@/,"");
      if (shopViewTg) {
        shopViewTg.textContent = "@" + (tg || "shop");
        shopViewTg.href = tg ? ("https://t.me/" + tg) : "#";
      }

      const phone = String(currentShop.ownerPhone || "").trim();
      if (shopViewPhone && shopViewPhoneText) {
        if (phone) {
          shopViewPhone.style.display = "inline";
          shopViewPhoneText.style.display = "none";
          shopViewPhone.textContent = phone;
          shopViewPhone.href = "tel:" + phone.replace(/\s+/g,"");
        } else {
          shopViewPhone.style.display = "none";
          shopViewPhoneText.style.display = "inline";
          shopViewPhoneText.textContent = "Telefon yo‚Äòq";
        }
      }

      if (shopViewAvatar) shopViewAvatar.textContent = getInitials(currentShop.name);

      renderShopViewAds();
      setSubscribeUI(shopViewSubBtn, currentShop.id, { mode: "default" });
    }

    function renderShopViewAds(){
      if (!shopViewAdsList) return;
      shopViewAdsList.innerHTML = "";

      const q = (shopViewAdsSearchInput?.value || "").toLowerCase().trim();
      const ads = getShopAds(currentShop);

      let result = ads.filter(ad => {
       if (isAdBlocked(ad.id)) return false;
        if (shopAdsFilterState.onlyWithPhoto) {
          if (!ad.images || !Array.isArray(ad.images) || !ad.images.length) return false;
        }

        const p = Number(ad.price || 0);
        const min = Number(shopAdsFilterState.minPrice || 0);
        const max = Number(shopAdsFilterState.maxPrice || 0);

        if (shopAdsFilterState.minPrice && isFinite(min) && p < min) return false;
        if (shopAdsFilterState.maxPrice && isFinite(max) && p > max) return false;

        if (q) {
          const text = ((ad.title || "") + " " + (ad.description || "")).toLowerCase();
          if (!text.includes(q)) return false;
        }
        return true;
      });

      result.sort((a,b) => {
        const pa = Number(a.price || 0);
        const pb = Number(b.price || 0);
        const da = a.created_at ? new Date(a.created_at).getTime() : 0;
        const db = b.created_at ? new Date(b.created_at).getTime() : 0;

        if (shopAdsFilterState.sort === "cheap") return pa - pb;
        if (shopAdsFilterState.sort === "expensive") return pb - pa;
        return db - da;
      });

      if (!result.length) {
        shopViewAdsList.innerHTML = "<div class='ad-meta'>Bu do‚Äòkonda e‚Äôlonlar yo‚Äòq</div>";
        return;
      }
      result.forEach(ad => shopViewAdsList.appendChild(createAdCard(ad)));
    }

    if (shopViewMsgBtn) shopViewMsgBtn.addEventListener("click", () => showScreen("chat"));
    if (shopViewAdsSearchInput) shopViewAdsSearchInput.addEventListener("input", renderShopViewAds);

    // bottom nav
    navButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    let target = btn.getAttribute("data-screen");
    if (!target) return;

    // –µ—Å–ª–∏ –º—ã —É–∂–µ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    if (document.body.classList.contains("chat-room-open")) return;

    // –≤–∫–ª–∞–¥–∫–∞ Chat –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
    if (target === "chat") {
      showScreen("chatList", { push: false, resetStack: false });
      // –∏ –Ω–∞ –≤—Å—è–∫–∏–π: —É–±–∏—Ä–∞–µ–º —Ä–µ–∂–∏–º –∫–æ–º–Ω–∞—Ç—ã
      document.body.classList.remove("chat-room-open");
      return;
    }

    showScreen(target, { push: false, resetStack: true });
  });
});

    if (navAddBtn && !navAddBtn.dataset.bound) {
  navAddBtn.dataset.bound = "1";
  navAddBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    showScreen("newAd1", { push: true });
  });
}

    // infinite scroll on home
    if (screensContainer) {
      screensContainer.addEventListener("scroll", () => {
        if (currentScreen !== "home") return;
        const nearBottom =
          screensContainer.scrollTop + screensContainer.clientHeight >=
          screensContainer.scrollHeight - 80;
        if (nearBottom) appendMoreToFeed();
      });
    }

    // search
    if (searchInput) {
      searchInput.addEventListener("input", () => {
        applyAllFilters();
        resetFeedRender();
      });
    }

    if (btnSearchFake && !btnSearchFake.dataset.bound) {
  btnSearchFake.dataset.bound = "1";

  btnSearchFake.addEventListener("click", () => {
    // 1) —Å–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    if (searchInput) searchInput.blur();

    // 2) –Ω–∞ –≤—Å—è–∫–∏–π: —Å–∫—Ä–æ–ª–ª —á—É—Ç—å –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "–∑–∞–ª–∏–ø–∞–Ω–∏—è"
    if (screensContainer) {
      // –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ –Ω–∞ iOS
      setTimeout(() => { screensContainer.scrollTop = 0; }, 0);
    }
  });
}

    // ================== –§–ò–õ–¨–¢–†–´ ==================
    function syncFiltersUIFromState() {
      if (filterTypeRow) {
        filterTypeRow.querySelectorAll(".chip").forEach(ch => {
          const t = ch.getAttribute("data-type") || "all";
          ch.classList.toggle("chip-filled", t === filterState.type);
        });
      }
      if (filterCitySelect) filterCitySelect.value = filterState.city === "all" ? "all" : filterState.city;

      if (filterCurrencyRow) {
        filterCurrencyRow.querySelectorAll(".chip").forEach(ch => {
          const c = ch.getAttribute("data-currency") || "sum";
          ch.classList.toggle("chip-filled", c === filterState.currency);
        });
      }
      if (filterPhotoChip) filterPhotoChip.classList.toggle("chip-filled", filterState.onlyWithPhoto);
      if (filterSortSelect) filterSortSelect.value = filterState.sort;

      if (filterCategoryRow) {
        filterCategoryRow.querySelectorAll(".chip").forEach(ch => {
          const c = ch.getAttribute("data-category") || "all";
          ch.classList.toggle("chip-filled", c === filterState.category);
        });
      }
    }

    function readFiltersFromUI() {
      if (filterTypeRow) {
        const active = filterTypeRow.querySelector(".chip-filled");
        filterState.type = active ? active.getAttribute("data-type") || "all" : "all";
      }
      if (filterCategoryRow) {
        const active = filterCategoryRow.querySelector(".chip-filled");
        filterState.category = active ? active.getAttribute("data-category") || "all" : "all";
      }
      if (filterCitySelect) {
        const v = filterCitySelect.value;
        filterState.city = v === "all" ? "all" : v;
      }
      if (filterCurrencyRow) {
        const active = filterCurrencyRow.querySelector(".chip-filled");
        filterState.currency = active ? active.getAttribute("data-currency") || "sum" : "sum";
      }
      if (filterPhotoChip) filterState.onlyWithPhoto = filterPhotoChip.classList.contains("chip-filled");
      if (filterSortSelect) filterState.sort = filterSortSelect.value || "default";
    }

    if (filterTypeRow) {
      filterTypeRow.addEventListener("click", e => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        filterTypeRow.querySelectorAll(".chip").forEach(c => c.classList.remove("chip-filled"));
        chip.classList.add("chip-filled");
      });
    }

    if (filterCategoryRow) {
      filterCategoryRow.addEventListener("click", e => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        filterCategoryRow.querySelectorAll(".chip").forEach(c => c.classList.remove("chip-filled"));
        chip.classList.add("chip-filled");
      });
    }

    if (filterCurrencyRow) {
      filterCurrencyRow.addEventListener("click", e => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        filterCurrencyRow.querySelectorAll(".chip").forEach(c => c.classList.remove("chip-filled"));
        chip.classList.add("chip-filled");
      });
    }

    if (filterPhotoChip) {
      filterPhotoChip.addEventListener("click", () => filterPhotoChip.classList.toggle("chip-filled"));
    }

    if (openFiltersBtn) openFiltersBtn.addEventListener("click", () => showScreen("filters"));

    if (filtersApplyBtn) {
      filtersApplyBtn.addEventListener("click", () => {
        readFiltersFromUI();
        applyAllFilters();
        resetFeedRender();
        showScreen("home");
      });
    }

    if (filtersResetBtn) {
      filtersResetBtn.addEventListener("click", () => {
        filterState.type         = "all";
        filterState.city         = "all";
        filterState.currency     = "sum";
        filterState.onlyWithPhoto= false;
        filterState.sort         = "default";
        filterState.category     = "all";
        syncFiltersUIFromState();
        applyAllFilters();
        resetFeedRender();
      });
    }

    if (filtersBackBtn) filtersBackBtn.addEventListener("click", () => showScreen("home"));

    // ================== –ù–û–í–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è) ==================
    if (btnOpenNewAd) btnOpenNewAd.addEventListener("click", () => showScreen("newAd1"));
    if (backFromNewAd1) backFromNewAd1.addEventListener("click", () => showScreen("home"));
    if (backFromNewAd2) backFromNewAd2.addEventListener("click", () => showScreen("newAd1"));
    if (backFromNewAd3) backFromNewAd3.addEventListener("click", () => showScreen("newAd2"));
    if (btnGoHome) btnGoHome.addEventListener("click", () => showScreen("home"));

    if (btnNewAdStep1Next) {
      btnNewAdStep1Next.addEventListener("click", () => {
        const title = (inputTitle?.value || "").trim();
        const price = (inputPrice?.value || "").trim();
        const desc  = (inputDescription?.value || "").trim();

        if (!title) return alert("Sarlavha kiriting");
        if (!price) return alert("Narx kiriting");

        newAdDraft.city        = inputCity?.value || "Toshkent";
        newAdDraft.category    = inputCategory ? inputCategory.value : "Boshqa";
        newAdDraft.title       = title;
        newAdDraft.price       = price.replace(/\s+/g, "");
        newAdDraft.description = desc || "Tavsif berilmagan";

        showScreen("newAd2");
      });
    }

    if (btnUploadPhotos && inputPhotos) {
      btnUploadPhotos.addEventListener("click", () => inputPhotos.click());

      inputPhotos.addEventListener("change", async () => {
        const files = Array.from(inputPhotos.files || []);
        if (photosPreview) photosPreview.innerHTML = "";
        newAdDraft.photos = [];
        if (!files.length) return;

        const max = 8;
        const selected = files.slice(0, max);

        for (const file of selected) {
          const reader = new FileReader();
          reader.onload = e => {
            if (!photosPreview) return;
            const div = document.createElement("div");
            div.className = "photo-thumb";
            const img = document.createElement("img");
            img.src = e.target.result;
            div.appendChild(img);
            photosPreview.appendChild(div);
          };
          reader.readAsDataURL(file);

          try {
            const url = await uploadToImgbb(file);
            newAdDraft.photos.push(url);
          } catch (e) {
            console.error("ImgBB error:", e);
          }
        }
      });
    }

    async function uploadToImgbb(file) {
      const formData = new FormData();
      formData.append("key", IMGBB_API_KEY);
      formData.append("image", file);

      const res = await fetch(IMGBB_UPLOAD_URL, { method: "POST", body: formData });
      if (!res.ok) throw new Error("upload_failed");
      const json = await res.json();
      if (!json.success || !json.data || !json.data.url) throw new Error("bad_response");
      return json.data.url;
    }

    if (btnNewAdStep2Next) btnNewAdStep2Next.addEventListener("click", () => { fillSummary(); showScreen("newAd3"); });

    function fillSummary() {
      if (summaryTitle) summaryTitle.textContent = newAdDraft.title;
      if (summaryCityType) summaryCityType.textContent = `${newAdDraft.city} ¬∑ ${newAdDraft.category}`;
      if (summaryPrice) summaryPrice.textContent = formatPrice(newAdDraft.price);
      if (summaryDescription) summaryDescription.textContent = newAdDraft.description;
      if (summaryPhotosInfo) summaryPhotosInfo.textContent = "Rasmlar: " + (newAdDraft.photos.length || 0) + " ta";
    }

    if (btnPublishAd) {
      btnPublishAd.addEventListener("click", async () => {
        btnPublishAd.disabled = true;
        const oldText = btnPublishAd.textContent;
        btnPublishAd.textContent = "Yuklanmoqda...";

        try {
          const payload = {
            city: newAdDraft.city,
            category: newAdDraft.category,
            type: newAdDraft.category,
            title: newAdDraft.title,
            price: String(newAdDraft.price).replace(/\s+/g, ""),
            description: newAdDraft.description,
            images: newAdDraft.photos,
            phone: DEFAULT_PHONE,
            telegram: DEFAULT_TELEGRAM
          };

          const res = await fetch(ADD_AD_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Bad response");

          if (inputTitle) inputTitle.value = "";
          if (inputPrice) inputPrice.value = "";
          if (inputDescription) inputDescription.value = "";
          if (photosPreview) photosPreview.innerHTML = "";
          if (inputPhotos) inputPhotos.value = "";

          newAdDraft = { city:"Toshkent", category:"Transport", title:"", price:"", description:"", photos:[] };

          showScreen("newAdSuccess");
          loadAds();
        } catch (e) {
          console.error("publish error:", e);
          alert("Xatolik, keyinroq urinib ko‚Äòring.");
        } finally {
          btnPublishAd.disabled = false;
          btnPublishAd.textContent = oldText || "E‚Äôlonni joylash";
        }
      });
    }

    // ================== –û–¢–ö–†–´–¢–ò–ï –î–ï–¢–ê–õ–ï–ô (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è) ==================
    function openAdDetails(ad) {
      currentAd = ad;

      if (ad.id != null) {
        const without = historyArray.filter(x => x.id !== ad.id);
        without.unshift({id: ad.id, ts: Date.now()});
        historyArray = without.slice(0, 50);
        saveHistoryToStorage();
      }

      // ‚úÖ expose –¥–ª—è chat / –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
window.openAdDetails = openAdDetails;
window.__getAllAds = () => allAds; // —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—Ä–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤
      
      if (detailTitle) detailTitle.textContent = ad.title || "";
      if (detailPrice) detailPrice.textContent = formatPrice(ad.price);
      if (detailMeta) detailMeta.textContent = `${ad.city || ""} ¬∑ ${getAdCategory(ad)}`;
      if (detailDescription) detailDescription.textContent = ad.description || "";

      const images = Array.isArray(ad.images) ? ad.images : [];

      if (detailMainImage) {
        detailMainImage.innerHTML = "";
        detailMainImage.style.display = "flex";
        detailMainImage.style.overflowX = "auto";
        detailMainImage.style.scrollSnapType = "x mandatory";

        if (images.length) {
          images.forEach((url, idx) => {
            const slide = document.createElement("div");
            slide.className = "detail-main-slide";
            slide.style.backgroundImage = `url('${url}')`;
            slide.addEventListener("click", () => openLightbox(images, idx));
            detailMainImage.appendChild(slide);
          });
        } else {
          const slide = document.createElement("div");
          slide.className = "detail-main-slide";
          slide.style.background = "#e5e7eb";
          detailMainImage.appendChild(slide);
        }
        detailMainImage.scrollLeft = 0;
      }

      if (detailThumbs) {
        detailThumbs.innerHTML = "";
        images.forEach((url, idx) => {
          const div = document.createElement("div");
          div.className = "detail-thumb";
          div.style.backgroundImage = `url('${url}')`;
          div.addEventListener("click", () => {
            if (!detailMainImage) return;
            detailMainImage.scrollTo({ left: idx * detailMainImage.clientWidth, behavior: "smooth" });
          });
          detailThumbs.appendChild(div);
        });
      }

      const phone    = ad.phone    || DEFAULT_PHONE;
      const telegram = ad.telegram || DEFAULT_TELEGRAM;

      if (callSellerBtn) {
        if (phone) {
          const clean = String(phone).replace(/\s+/g, "");
          callSellerBtn.href = "tel:" + clean;
          callSellerBtn.style.display = "flex";
        } else {
          callSellerBtn.style.display = "none";
        }
      }

      if (msgSellerBtn) {
        if (telegram) {
          const uname = String(telegram).replace(/^@/, "");
          msgSellerBtn.href = "https://t.me/" + uname;
          msgSellerBtn.style.display = "flex";
          msgSellerBtn.onclick = e => {
            e.preventDefault();
            openChatForAd(ad);
          };
        } else {
          msgSellerBtn.style.display = "none";
        }
      }

      if (similarList) {
        similarList.innerHTML = "";
        const adCat = getAdCategory(ad);
        const sameType = allAds.filter(x => x.id !== ad.id && !isAdBlocked(x.id) && getAdCategory(x) === adCat);
        const base = sameType.length ? sameType : allAds.filter(x => x.id !== ad.id && !isAdBlocked(x.id));
        base.slice(0, 3).forEach(item => {
          const wrap = document.createElement("div");
          wrap.className = "similar-card";
          const img = item.images && item.images[0];
          wrap.innerHTML = `
            <div class="similar-image" style="${img ? `background-image:url('${img}');` : ""}"></div>
            <div>
              <div class="similar-content-title">${item.title || ""}</div>
              <div class="similar-content-meta">${item.city || ""}</div>
              <div class="similar-content-price">${formatPrice(item.price)}</div>
            </div>
          `;
          wrap.addEventListener("click", () => openAdDetails(item));
          similarList.appendChild(wrap);
        });
      }

      // ===== bind seller card click (ALWAYS uses currentAd) =====
const sellerCard = document.getElementById("sellerCard");

if (sellerCard && !sellerCard.dataset.bound) {
  sellerCard.dataset.bound = "1";

  sellerCard.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();

    // ‚úÖ –±–µ—Ä—ë–º –¢–ï–ö–£–©–ï–ï –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–∞ –Ω–µ —Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º bind)
    const a = currentAd;
    if (!a) return;

    const tg = String(a.telegram || "")
      .replace(/^@/, "")
      .toLowerCase()
      .trim();

    const phone = String(a.phone || "")
      .replace(/\s+/g, "")
      .trim();

    // 1) –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞–≥–∞–∑–∏–Ω –≤ shopsData
    let shop = (shopsData || []).find(s => {
      const stg = String(s.ownerTelegram || "").replace(/^@/, "").toLowerCase().trim();
      const sph = String(s.ownerPhone || "").replace(/\s+/g, "").trim();
      return (tg && stg && tg === stg) || (phone && sph && phone === sph);
    });

    // 2) –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî —Å–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω –ø—Ä–æ–¥–∞–≤—Ü–∞
    if (!shop) {
      const vid = "seller_" + (tg || phone || "unknown");

      shop = {
        id: vid,
        name: tg ? (`@${tg}`) : (phone || "Sotuvchi"),
        city: a.city || "Uzbekiston",
        category: getAdCategory(a) || "Boshqa",
        subs: 0,
        rating: 0,
        reviews: 0,
        ads: 0,
        verified: false,
        last: "yaqinda",
        ownerTelegram: tg || "",
        ownerPhone: phone || "",
        _virtual: true
      };

      // —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞ –º–Ω–æ–≥–æ —Ä–∞–∑
      const exists = (shopsData || []).some(s => String(s.id) === vid);
      if (!exists) shopsData.push(shop);
    }

    // 3) –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞–≥–∞–∑–∏–Ω–∞
    openShop(shop);
  });
}
      
      showScreen("adDetails");
    }

    if (detailBackBtn) detailBackBtn.addEventListener("click", () => showScreen("home"));

    function openLightbox(images, index) {
      if (!imageLightbox || !lightboxImg) return;
      lightboxImages = images.slice();
      lightboxIndex  = index || 0;
      updateLightboxImage();
      imageLightbox.classList.add("visible");
    }
    function updateLightboxImage() {
      if (!lightboxImg || !lightboxImages.length) return;
      lightboxImg.src = lightboxImages[lightboxIndex];
    }
    if (imageLightbox) imageLightbox.addEventListener("click", () => imageLightbox.classList.remove("visible"));
    if (lightboxPrev) lightboxPrev.addEventListener("click", e => {
      e.stopPropagation();
      if (!lightboxImages.length) return;
      lightboxIndex = (lightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
      updateLightboxImage();
    });
    if (lightboxNext) lightboxNext.addEventListener("click", e => {
      e.stopPropagation();
      if (!lightboxImages.length) return;
      lightboxIndex = (lightboxIndex + 1) % lightboxImages.length;
      updateLightboxImage();
    });

        // ================== AD SHEET (‚ãØ) + BLOCK/REPORT ==================
    let sheetAd = null;
    let reportAd = null;

    function openAdSheet(ad){
      sheetAd = ad;
      if (adSheetTitle) adSheetTitle.textContent = ad?.title || "E‚Äôlon";

      if (adSheetFav && ad?.id != null) {
        const isFav = favoritesSet.has(ad.id);
        adSheetFav.innerHTML = `
          <span class="store-sheet-icon share">‚≠ê</span>
          ${isFav ? "Izbranlarda ‚úÖ" : "Izbranlarga qo‚Äòshish"}
        `;
      }

      if (adSheetBackdrop){
        adSheetBackdrop.classList.add("active");
        document.body.classList.add("sheet-open");
      }
    }

    function closeAdSheet(){
      if (adSheetBackdrop) adSheetBackdrop.classList.remove("active");
      document.body.classList.remove("sheet-open");
      sheetAd = null;
    }

    function openAdReportSheet(){
      if (!adReportBackdrop) return;
      adReportBackdrop.classList.add("active");
      document.body.classList.add("sheet-open");
    }

    function closeAdReportSheet(){
      if (!adReportBackdrop) return;
      adReportBackdrop.classList.remove("active");
      document.body.classList.remove("sheet-open");
      reportAd = null;
    }

    // ‚ãØ button in Ad Details
    if (adMoreBtn && !adMoreBtn.dataset.bound) {
      adMoreBtn.dataset.bound = "1";
      adMoreBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (currentAd) openAdSheet(currentAd);
      });
    }

    if (adMoreBtn && !adMoreBtn.dataset.pressBound) {
  adMoreBtn.dataset.pressBound = "1";

  const pressOn  = () => adMoreBtn.classList.add("is-pressed");
  const pressOff = () => adMoreBtn.classList.remove("is-pressed");

  adMoreBtn.addEventListener("pointerdown", pressOn);
  adMoreBtn.addEventListener("pointerup", pressOff);
  adMoreBtn.addEventListener("pointercancel", pressOff);
  adMoreBtn.addEventListener("mouseleave", pressOff);
}
    
    // Backdrop close
    if (adSheetBackdrop && !adSheetBackdrop.dataset.bound) {
      adSheetBackdrop.dataset.bound = "1";
      adSheetBackdrop.addEventListener("click", (e) => {
        if (e.target === adSheetBackdrop) closeAdSheet();
      });
      adSheetBackdrop.querySelector(".store-sheet")?.addEventListener("click", e => e.stopPropagation());
    }

    if (adSheetCancelBtn && !adSheetCancelBtn.dataset.bound) {
      adSheetCancelBtn.dataset.bound = "1";
      const handler = (e) => {
        e.preventDefault(); e.stopPropagation();
        closeAdSheet();
      };
      adSheetCancelBtn.addEventListener("click", handler);
      adSheetCancelBtn.addEventListener("pointerup", handler);
    }

    // Favorite toggle
    if (adSheetFav && !adSheetFav.dataset.bound) {
      adSheetFav.dataset.bound = "1";
      adSheetFav.addEventListener("click", () => {
        if (!sheetAd || sheetAd.id == null) return;

        if (favoritesSet.has(sheetAd.id)) favoritesSet.delete(sheetAd.id);
        else favoritesSet.add(sheetAd.id);

        saveFavoritesToStorage();
        renderFavorites();
        closeAdSheet();
        showToast("Sevimlilar yangilandi", "‚úÖ");
      });
    }

    // Share
    if (adSheetShare && !adSheetShare.dataset.bound) {
      adSheetShare.dataset.bound = "1";
      adSheetShare.addEventListener("click", async () => {
        if (!sheetAd) return;
        const text = `${sheetAd.title || "E‚Äôlon"} ‚Äî ${sheetAd.city || ""} ¬∑ ${getAdCategory(sheetAd)}`;
        const url = window.location.href;

        try{
          if (navigator.share){
            await navigator.share({ title: sheetAd.title || "E‚Äôlon", text, url });
          } else if (navigator.clipboard?.writeText){
            await navigator.clipboard.writeText(`${text}\n${url}`);
            alert("Nusxa olindi ‚úÖ");
          } else {
            alert(text);
          }
        } catch {}
        closeAdSheet();
      });
    }

    // Block ad
    if (adSheetBlock && !adSheetBlock.dataset.bound) {
      adSheetBlock.dataset.bound = "1";
      adSheetBlock.addEventListener("click", () => {
        if (!sheetAd || sheetAd.id == null) return;
        const set = getBlockedAdsSet();
        set.add(sheetAd.id);
        saveBlockedAdsSet(set);

        // remove from favorites if needed
        if (favoritesSet.has(sheetAd.id)) {
          favoritesSet.delete(sheetAd.id);
          saveFavoritesToStorage();
        }

        closeAdSheet();

        // go home + rerender everywhere
        applyAllFilters();
        resetFeedRender();
        renderFavorites();
        renderHistory();
        if (currentScreen === "adDetails") showScreen("home");

        showToast("Bloklandi", "E‚Äôlon yashirildi ‚õî");
      });
    }

    // Report
    if (adSheetReport && !adSheetReport.dataset.bound) {
      adSheetReport.dataset.bound = "1";
      adSheetReport.addEventListener("click", () => {
        reportAd = sheetAd;
        // close ad sheet only visually
        if (adSheetBackdrop) adSheetBackdrop.classList.remove("active");
        openAdReportSheet();
      });
    }

    // Report options
    adReportOptions.forEach(opt => {
      if (opt.dataset.bound) return;
      opt.dataset.bound = "1";
      opt.addEventListener("click", () => {
        if (!reportAd || reportAd.id == null) return;

        const reason = opt.dataset.reason || "other";
        const complaints = JSON.parse(localStorage.getItem("zalvo_ad_reports") || "[]");
        complaints.push({
          adId: reportAd.id,
          title: reportAd.title || "",
          reason,
          ts: Date.now()
        });
        localStorage.setItem("zalvo_ad_reports", JSON.stringify(complaints));

        closeAdReportSheet();
        showToast("Shikoyat yuborildi", "Adminlar tekshiradi ‚ö†Ô∏è");
      });
    });

    if (adReportBackdrop && !adReportBackdrop.dataset.bound) {
      adReportBackdrop.dataset.bound = "1";
      adReportBackdrop.addEventListener("click", (e) => {
        if (e.target === adReportBackdrop) closeAdReportSheet();
      });
      adReportBackdrop.querySelector(".store-sheet")?.addEventListener("click", e => e.stopPropagation());
    }

    if (adReportCancelBtn && !adReportCancelBtn.dataset.bound) {
      adReportCancelBtn.dataset.bound = "1";
      const handler = (e) => {
        e.preventDefault(); e.stopPropagation();
        closeAdReportSheet();
      };
      adReportCancelBtn.addEventListener("click", handler);
      adReportCancelBtn.addEventListener("pointerup", handler);
    }
    // ================== /AD SHEET ==================
    
    // promo
    // if (promoBanner) promoBanner.addEventListener("click", () => showScreen("promo"));
    document.addEventListener("click", e => {
      const plan = e.target.closest(".promo-plan");
      if (!plan) return;
      showToast("E‚Äôlon yuqoriga ko‚Äòtarildi!", "TOP bo‚Äòlimida ko‚Äòrinadi");
    });

  // ================== CHAT (PRO) + PREP FOR DB ==================
const CHAT_STORAGE_KEY = "zalvo_chat_threads_v1";

// –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ –±—É–¥—É—â—É—é –ë–î
const CHAT_API_BASE = "https://YOUR_SERVER.com/api/chat"; // –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏–º
const CHAT_USE_API = false; // —Å–µ–π—á–∞—Å false (–ª–æ–∫–∞–ª—å–Ω–æ), –ø–æ—Ç–æ–º true

function nowTs(){ return Date.now(); }
function fmtTime(ts){
  try{
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  } catch { return ""; }
}
function initials(name){
  const s = String(name||"").trim();
  if (!s) return "Z";
  return s[0].toUpperCase();
}

// ===== Local storage model =====
// thread = {
//   id, peerName, peerId, peerType: "shop"|"user",
//   pinned, muted, unread,
//   lastMessage, lastTs,
//   messages: [{id, from:"me"|"other", text, ts, status:"sent"|"read", imageDataUrl?}],
//   context: { adId?, adTitle?, adUrl?, sellerKey? }  // ‚úÖ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ –ë–î
// thread.context = { adId, title, price, image, city, url }
// }

function loadThreads(){
  try{
    const raw = localStorage.getItem(CHAT_STORAGE_KEY);
    const arr = JSON.parse(raw || "[]");
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}
function saveThreads(arr){
  try{ localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(arr)); } catch {}
}
function upsertThread(thread){
  const threads = loadThreads();
  const i = threads.findIndex(t => String(t.id) === String(thread.id));
  if (i >= 0) threads[i] = thread;
  else threads.unshift(thread);
  saveThreads(threads);
}
function getThreadById(id){
  const threads = loadThreads();
  return threads.find(t => String(t.id) === String(id)) || null;
}
function deleteThread(id){
  const threads = loadThreads().filter(t => String(t.id) !== String(id));
  saveThreads(threads);
}
function clearThreadMessages(id){
  const t = getThreadById(id);
  if (!t) return;
  t.messages = [];
  t.lastMessage = "";
  t.lastTs = nowTs();
  t.unread = 0;
  upsertThread(t);
}

// ===== API stubs (ready for DB) =====
async function apiGetThreads(){
  if (!CHAT_USE_API) return loadThreads();
  const r = await fetch(`${CHAT_API_BASE}/threads`);
  if (!r.ok) throw new Error("threads_failed");
  return await r.json();
}
async function apiGetMessages(threadId){
  if (!CHAT_USE_API) {
    const t = getThreadById(threadId);
    return t?.messages || [];
  }
  const r = await fetch(`${CHAT_API_BASE}/threads/${threadId}/messages`);
  if (!r.ok) throw new Error("messages_failed");
  return await r.json();
}
async function apiSendMessage(threadId, payload){
  // payload: {text, imageBase64?}
  if (!CHAT_USE_API) {
    // –ª–æ–∫–∞–ª—å–Ω–æ ‚Äú–æ—Ç–ø—Ä–∞–≤–∏–ª–∏‚Äù
    return { ok:true, serverId: "local_" + nowTs() };
  }
  const r = await fetch(`${CHAT_API_BASE}/threads/${threadId}/send`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if (!r.ok) throw new Error("send_failed");
  return await r.json();
}
async function apiMarkRead(threadId){
  if (!CHAT_USE_API) return true;
  await fetch(`${CHAT_API_BASE}/threads/${threadId}/read`, { method:"POST" });
  return true;
}

// ===== UI state =====
let chatCurrentThreadId = null;

/**
 * ‚úÖ LIST (–≤–∫–ª–∞–¥–∫–∞ Chat) ‚Äî –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º, –º–µ–Ω—é –≤–∏–¥–Ω–æ
 */
function chatShowThreads(){
  document.body.classList.remove("chat-room-open");
chatApplyRoomLayout(); // —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏–ª–æ—Å—å
  // –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ "chat"
  showScreen("chat", { push:false });

  // –í—ã–∫–ª—é—á–∞–µ–º fullscreen –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (Telegram-like)
  if (typeof closeChatRoomFullscreen === "function") closeChatRoomFullscreen();

  if (chatThreadsView) chatThreadsView.classList.add("active");
  if (chatRoomView) chatRoomView.classList.remove("active");

  chatCurrentThreadId = null;
  renderThreads();
  document.body.classList.remove("chat-room-open");
  requestAnimationFrame(chatRoomMeasure);
}

/**
 * ‚úÖ ROOM (–ø–µ—Ä–µ–ø–∏—Å–∫–∞) ‚Äî fullscreen —Ä–µ–∂–∏–º, –º–µ–Ω—é —Å–∫—Ä—ã—Ç–æ
 */
function chatShowRoom(threadId){
  document.body.classList.add("chat-room-open");
  showScreen("chat", { push:false });

  // –í–∫–ª—é—á–∞–µ–º fullscreen –ø–µ—Ä–µ–ø–∏—Å–∫–∏
  if (typeof openChatRoomFullscreen === "function") openChatRoomFullscreen();

  if (chatThreadsView) chatThreadsView.classList.remove("active");
  if (chatRoomView) chatRoomView.classList.add("active");

  chatCurrentThreadId = threadId;

  const t = getThreadById(threadId);
  if (t){
    if (chatRoomAvatar) chatRoomAvatar.textContent = initials(t.peerName);
    if (chatRoomTitle) chatRoomTitle.textContent = t.peerName || "Chat";
    if (chatRoomStatus) chatRoomStatus.textContent = t.muted ? "muted" : "online";

    renderAdCard();

    // ‚úÖ –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–ø–æ–∫–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ UI –ø–æ–∑–∂–µ)
    // –ü—Ä–∏–º–µ—Ä: "Ad: iPhone 13 Pro"
    if (t.context?.title && chatRoomStatus){
  chatRoomStatus.textContent = t.muted ? "muted" : `Ad: ${t.context.title}`;
}

    t.unread = 0;
    upsertThread(t);
    apiMarkRead(threadId).catch(()=>{});
  }

  renderRoomMessages();

  requestAnimationFrame(()=> chatApplyRoomLayout());
setTimeout(()=> chatApplyRoomLayout(), 150); // iOS –∏–Ω–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∑–∂–µ

  setTimeout(() => {
  const topbar = document.querySelector(".chat-room-topbar");
  const composer = document.getElementById("chatComposerWrap");
  const topH = topbar ? topbar.getBoundingClientRect().height : 64;
  const compH = composer ? composer.getBoundingClientRect().height : 88;
  document.documentElement.style.setProperty("--chat-topbar-h", `${Math.round(topH)}px`);
  document.documentElement.style.setProperty("--chat-composer-h", `${Math.round(compH)}px`);
}, 50);
  
  scrollChatToBottom();
  requestAnimationFrame(chatRoomMeasure);
  setTimeout(chatRoomMeasure, 150);
}

    function chatRoomMeasure(){
  if (!document.body.classList.contains("chat-room-open")) return;

  const vvh = window.visualViewport ? window.visualViewport.height : window.innerHeight;

  const topbar = document.querySelector("#chatRoomView .chat-room-topbar");
  const composer = document.getElementById("chatComposerWrap");
  const topH = topbar ? topbar.getBoundingClientRect().height : 72;
  const compH = composer ? composer.getBoundingClientRect().height : 86;

  document.documentElement.style.setProperty("--vvh", vvh + "px");
  document.documentElement.style.setProperty("--roomTop", topH + "px");
  document.documentElement.style.setProperty("--roomComposer", compH + "px");
}

// iOS –º–µ–Ω—è–µ—Ç –≤—ã—Å–æ—Ç—É –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –ø—Ä–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
window.addEventListener("resize", chatRoomMeasure);
if (window.visualViewport){
  window.visualViewport.addEventListener("resize", chatRoomMeasure);
  window.visualViewport.addEventListener("scroll", chatRoomMeasure);
}

function sortThreads(arr){
  // pinned first, then by lastTs desc
  return [...arr].sort((a,b)=>{
    const ap = a.pinned ? 1 : 0;
    const bp = b.pinned ? 1 : 0;
    if (ap !== bp) return bp - ap;
    return (b.lastTs||0) - (a.lastTs||0);
  });
}

function renderThreads(){
  if (!chatThreadsList || !chatThreadsEmpty) return;

  const q = (chatThreadsSearch?.value || "").toLowerCase().trim();
  let threads = loadThreads();

  if (q){
    threads = threads.filter(t => {
      const text = `${t.peerName||""} ${t.lastMessage||""}`.toLowerCase();
      return text.includes(q);
    });
  }

  threads = sortThreads(threads);

  chatThreadsList.innerHTML = "";
  if (!threads.length){
    chatThreadsEmpty.style.display = "block";
    return;
  }
  chatThreadsEmpty.style.display = "none";

  threads.forEach(t=>{
    const row = document.createElement("div");
    row.className = "chat-thread";

    const pin = t.pinned ? `<div class="chat-thread-pin">üìå</div>` : "";
    const badge = (t.unread||0) > 0 ? `<div class="chat-thread-badge">${t.unread}</div>` : "";

    const avatarHtml = (t.context?.image)
  ? `<img src="${t.context.image}" alt="ad" />`
  : `<span>${initials(t.peerName)}</span>`;

row.innerHTML = `
  <div class="chat-thread-avatar">${avatarHtml}</div>
  <div class="chat-thread-main">
    <div class="chat-thread-title">${t.peerName || "Chat"} ${pin}</div>
    <div class="chat-thread-last">
      ${(t.context?.title ? `üìå ${t.context.title} ‚Ä¢ ` : "")}${t.lastMessage || "‚Äî"}
    </div>
  </div>
  <div class="chat-thread-meta">
    <div class="chat-thread-time">${t.lastTs ? fmtTime(t.lastTs) : ""}</div>
    ${badge}
  </div>
`;

    // ‚úÖ –®–ê–ì 3B: –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É –≤ fullscreen
    row.addEventListener("click", ()=> chatShowRoom(t.id));
    chatThreadsList.appendChild(row);
  });
}

    function renderAdCard(){
  if (!chatAdCard) return;

  const t = chatCurrentThreadId ? getThreadById(chatCurrentThreadId) : null;
  const ctx = t?.context;

  if (!ctx || (!ctx.title && !ctx.price && !ctx.city && !ctx.image && !ctx.url)){
    chatAdCard.style.display = "none";
    return;
  }

  chatAdCard.style.display = "block";

  if (chatAdTitle) chatAdTitle.textContent = ctx.title || "E‚Äôlon";
  if (chatAdPrice) chatAdPrice.textContent = ctx.price ? String(ctx.price) : "";
  if (chatAdCity)  chatAdCity.textContent  = ctx.city ? `‚Ä¢ ${ctx.city}` : "";

  if (chatAdImg){
    if (ctx.image){
      chatAdImg.innerHTML = `<img src="${ctx.image}" alt="ad">`;
    } else {
      chatAdImg.textContent = "AD";
    }
  }

  const openIt = () => {
  // –≤—ã–∫–ª—é—á–∞–µ–º fullscreen –∫–æ–º–Ω–∞—Ç—ã
  if (typeof closeChatRoomFullscreen === "function") closeChatRoomFullscreen();
  document.body.classList.remove("chat-room-open");

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ –∏–∑ —á–∞—Ç–∞
  setTimeout(() => {
    const ok = openAdById(ctx.adId, ctx);
    if (!ok) showToast("E‚Äôlon", "Ochilmadi");
  }, 50);
};

if (chatAdOpenBtn) chatAdOpenBtn.onclick = openIt;

// –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –≤—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ü–µ–ª–∏–∫–æ–º
chatAdCard.onclick = (e) => {
  // –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Äî –æ–Ω–∞ —Å–∞–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
  if (e.target === chatAdOpenBtn) return;
  openIt();
};
  }

   function openAdById(adId, ctx = null) {
  if (!adId) {
    if (typeof showToast === "function") showToast("E‚Äôlon", "ID yo‚Äòq");
    return false;
  }

  const findInAllAds = () => {
    try {
      return (window.allAds || allAds || []).find(a => String(a.id) === String(adId)) || null;
    } catch {
      return null;
    }
  };

  const adObj = findInAllAds();

  if (adObj) {
    openAdDetails(adObj);
    return true;
  }

  // –µ—Å–ª–∏ ads –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å ‚Äî –≥—Ä—É–∑–∏–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
  if (typeof loadAds === "function") {
    loadAds().then(() => {
      const ad2 = findInAllAds();
      if (ad2) {
        openAdDetails(ad2);
      } else {
        if (typeof showToast === "function") showToast("E‚Äôlon topilmadi", `ID: ${adId}`);
        if (ctx?.url) window.open(ctx.url, "_blank");
      }
    });
    return true;
  }

  if (typeof showToast === "function") showToast("E‚Äôlon topilmadi", `ID: ${adId}`);
  if (ctx?.url) window.open(ctx.url, "_blank");
  return false;
}
    
function renderRoomMessages(){
  if (!chatMessagesEl || !chatCurrentThreadId) return;

  const t = getThreadById(chatCurrentThreadId);
  const msgs = t?.messages || [];
  chatMessagesEl.innerHTML = "";

  msgs.forEach(m=>{
    const b = document.createElement("div");
    b.className = "chat-bubble " + (m.from === "me" ? "me" : "other");

    const safeText = (m.text || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const imgHtml = m.imageDataUrl ? `<img class="chat-image" src="${m.imageDataUrl}" alt="image" />` : "";

    const status = m.from === "me" ? (m.status === "read" ? "‚úì‚úì" : "‚úì") : "";
    b.innerHTML = `
      <div>${safeText}</div>
      ${imgHtml}
      <div class="chat-bubble-meta">
        <span>${fmtTime(m.ts)}</span>
        ${status ? `<span>${status}</span>` : ``}
      </div>
    `;
    chatMessagesEl.appendChild(b);
  });
}

function scrollChatToBottom(){
  if (!chatMessagesEl) return;
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
}

function ensureDemoThreadIfEmpty(){
  const threads = loadThreads();
  if (threads.length) return;

  const demo = {
    id: "t_demo_1",
    peerName: "Sotuvchi",
    peerId: "seller_1",
    peerType: "user",
    pinned: false,
    muted: false,
    unread: 1,
    lastMessage: "Assalomu alaykum! Savollaringiz bormi? üôÇ",
    lastTs: nowTs()-60000,
    context: { adId: "demo_ad", adTitle: "Demo e‚Äôlon" },
    messages: [
      { id:"m1", from:"other", text:"Assalomu alaykum! Savollaringiz bormi? üôÇ", ts: nowTs()-60000, status:"read" }
    ]
  };
  saveThreads([demo]);
}

    function getAdImage(ad){
  if (!ad) return "";

  // 1) —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
  let img =
    ad.image ||
    ad.img ||
    ad.photo ||
    ad.imgUrl ||
    ad.imageUrl ||
    "";

  // 2) –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –º–∞—Å—Å–∏–≤–æ–º
  if (!img && Array.isArray(ad.images) && ad.images.length) img = ad.images[0];
  if (!img && Array.isArray(ad.photos) && ad.photos.length) img = ad.photos[0];
  if (!img && Array.isArray(ad.pics) && ad.pics.length) img = ad.pics[0];

  // 3) –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç {url:"..."}
  if (img && typeof img === "object") img = img.url || img.src || "";

  return String(img || "").trim();
}
    
// ===== open chat from Ad =====
function openChatForAd(ad){
  const tg = String(ad?.telegram||"").replace(/^@/,"").toLowerCase().trim();
  const phone = String(ad?.phone||"").replace(/\s+/g,"").trim();
  const peerKey = tg ? ("tg_" + tg) : phone ? ("ph_" + phone) : ("seller_unknown");

  // ‚úÖ –∫–ª—é—á –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
  const adId = String(ad?.id || ad?.adId || ad?.slug || ad?.title || "no_ad").trim();
  const adKey = ("ad_" + adId).toLowerCase();

  // ‚úÖ —Ç–µ–ø–µ—Ä—å —á–∞—Ç —É–Ω–∏–∫–∞–ª–µ–Ω: –ø—Ä–æ–¥–∞–≤–µ—Ü + –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
  const threadKey = `${peerKey}__${adKey}`;
  const threadId = "t_" + threadKey;

  const threads = loadThreads();
  let t = threads.find(x => String(x.id) === String(threadId));

  if (!t){
    const peerName = tg ? ("@" + tg) : (phone || "Sotuvchi");

    t = {
  id: threadId,
  peerName,
  peerId: peerKey,
  peerType: "user",
  pinned:false,
  muted:false,
  unread:0,
  lastMessage:"",
  lastTs: nowTs(),

  context: {
  adId: ad?.id || ad?.adId || null,
  title: ad?.title || ad?.name || ad?.model || "",
  price: ad?.price || "",
  city: ad?.city || ad?.location || "",
  image: getAdImage(ad),     // ‚úÖ –≤–æ—Ç –æ–Ω–æ
  url: ad?.url || ""
},

  messages:[]
};

    // ‚úÖ –ø–µ—Ä–≤–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    const adTitle = t.context.title;
    t.messages.push({
      id:"m_ctx_" + nowTs(),
      from:"other",
      text:`Assalomu alaykum! ‚Äú${adTitle}‚Äù bo‚Äòyicha savolingiz bormi? üòä`,
      ts: nowTs(),
      status:"read"
    });

    t.lastMessage = `‚Äú${adTitle}‚Äù bo‚Äòyicha savol`;
    t.lastTs = nowTs();
    upsertThread(t);
  } else {
    // ‚úÖ –µ—Å–ª–∏ —Ç—Ä–µ–¥ –µ—Å—Ç—å, –Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–¥—Ä—É–≥ –ø—É—Å—Ç–æ–π ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º
    if (!t.context) {
      t.context = {
        adId: adId,
        title: ad?.title || ad?.name || "E‚Äôlon",
        price: ad?.price || "",
        city: ad?.city || "",
        image: ad?.image || ad?.img || "",
        url: ad?.url || ""
      };
      upsertThread(t);
    }
  }

  // –æ—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω —á–∞—Ç–∞ –∏ —Å—Ä–∞–∑—É –∫–æ–º–Ω–∞—Ç—É
  showScreen("chat");
  chatShowRoom(t.id);
}

// ===== send =====
async function sendMessage(text, imageDataUrl=null){
  if (!chatCurrentThreadId) return;

  const t = getThreadById(chatCurrentThreadId);
  if (!t) return;

  const msg = {
    id: "m_" + nowTs(),
    from: "me",
    text: String(text||"").trim(),
    ts: nowTs(),
    status: "sent",
    imageDataUrl: imageDataUrl || null
  };
  if (!msg.text && !msg.imageDataUrl) return;

  t.messages.push(msg);
  t.lastMessage = msg.text ? msg.text : "üì∑ Rasm";
  t.lastTs = msg.ts;
  upsertThread(t);

  renderRoomMessages();
  renderThreads();
  scrollChatToBottom();

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∫–æ–≥–¥–∞ –≤–∫–ª—é—á–∏–º CHAT_USE_API)
  try{
    await apiSendMessage(t.id, { text: msg.text, imageBase64: msg.imageDataUrl || null });
    // –∏–º–∏—Ç–∞—Ü–∏—è "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
    setTimeout(()=>{
      const tt = getThreadById(t.id);
      if (!tt) return;
      const last = tt.messages[tt.messages.length-1];
      if (last && last.from==="me") last.status = "read";
      upsertThread(tt);
      if (chatCurrentThreadId === t.id) renderRoomMessages();
      renderThreads();
    }, 700);
  } catch(e){
    console.warn("send failed, will sync later", e);
  }

  // –∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ (—Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)
  if (!CHAT_USE_API){
    if (chatTyping){
      chatTyping.style.display = "block";
      setTimeout(()=> chatTyping.style.display = "none", 800);
    }
  }
}

// ===== Attach image =====
function pickImage(){
  if (!chatFileInput) return;
  chatFileInput.value = "";
  chatFileInput.click();
}

// ===== sheet =====
function openChatSheet(){
  if (!chatRoomSheetBackdrop) return;
  chatRoomSheetBackdrop.classList.add("active");
  document.body.classList.add("sheet-open");
  const t = chatCurrentThreadId ? getThreadById(chatCurrentThreadId) : null;
  if (chatRoomSheetTitle) chatRoomSheetTitle.textContent = t?.peerName || "Chat";
}
function closeChatSheet(){
  if (!chatRoomSheetBackdrop) return;
  chatRoomSheetBackdrop.classList.remove("active");
  document.body.classList.remove("sheet-open");
}

// ===== bind events (once) =====
function bindChatUI(){
  ensureDemoThreadIfEmpty();

  // ===== FORCE chat-room-open + DEBUG =====
(function(){
  // –º–∞–ª–µ–Ω—å–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–≤–µ—Ä—Ö—É (—á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å: –≤–∫–ª—é—á–∏–ª—Å—è —Ä–µ–∂–∏–º –∏–ª–∏ –Ω–µ—Ç)
  const badge = document.createElement("div");
  badge.id = "chatDebugBadge";
  badge.style.cssText = "position:fixed;top:8px;right:8px;z-index:999999;padding:6px 10px;border-radius:10px;background:#111;color:#fff;font:12px/1.2 system-ui;opacity:.85;display:none";
  badge.textContent = "CHAT ROOM MODE";
  document.body.appendChild(badge);

  function setRoomMode(on){
    document.body.classList.toggle("chat-room-open", !!on);
    badge.style.display = on ? "block" : "none";
  }

  // 1) –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É ‚Äî –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
  const _origChatShowRoom = window.chatShowRoom;
  window.chatShowRoom = function(threadId){
    setRoomMode(true);
    _origChatShowRoom(threadId);
    setTimeout(()=>{ window.__chatMeasureHeights?.(); }, 50);
    setTimeout(()=>{ window.__chatMeasureHeights?.(); }, 250);
  };

  // 2) –∫–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
  const _origChatShowThreads = window.chatShowThreads;
  window.chatShowThreads = function(){
    setRoomMode(false);
    _origChatShowThreads();
  };

  // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—Ç–∫—Ä—ã–ª–∏ —á–∞—Ç-—Ä—É–º –∫–∞–∫–∏–º-—Ç–æ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º ‚Äî –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.id === "chatRoomBackBtn") setRoomMode(false);
  }, true);

  // —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∑–∞–º–µ—Ä–æ–≤
  window.__chatMeasureHeights = function(){
    const topbar = document.querySelector(".chat-room-topbar");
    const composer = document.getElementById("chatComposerWrap");
    const topH = topbar ? topbar.getBoundingClientRect().height : 64;
    const compH = composer ? composer.getBoundingClientRect().height : 88;
    document.documentElement.style.setProperty("--chat-topbar-h", `${Math.round(topH)}px`);
    document.documentElement.style.setProperty("--chat-composer-h", `${Math.round(compH)}px`);
  };
})();

  if (chatThreadsSearch && !chatThreadsSearch.dataset.bound){
    chatThreadsSearch.dataset.bound = "1";
    chatThreadsSearch.addEventListener("input", renderThreads);
  }

  // ===== CHAT: measure heights (fix iOS gaps) =====
function chatMeasureHeights(){
  const topbar = document.querySelector(".chat-room-topbar");
  const composer = document.getElementById("chatComposerWrap");

  const topH = topbar ? topbar.getBoundingClientRect().height : 64;
  const compH = composer ? composer.getBoundingClientRect().height : 88;

  document.documentElement.style.setProperty("--chat-topbar-h", `${Math.round(topH)}px`);
  document.documentElement.style.setProperty("--chat-composer-h", `${Math.round(compH)}px`);
}

window.addEventListener("resize", ()=> {
  if (document.body.classList.contains("chat-room-open")) chatMeasureHeights();
});
window.addEventListener("orientationchange", ()=> {
  if (document.body.classList.contains("chat-room-open")) setTimeout(chatMeasureHeights, 200);
});

// –µ—Å–ª–∏ –≤ room –æ—Ç–∫—Ä—ã–ª–∏ ‚Äî –º–µ—Ä—è–µ–º
const _chatShowRoom = chatShowRoom;
chatShowRoom = function(threadId){
  _chatShowRoom(threadId);
  setTimeout(chatMeasureHeights, 50);
  setTimeout(chatMeasureHeights, 250);
};

  // ‚úÖ back –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ —Å–ø–∏—Å–æ–∫ –∏ –≤—ã–∫–ª—é—á–∞–µ—Ç fullscreen
  if (chatRoomBackBtn && !chatRoomBackBtn.dataset.bound){
    chatRoomBackBtn.dataset.bound = "1";
    chatRoomBackBtn.addEventListener("click", ()=> chatShowThreads());
  }

  if (chatRoomMoreBtn && !chatRoomMoreBtn.dataset.bound){
    chatRoomMoreBtn.dataset.bound = "1";
    chatRoomMoreBtn.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      openChatSheet();
    });
  }

  if (chatRoomSheetCancel && !chatRoomSheetCancel.dataset.bound){
    chatRoomSheetCancel.dataset.bound = "1";
    chatRoomSheetCancel.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      closeChatSheet();
    });
  }

  if (chatRoomSheetBackdrop && !chatRoomSheetBackdrop.dataset.bound){
    chatRoomSheetBackdrop.dataset.bound = "1";
    chatRoomSheetBackdrop.addEventListener("click", (e)=>{
      if (e.target === chatRoomSheetBackdrop) closeChatSheet();
    });
    chatRoomSheetBackdrop.querySelector(".store-sheet")?.addEventListener("click", e=>e.stopPropagation());
  }

  if (chatActionPin && !chatActionPin.dataset.bound){
    chatActionPin.dataset.bound = "1";
    chatActionPin.addEventListener("click", ()=>{
      const t = chatCurrentThreadId ? getThreadById(chatCurrentThreadId) : null;
      if (!t) return;
      t.pinned = !t.pinned;
      upsertThread(t);
      renderThreads();
      closeChatSheet();
      showToast("Chat yangilandi", t.pinned ? "üìå Pinned" : "Pin olib tashlandi");
    });
  }

  if (chatActionMute && !chatActionMute.dataset.bound){
    chatActionMute.dataset.bound = "1";
    chatActionMute.addEventListener("click", ()=>{
      const t = chatCurrentThreadId ? getThreadById(chatCurrentThreadId) : null;
      if (!t) return;
      t.muted = !t.muted;
      upsertThread(t);
      if (chatRoomStatus) chatRoomStatus.textContent = t.muted ? "muted" : (t.context?.adTitle ? `Ad: ${t.context.adTitle}` : "online");
      closeChatSheet();
      showToast("Chat", t.muted ? "üîï Muted" : "üîî Unmuted");
    });
  }

  if (chatActionClear && !chatActionClear.dataset.bound){
    chatActionClear.dataset.bound = "1";
    chatActionClear.addEventListener("click", ()=>{
      if (!chatCurrentThreadId) return;
      clearThreadMessages(chatCurrentThreadId);
      renderRoomMessages();
      renderThreads();
      closeChatSheet();
      showToast("Tozalandi", "Chat ichidagi xabarlar o‚Äòchirildi");
    });
  }

  if (chatActionDelete && !chatActionDelete.dataset.bound){
    chatActionDelete.dataset.bound = "1";
    chatActionDelete.addEventListener("click", ()=>{
      if (!chatCurrentThreadId) return;
      const id = chatCurrentThreadId;
      deleteThread(id);
      closeChatSheet();
      chatShowThreads();
      showToast("O‚Äòchirildi", "Chat ro‚Äòyxatdan olib tashlandi");
    });
  }

  if (chatActionReport && !chatActionReport.dataset.bound){
    chatActionReport.dataset.bound = "1";
    chatActionReport.addEventListener("click", ()=>{
      const t = chatCurrentThreadId ? getThreadById(chatCurrentThreadId) : null;
      if (!t) return;
      const reports = JSON.parse(localStorage.getItem("zalvo_chat_reports") || "[]");
      reports.push({ threadId: t.id, peer: t.peerName, ts: nowTs(), context: t.context || null });
      localStorage.setItem("zalvo_chat_reports", JSON.stringify(reports));
      closeChatSheet();
      showToast("Shikoyat yuborildi", "Adminlar tekshiradi ‚ö†Ô∏è");
    });
  }

  if (chatAttachBtn && !chatAttachBtn.dataset.bound){
    chatAttachBtn.dataset.bound = "1";
    chatAttachBtn.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      pickImage();
    });
  }

  if (chatFileInput && !chatFileInput.dataset.bound){
    chatFileInput.dataset.bound = "1";
    chatFileInput.addEventListener("change", ()=>{
      const file = chatFileInput.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e)=>{
        const url = e.target.result; // base64 dataUrl
        sendMessage("", url);
      };
      reader.readAsDataURL(file);
    });
  }

  if (chatSendBtn && chatInput && !chatSendBtn.dataset.bound){
    chatSendBtn.dataset.bound = "1";
    chatSendBtn.addEventListener("click", ()=>{
      const text = (chatInput.value || "").trim();
      chatInput.value = "";
      sendMessage(text);
    });

    chatInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        chatSendBtn.click();
      }
    });
  }

  if (chatNewDialogBtn && !chatNewDialogBtn.dataset.bound){
    chatNewDialogBtn.dataset.bound = "1";
    chatNewDialogBtn.addEventListener("click", ()=>{
      const id = "t_new_" + nowTs();
      const t = {
        id,
        peerName: "Yangi chat",
        peerId: "new_" + id,
        peerType: "user",
        pinned:false,
        muted:false,
        unread:0,
        lastMessage:"Yangi chat ochildi",
        lastTs: nowTs(),
        context: null,
        messages:[{ id:"m0", from:"other", text:"Salom! üôÇ", ts: nowTs(), status:"read" }]
      };
      upsertThread(t);
      renderThreads();
      chatShowRoom(id); // ‚úÖ fullscreen
    });
  }

  // –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
  renderThreads();
}

// IMPORTANT: –≤—ã–∑—ã–≤–∞—Ç—å bindChatUI() –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
bindChatUI();

    (function iosKeyboardDock(){
  const root = document.documentElement;

  function measureComposer(){
    const comp = document.getElementById("chatComposerWrap");
    if (!comp) return 90;
    const h = Math.round(comp.getBoundingClientRect().height || 90);
    root.style.setProperty("--composer-h", h + "px");
    return h;
  }

  function apply(){
    if (!document.body.classList.contains("chat-room-open")) {
      root.style.setProperty("--kbd-shift", "0px");
      return;
    }

    const vv = window.visualViewport;
    measureComposer();

    if (!vv){
      root.style.setProperty("--kbd-shift", "0px");
      return;
    }

    // –°–∫–æ–ª—å–∫–æ ‚Äú–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç‚Äù –¥–æ –Ω–∏–∑–∞ —ç–∫—Ä–∞–Ω–∞ –∏–∑-–∑–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã/–ø–∞–Ω–µ–ª–µ–π
    const gap = window.innerHeight - (vv.height + vv.offsetTop);

    // gap > 0 –∫–æ–≥–¥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞
    root.style.setProperty("--kbd-shift", (-Math.max(0, Math.round(gap))) + "px");
  }

  // —Å–æ–±—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã/–≤—å—é–ø–æ—Ä—Ç–∞
  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", apply);
    window.visualViewport.addEventListener("scroll", apply);
  }
  window.addEventListener("resize", apply);

  // –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ/—Å–Ω—è—Ç–∏–∏ —Ñ–æ–∫—É—Å–∞ —Ç–æ–∂–µ
  document.addEventListener("focusin", apply);
  document.addEventListener("focusout", () => setTimeout(apply, 50));

  // –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
  const _origChatShowRoom = window.chatShowRoom;
  window.chatShowRoom = function(id){
    _origChatShowRoom(id);
    setTimeout(apply, 0);
    setTimeout(apply, 80);
    setTimeout(apply, 200);
  };

  const _origChatShowThreads = window.chatShowThreads;
  window.chatShowThreads = function(){
    _origChatShowThreads();
    root.style.setProperty("--kbd-shift", "0px");
  };
})();

    // iOS/Chrome: –∏–Ω–æ–≥–¥–∞ composer –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç "–¥–≤–∏–∂–µ–Ω–∏–µ" UI
function forceComposerRelayout(){
  requestAnimationFrame(()=> chatRoomMeasure());
  setTimeout(()=> chatRoomMeasure(), 50);
  setTimeout(()=> chatRoomMeasure(), 180);

  // –ª–µ–≥–∫–∏–π "–ø–∏–Ω–æ–∫" –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ fixed/flex –≤ iOS
  const el = document.getElementById("chatMessages");
  if (el) el.scrollTop = el.scrollTop + 1;
}

// –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–ª–∏ –∫–æ–º–Ω–∞—Ç—É ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
document.addEventListener("click", (e)=>{
  // –µ—Å–ª–∏ —Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å —á–∞—Ç —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ ‚Äî —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
  if (document.body.classList.contains("chat-room-open")) forceComposerRelayout();
}, true);

// –∫–æ–≥–¥–∞ —Ñ–æ–∫—É—Å –≤ –∏–Ω–ø—É—Ç–µ ‚Äî —Ç–æ–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
document.addEventListener("focusin", (e)=>{
  if (e.target && e.target.classList && e.target.classList.contains("chat-input")){
    forceComposerRelayout();
    setTimeout(scrollChatToBottom, 80);
  }
});
    
    // ===== iOS Safari FIX: real viewport height via VisualViewport =====
(function setRealVh(){
  function apply(){
    const vv = window.visualViewport;
    const h = vv ? vv.height : window.innerHeight;
    document.documentElement.style.setProperty('--vvh', (h * 0.01) + 'px');
  }
  apply();

  // –≤–∞–∂–Ω–æ –¥–ª—è Safari: –∞–¥—Ä–µ—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–Ω—è–µ—Ç –≤—ã—Å–æ—Ç—É –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ/—Ñ–æ–∫—É—Å–µ
  window.addEventListener('resize', apply);
  window.addEventListener('orientationchange', apply);

  if (window.visualViewport){
    window.visualViewport.addEventListener('resize', apply);
    window.visualViewport.addEventListener('scroll', apply);
  }
})();
    
// ================== /CHAT (PRO) ==================

    const settingsAdminRow  = document.getElementById("settingsAdminRow");

    function updateAdminPanel() {
      if (!adminTotalAdsEl || !adminNewTodayEl || !adminLastAdsEl) return;
      adminTotalAdsEl.textContent = allAds.length;

      const todayStr = new Date().toISOString().slice(0, 10);
      const newToday = allAds.filter(ad => (ad.created_at || "").startsWith(todayStr)).length;
      adminNewTodayEl.textContent = newToday;

      adminLastAdsEl.innerHTML = "";
      const sorted = [...allAds].sort((a,b)=> {
        const da = a.created_at ? new Date(a.created_at).getTime() : 0;
        const db = b.created_at ? new Date(b.created_at).getTime() : 0;
        return db - da;
      }).slice(0, 10);

      sorted.forEach(ad => {
        const row = document.createElement("div");
        row.className = "admin-list-item";
        row.textContent = `${ad.title || "E‚Äôlon"} ¬∑ ${ad.city || ""}`;
        row.addEventListener("click", () => openAdDetails(ad));
        adminLastAdsEl.appendChild(row);
      });
    }

    // Settings links
    if (settingsFavoritesRow) settingsFavoritesRow.addEventListener("click", () => showScreen("favorites"));
    if (settingsHistoryRow)   settingsHistoryRow.addEventListener("click", () => showScreen("history"));
    if (settingsPaidRow)      settingsPaidRow.addEventListener("click", () => showScreen("promo"));
    if (settingsBusinessRow)  settingsBusinessRow.addEventListener("click", () => showScreen("business"));
    if (settingsAdminRow)     settingsAdminRow.addEventListener("click", () => showScreen("admin"));
    if (settingsMyAdsRow)     settingsMyAdsRow.addEventListener("click", () => showScreen("myAds"));

    // ===== Profilim open =====
if (settingsProfileRow && !settingsProfileRow.dataset.bound) {
  settingsProfileRow.dataset.bound = "1";
  settingsProfileRow.addEventListener("click", () => {
    renderProfileEditValues();
    showScreen("profileEdit");
  });
}

// ===== Profilim actions =====
if (editPhoneRow && !editPhoneRow.dataset.bound) {
  editPhoneRow.dataset.bound = "1";
  editPhoneRow.addEventListener("click", () => {
    openProfileSheet(
      "Telefon raqamini o‚Äòzgartirish",
      `
        <input id="phoneInput" class="profile-input" placeholder="+998 90 123 45 67" value="${profileState.phone || ""}"/>
        <div class="profile-help">Keyin server bo‚Äòlsa ‚Äî SMS tasdiqlash bo‚Äòladi.</div>
      `,
      () => {
        const val = (document.getElementById("phoneInput")?.value || "").trim();
        profileState.phone = val;
        saveProfileToStorage(profileState);
        renderProfileEditValues();
        showToast("Telefon saqlandi", "‚úÖ");
        closeProfileSheet();
      }
    );
  });
}

if (editEmailRow && !editEmailRow.dataset.bound) {
  editEmailRow.dataset.bound = "1";
  editEmailRow.addEventListener("click", () => {
    const verifiedText = (profileState.email && profileState.emailVerified) ? "‚úÖ Tasdiqlangan" : "Tasdiqlash";

    openProfileSheet(
      "Elektron pochta",
      `
        <div class="profile-row">
          <input id="emailInput" class="profile-input" placeholder="example@mail.com" value="${profileState.email || ""}"/>
          <button id="verifyEmailBtn" class="profile-mini-btn" type="button">${verifiedText}</button>
        </div>
        <div class="profile-help">Hozircha demo. Serverda kod yuborib tasdiqlaymiz.</div>
      `,
      () => {
        const val = (document.getElementById("emailInput")?.value || "").trim();
        profileState.email = val;
        profileState.emailVerified = false; // email changed => not verified
        saveProfileToStorage(profileState);
        renderProfileEditValues();
        showToast("Email saqlandi", "‚úÖ");
        closeProfileSheet();
      }
    );

    // bind verify button (demo)
    setTimeout(() => {
      const btn = document.getElementById("verifyEmailBtn");
      if (!btn || btn.dataset.bound) return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", () => {
        const val = (document.getElementById("emailInput")?.value || "").trim();
        if (!val) return showToast("Avval email kiriting", "‚ö†Ô∏è");

        profileState.email = val;
        profileState.emailVerified = true; // demo verify
        saveProfileToStorage(profileState);
        renderProfileEditValues();
        showToast("Email tasdiqlandi (demo)", "‚úÖ");
        closeProfileSheet();
      });
    }, 0);
  });
}

if (editPasswordRow && !editPasswordRow.dataset.bound) {
  editPasswordRow.dataset.bound = "1";
  editPasswordRow.addEventListener("click", () => {
    openProfileSheet(
      "Parolni o‚Äòzgartirish",
      `
        <input id="pass1" class="profile-input" type="password" placeholder="Yangi parol"/>
        <div style="height:10px"></div>
        <input id="pass2" class="profile-input" type="password" placeholder="Qayta kiriting"/>
        <div class="profile-help">Hozircha demo. Serverda hash qilib DBga yoziladi.</div>
      `,
      () => {
        const p1 = document.getElementById("pass1")?.value || "";
        const p2 = document.getElementById("pass2")?.value || "";

        if (!p1 || p1.length < 6) return showToast("Parol kamida 6 ta belgi", "‚ö†Ô∏è");
        if (p1 !== p2) return showToast("Parollar mos emas", "‚ö†Ô∏è");

        profileState.passwordHash = "local_demo_set";
        saveProfileToStorage(profileState);

        showToast("Parol o‚Äòzgartirildi (demo)", "‚úÖ");
        closeProfileSheet();
      }
    );
  });
}

    function applySavedProfilePhoto() {
      if (!profileAvatar) return;
      try {
        const url = localStorage.getItem(PROFILE_PHOTO_KEY);
        if (url) {
          profileAvatar.style.backgroundImage = `url('${url}')`;
          profileAvatar.style.backgroundSize = "cover";
          profileAvatar.style.backgroundPosition = "center";
          profileAvatar.textContent = "";
        }
      } catch (e) { console.warn("Profile photo load error:", e); }
    }

    function userHasShop() {
      try { return localStorage.getItem("zalvoHasShop") === "1"; }
      catch { return false; }
    }
    function setUserHasShop() {
      try { localStorage.setItem("zalvoHasShop", "1"); } catch {}
    }

    function renderMyShopAds() {
      if (!myShopAdsList) return;
      myShopAdsList.innerHTML = "";

      const myPhone = DEFAULT_PHONE.replace(/\s+/g, "");
      const myTg    = DEFAULT_TELEGRAM.replace(/^@/, "").toLowerCase();

      const myAds = allAds.filter(ad => {
        const adPhone = (ad.phone || "").replace(/\s+/g, "");
        const adTg    = (ad.telegram || "").replace(/^@/, "").toLowerCase();
        return (adPhone && adPhone === myPhone) || (adTg && adTg === myTg);
      });

      if (!myAds.length) {
        myShopAdsList.innerHTML = "<div class='ad-meta'>Hozircha do‚Äòkoningizda e‚Äôlonlar yo‚Äòq</div>";
        return;
      }

      const q = (shopAdsSearchInput?.value || "").toLowerCase().trim();

      let result = myAds.filter(ad => {
      if (isAdBlocked(ad.id)) return false;
        if (shopAdsFilterState.onlyWithPhoto) {
          if (!ad.images || !Array.isArray(ad.images) || !ad.images.length) return false;
        }

        const p = Number(ad.price || 0);
        const min = Number(shopAdsFilterState.minPrice || 0);
        const max = Number(shopAdsFilterState.maxPrice || 0);

        if (shopAdsFilterState.minPrice && isFinite(min) && p < min) return false;
        if (shopAdsFilterState.maxPrice && isFinite(max) && p > max) return false;

        if (q) {
          const text = ((ad.title || "") + " " + (ad.description || "")).toLowerCase();
          if (!text.includes(q)) return false;
        }
        return true;
      });

      result.sort((a,b) => {
        const pa = Number(a.price || 0);
        const pb = Number(b.price || 0);
        const da = a.created_at ? new Date(a.created_at).getTime() : 0;
        const db = b.created_at ? new Date(b.created_at).getTime() : 0;

        if (shopAdsFilterState.sort === "cheap") return pa - pb;
        if (shopAdsFilterState.sort === "expensive") return pb - pa;
        return db - da;
      });

      if (!result.length) {
        myShopAdsList.innerHTML = "<div class='ad-meta'>Mos e‚Äôlon topilmadi</div>";
        return;
      }
      result.forEach(ad => myShopAdsList.appendChild(createAdCard(ad)));
    }

    // Profile photo change
    if (settingsChangePhoto && profilePhotoInput) {
      settingsChangePhoto.addEventListener("click", () => profilePhotoInput.click());

      profilePhotoInput.addEventListener("change", () => {
        const file = profilePhotoInput.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
          const url = e.target.result;

          if (profileAvatar) {
            profileAvatar.style.backgroundImage = `url('${url}')`;
            profileAvatar.style.backgroundSize = "cover";
            profileAvatar.style.backgroundPosition = "center";
            profileAvatar.textContent = "";
          }

          try { localStorage.setItem(PROFILE_PHOTO_KEY, url); }
          catch (err) { console.warn("Profile photo save error:", err); }
        };
        reader.readAsDataURL(file);
      });
    }

    if (businessBackBtn) businessBackBtn.addEventListener("click", () => showScreen("profile"));

    if (businessOpenShopBtn) {
      businessOpenShopBtn.addEventListener("click", () => {
        setUserHasShop();
        showScreen("myShop");
      });
    }

    if (settingsMyShopRow) {
      settingsMyShopRow.addEventListener("click", () => {
        if (userHasShop()) showScreen("myShop");
        else showScreen("business");
      });
    }

    if (settingsLangRow) settingsLangRow.addEventListener("click", () => showScreen("language"));

    if (languageUz) languageUz.addEventListener("click", () => {
      localStorage.setItem("zalvoLang", "uz");
      alert("Til o‚Äòrnatildi: O‚Äòzbek tili");
      showScreen("profile");
    });

    if (languageRu) languageRu.addEventListener("click", () => {
      localStorage.setItem("zalvoLang", "ru");
      alert("–Ø–∑—ã–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –†—É—Å—Å–∫–∏–π");
      showScreen("profile");
    });

    // ================== SHOPS DATA + RENDER ==================
    const shopsSearchInput = document.getElementById("shopsSearchInput");
    const shopsListEl      = document.getElementById("shopsList");
    const shopsEmptyEl     = document.getElementById("shopsEmpty");
    const shopsCategoryRow = document.getElementById("shopsCategoryRow");
    const topShopsRow      = document.getElementById("topShopsRow");

    const shopsFilterBtn   = document.getElementById("shopsFilterBtn");
    const shopsFilterSheet = document.getElementById("shopsFilterSheet");
    const shopsFilterCity  = document.getElementById("shopsFilterCity");
    const shopsSort        = document.getElementById("shopsSort");
    const shopsOnlyVerifiedBtn = document.getElementById("shopsOnlyVerified");
    const shopsApplyBtn    = document.getElementById("shopsApply");
    const shopsResetBtn    = document.getElementById("shopsReset");

    const shopsData = [
      { id:"s1", name:"Zalvo Phone Shop", city:"Toshkent shahri",   category:"Elektronika", subs:451, rating:4.9, reviews:451, ads:12, verified:true,  last:"yaqinda", ownerTelegram:"gulzor_shop",     ownerPhone:"+998991234567" },
      { id:"s2", name:"AvtoParts Pro",    city:"Toshkent viloyati", category:"Avto",        subs:210, rating:4.7, reviews:88,  ads:34, verified:true,  last:"bugun",  ownerTelegram:"avtoparts_pro" },
      { id:"s3", name:"Usta Xizmat",      city:"Samarqand",         category:"Xizmatlar",   subs:98,  rating:4.8, reviews:22,  ads:9,  verified:false, last:"kecha",  ownerTelegram:"usta_xizmat" },
      { id:"s4", name:"Home Market",      city:"Farg‚Äòona",          category:"Uy-rozg‚Äòor",  subs:133, rating:4.6, reviews:41,  ads:18, verified:false, last:"yaqinda",ownerTelegram:"home_market" },
      { id:"s5", name:"Style Kiyim",      city:"Andijon",           category:"Kiyim",       subs:76,  rating:4.5, reviews:19,  ads:7,  verified:true,  last:"yaqinda",ownerTelegram:"style_kiyim" },
      { id:"s6", name:"Green Market", city:"Toshkent shahri", category:"Oziq-ovqat", subs:55, rating:4.4, reviews:12, ads:15, verified:false, last:"bugun", ownerTelegram:"green_market" },
      { id:"s7", name:"Kids World", city:"Samarqand", category:"Bolalar", subs:80, rating:4.6, reviews:20, ads:10, verified:true, last:"yaqinda", ownerTelegram:"kids_world" },
      { id:"s8", name:"Qurilish Bazar", city:"Andijon", category:"Qurilish", subs:120, rating:4.5, reviews:33, ads:25, verified:true, last:"kecha", ownerTelegram:"qurilish_bazar" },
      { id:"s9", name:"Beauty Zone", city:"Farg‚Äòona", category:"Go‚Äòzallik", subs:95, rating:4.7, reviews:27, ads:14, verified:false, last:"yaqinda", ownerTelegram:"beauty_zone" },
      { id:"s10", name:"Sport Shop", city:"Namangan", category:"Sport", subs:60, rating:4.3, reviews:9, ads:8, verified:false, last:"yaqinda", ownerTelegram:"sport_shop" }
    ];

    function renderShopCategoryChips(){
  if (!shopsCategoryRow) return;

  const unique = Array.from(new Set((shopsData || [])
    .map(s => String(s.category || "").trim())
    .filter(Boolean)
  ));

  // –ø–æ—Ä—è–¥–æ–∫ ‚Äú–∫—Ä–∞—Å–∏–≤—ã–π‚Äù (—Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ)
  const order = [
    "Elektronika","Avto","Uy-rozg‚Äòor","Xizmatlar","Kiyim",
    "Oziq-ovqat","Bolalar","Qurilish","Go‚Äòzallik","Sport","Kitoblar"
  ];

  unique.sort((a,b)=> {
    const ia = order.indexOf(a);
    const ib = order.indexOf(b);
    return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
  });

  shopsCategoryRow.innerHTML = `
    <button class="chip ${shopsFilterState.category === "all" ? "chip-filled":""}" data-shopcat="all">Hammasi</button>
    ${unique.map(c => `
      <button class="chip ${shopsFilterState.category === c ? "chip-filled":""}" data-shopcat="${c}">${c}</button>
    `).join("")}
  `;
}
    
    // ‚úÖ MY SHOP ‚ãØ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –û–ë–©–ò–ô shopSheetBackdrop
    const myShop = shopsData.find(s => s.id === "s1") || shopsData[0] || null;

    if (storeMoreBtn && !storeMoreBtn.dataset.bound) {
      storeMoreBtn.dataset.bound = "1";
      storeMoreBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (myShop) openShopSheet(myShop);
      });
    }

    // ‚úÖ My Shop subscribe bind
const myShopSubsEl = document.querySelector("#screen-my-shop .store-subs");

bindSubscribe(storeSubscribeBtn, () => myShop, {
  mode: "short",
  subsEl: myShopSubsEl,
  onAfter: () => renderShops()
});

    const shopsFilterState = {
      category: "all",
      city: "all",
      sort: "popular",
      onlyVerified: false,
    };

    function blockedKey(){ return "zalvo_shop_blocked"; }
    function getBlockedSet(){
      try { return new Set(JSON.parse(localStorage.getItem(blockedKey()) || "[]")); }
      catch { return new Set(); }
    }
    function saveBlockedSet(set){
      try { localStorage.setItem(blockedKey(), JSON.stringify(Array.from(set))); } catch {}
    }

        // ===== BLOCKED ADS =====
    function blockedAdsKey(){ return "zalvo_ad_blocked"; }
    function getBlockedAdsSet(){
      try { return new Set(JSON.parse(localStorage.getItem(blockedAdsKey()) || "[]")); }
      catch { return new Set(); }
    }
    let blocksTab = "ads"; // "ads" | "shops"

function setBlocksTab(tab){
  blocksTab = tab;

  if (blocksTabs) {
    blocksTabs.querySelectorAll(".chip").forEach(ch => {
      ch.classList.toggle("chip-filled", ch.dataset.tab === tab);
    });
  }

  if (blockedAdsBox) blockedAdsBox.style.display = (tab === "ads") ? "block" : "none";
  if (blockedShopsBox) blockedShopsBox.style.display = (tab === "shops") ? "block" : "none";

  renderBlocksScreen();
}

if (blocksTabs && !blocksTabs.dataset.bound) {
  blocksTabs.dataset.bound = "1";
  blocksTabs.addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if (!chip) return;
    const tab = chip.dataset.tab;
    if (!tab) return;
    setBlocksTab(tab);
  });
}

function renderBlockedAds(){
  if (!blockedAdsList) return;
  blockedAdsList.innerHTML = "";

  const blocked = Array.from(getBlockedAdsSet());
  const ads = blocked
    .map(id => allAds.find(a => String(a.id) === String(id)))
    .filter(Boolean);

  if (!ads.length) {
    blockedAdsList.innerHTML = "<div class='ad-meta'>Bloklangan e‚Äôlonlar yo‚Äòq</div>";
    return;
  }

  ads.forEach(ad => {
    const row = document.createElement("div");
    row.className = "blocked-row";

    row.innerHTML = `
      <div class="left">
        <div style="font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          ${ad.title || "E‚Äôlon"}
        </div>
        <div class="meta">üìç ${(ad.city||"")} ¬∑ ${getAdCategory(ad)}</div>
      </div>
      <button class="unblock-btn" type="button">Blokdan chiqarish</button>
    `;

    row.querySelector(".unblock-btn").addEventListener("click", () => {
      const set = getBlockedAdsSet();
      set.delete(ad.id);
      saveBlockedAdsSet(set);

      applyAllFilters();
      resetFeedRender();
      renderFavorites();
      renderHistory();

      renderBlockedAds();
    });

    // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –∫–ª–∏–∫–æ–º –ø–æ –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
    row.querySelector(".left").addEventListener("click", () => openAdDetails(ad));

    blockedAdsList.appendChild(row);
  });
}

function renderBlockedShops(){
  if (!blockedShopsList) return;
  blockedShopsList.innerHTML = "";

  const blocked = Array.from(getBlockedSet());
  const shops = blocked
    .map(id => (shopsData || []).find(s => String(s.id) === String(id)))
    .filter(Boolean);

  if (!shops.length) {
    blockedShopsList.innerHTML = "<div class='ad-meta'>Bloklangan do‚Äòkonlar yo‚Äòq</div>";
    return;
  }

  shops.forEach(shop => {
    const row = document.createElement("div");
    row.className = "blocked-row";

    row.innerHTML = `
      <div class="left">
        <div style="font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          ${shop.name || "Do‚Äòkon"}
        </div>
        <div class="meta">üìç ${(shop.city||"")} ¬∑ ${(shop.category||"")}</div>
      </div>
      <button class="unblock-btn" type="button">Blokdan chiqarish</button>
    `;

    row.querySelector(".unblock-btn").addEventListener("click", () => {
      const set = getBlockedSet();
      set.delete(shop.id);
      saveBlockedSet(set);

      renderShops();
      renderBlockedShops();
    });

    row.querySelector(".left").addEventListener("click", () => openShop(shop));

    blockedShopsList.appendChild(row);
  });
}

function renderBlocksScreen(){
  if (blocksTab === "ads") renderBlockedAds();
  else renderBlockedShops();
}

if (unblockAllBtn && !unblockAllBtn.dataset.bound) {
  unblockAllBtn.dataset.bound = "1";
  unblockAllBtn.addEventListener("click", () => {
    if (blocksTab === "ads") {
      saveBlockedAdsSet(new Set());
      applyAllFilters();
      resetFeedRender();
      renderFavorites();
      renderHistory();
      renderBlockedAds();
    } else {
      saveBlockedSet(new Set());
      renderShops();
      renderBlockedShops();
    }
  });
}
    function saveBlockedAdsSet(set){
      try { localStorage.setItem(blockedAdsKey(), JSON.stringify(Array.from(set))); } catch {}
    }
    function isAdBlocked(adId){
      if (adId == null) return false;
      return getBlockedAdsSet().has(adId);
    }
    function removeBlockedFromFavorites(){
      const blocked = getBlockedAdsSet();
      let changed = false;
      favoritesSet.forEach(id => {
        if (blocked.has(id)) { favoritesSet.delete(id); changed = true; }
      });
      if (changed) saveFavoritesToStorage();
    }
    
    let shopsLoadedOnce = false;
    async function ensureShopsLoaded() {
      if (shopsLoadedOnce) return;
      shopsLoadedOnce = true;
      if (shopsListEl && (!shopsListEl.children || shopsListEl.children.length === 0)) {
        shopsListEl.innerHTML = "<div class='ad-meta'>Yuklanmoqda...</div>";
      }
    }

    function openShopsFilterSheet() {
      if (!shopsFilterSheet) return;
      shopsFilterSheet.classList.add("active");
      document.body.classList.add("sheet-open");
    }
    function closeShopsFilterSheet() {
      if (!shopsFilterSheet) return;
      shopsFilterSheet.classList.remove("active");
      document.body.classList.remove("sheet-open");
    }
    function syncShopsFilterUI(){
      if (shopsFilterCity) shopsFilterCity.value = shopsFilterState.city;
      if (shopsSort) shopsSort.value = shopsFilterState.sort;
      if (shopsOnlyVerifiedBtn) shopsOnlyVerifiedBtn.classList.toggle("chip-filled", shopsFilterState.onlyVerified);
    }

    function getInitials(name){
      const s = String(name||"").trim();
      if (!s) return "Z";
      const parts = s.split(/\s+/);
      const a = parts[0]?.[0] || "Z";
      const b = parts[1]?.[0] || "";
      return (a + b).toUpperCase();
    }

    function calcShopScore(shop){
      let score = 0;
      score += (shop.subs || 0) * 3;
      score += (shop.rating || 0) * 50;
      score += (shop.ads || 0) * 10;
      if (shop.last === "bugun")   score += 100;
      if (shop.last === "yaqinda") score += 50;
      if (shop.last === "kecha")   score += 20;
      return score;
    }

    function subKey(id){ return `zalvo_shop_sub_${id}`; }
    function isSubscribed(shopId){
      try { return localStorage.getItem(subKey(shopId)) === "1"; }
      catch { return false; }
    }
    function toggleSubscribe(shopId){
      try{
        const now = localStorage.getItem(subKey(shopId)) === "1";
        localStorage.setItem(subKey(shopId), now ? "0" : "1");
        return !now;
      } catch { return false; }
    }

    // ================== ‚úÖ COMMON SUBSCRIBE (ONE LOGIC) ==================
function setSubscribeUI(btn, shopId, opts = {}) {
  if (!btn || !shopId) return;

  const subscribed = isSubscribed(shopId);

  // —Ç–µ–∫—Å—Ç
  if (opts.mode === "short") {
    btn.textContent = subscribed ? "Obuna ‚úÖ" : "Obuna bo‚Äòlish";
  } else {
    // default (—Å –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–æ–º)
    btn.textContent = subscribed ? "Obuna ‚úÖ" : "üîî Obuna bo‚Äòlish";
  }

  // –∫–ª–∞—Å—Å –¥–ª—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–∞
  btn.classList.toggle("subscribed", subscribed);

  // —á—Ç–æ–±—ã iOS –Ω–µ –¥–µ–ª–∞–ª —Å–µ—Ä—ã–π highlight
  btn.style.webkitTapHighlightColor = "transparent";

  return subscribed;
}

function pulse(btn) {
  if (!btn) return;
  btn.classList.remove("pulse");
  void btn.offsetWidth; // restart animation
  btn.classList.add("pulse");
}

function bindSubscribe(btn, getShop, opts = {}) {
  if (!btn || btn.dataset.subBound === "1") return;
  btn.dataset.subBound = "1";

  // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  const shop0 = typeof getShop === "function" ? getShop() : null;
  if (shop0?.id) setSubscribeUI(btn, shop0.id, opts);

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();

    const shop = typeof getShop === "function" ? getShop() : null;
    if (!shop?.id) return;

    const on = toggleSubscribe(shop.id);

    // –∞–Ω–∏–º–∞—Ü–∏—è
    pulse(btn);

    // (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    if (opts.subsEl && shop) {
      let n = Number(shop.subs || 0);
      n = on ? (n + 1) : Math.max(0, n - 1);
      shop.subs = n;
      opts.subsEl.textContent = `${n} obunachi`;
    }

    // –æ–±–Ω–æ–≤–∏—Ç—å —Å–∞–º—É –∫–Ω–æ–ø–∫—É
    setSubscribeUI(btn, shop.id, opts);

    // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏/—ç–∫—Ä–∞–Ω—ã –µ—Å–ª–∏ –Ω–∞–¥–æ
    if (typeof opts.onAfter === "function") opts.onAfter(on, shop);
  });
}
// ================== /COMMON SUBSCRIBE ==================

    function topShopCardIG(shop){
      const div = document.createElement("div");
      div.className = "top-shop-ig";
      const subscribed = isSubscribed(shop.id);

      div.innerHTML = `
        <button class="top-shop-ig-menu" type="button" aria-label="Menu">‚ãØ</button>
        <div class="top-shop-ig-center">
          <div class="top-shop-ig-avatar">${getInitials(shop.name)}</div>
          <div class="top-shop-ig-name">${shop.name}${shop.verified ? " ‚úì" : ""}</div>
          <div class="top-shop-ig-meta">üìç ${shop.city}</div>
          <div class="top-shop-ig-meta2">${shop.category} ¬∑ ‚≠ê ${shop.rating || 0} ¬∑ üë• ${shop.subs || 0}</div>
          <button class="top-shop-ig-btn ${subscribed ? "subscribed":""}" type="button">
            ${subscribed ? "Obuna ‚úÖ" : "Obuna bo‚Äòlish"}
          </button>
        </div>
      `;

      div.addEventListener("click", () => openShop(shop));

const subBtn = div.querySelector(".top-shop-ig-btn");
setSubscribeUI(subBtn, shop.id, { mode:"short" });

bindSubscribe(subBtn, () => shop, {
  mode: "short",
  onAfter: () => renderShops()
});
      
      const menuBtn = div.querySelector(".top-shop-ig-menu");
      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openShopSheet(shop);
      });

      return div;
    }

    // ‚úÖ Shop View subscribe bind
bindSubscribe(shopViewSubBtn, () => currentShop, {
  mode: "default",
  subsEl: shopViewSubs,
  onAfter: () => renderShops() // —á—Ç–æ–±—ã Top/—Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å
});

    // ===== Shops ACTION SHEET =====
    let sheetShop = null;

    const shopSheetBackdrop = document.getElementById("shopSheetBackdrop");
    const shopSheetTitle    = document.getElementById("shopSheetTitle");
    const shopSheetFav      = document.getElementById("shopSheetFav");
    const shopSheetShare    = document.getElementById("shopSheetShare");
    const shopSheetBlock    = document.getElementById("shopSheetBlock");

    function favShopKey(id){ return `zalvo_shop_fav_${id}`; }

    function openShopSheet(shop){
      sheetShop = shop;

      if (shopSheetTitle) shopSheetTitle.textContent = shop?.name || "Do‚Äòkon";
      if (shopSheetBackdrop) {
        shopSheetBackdrop.classList.add("active");
        document.body.classList.add("sheet-open");
      }

      if (shopSheetFav && sheetShop) {
        const isFav = isShopFav(sheetShop.id);
        shopSheetFav.innerHTML = `
        <span class="store-sheet-icon share">‚≠ê</span>
       ${isFav ? "Izbranlarda ‚úÖ" : "Izbranlarga qo‚Äòshish"}
      `;
      }
    }

    function closeShopSheet(){
      if (shopSheetBackdrop) shopSheetBackdrop.classList.remove("active");
      document.body.classList.remove("sheet-open");
      sheetShop = null;
    }

    if (shopViewMoreBtn) {
      shopViewMoreBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (currentShop) openShopSheet(currentShop);
      });
    }

    if (shopSheetFav && !shopSheetFav.dataset.bound) {
  shopSheetFav.dataset.bound = "1";
  shopSheetFav.addEventListener("click", () => {
    if (!sheetShop) return;

    toggleShopFav(sheetShop.id);

    closeShopSheet();
    renderFavorites();   // ‚úÖ –æ–±–Ω–æ–≤–∏—Ç—å –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
    showToast("Izbranlar yangilandi", "‚úÖ");
  });
}

    if (shopSheetShare && !shopSheetShare.dataset.bound) {
      shopSheetShare.dataset.bound = "1";
      shopSheetShare.addEventListener("click", async () => {
        if (!sheetShop) return;
        const text = `${sheetShop.name} ‚Äî ${sheetShop.city} ¬∑ ${sheetShop.category}`;
        const url = window.location.href;

        try{
          if (navigator.share){
            await navigator.share({ title: sheetShop.name, text, url });
          } else if (navigator.clipboard?.writeText){
            await navigator.clipboard.writeText(`${text}\n${url}`);
            alert("Nusxa olindi ‚úÖ");
          } else {
            alert(text);
          }
        } catch {}
        closeShopSheet();
      });
    }

    if (shopSheetBlock && !shopSheetBlock.dataset.bound) {
      shopSheetBlock.dataset.bound = "1";
      shopSheetBlock.addEventListener("click", () => {
        if (!sheetShop) return;
        const set = getBlockedSet();
        set.add(sheetShop.id);
        saveBlockedSet(set);
        closeShopSheet();
        renderShops();
      });
    }

    // ‚úÖ Close button for SHOP sheet ("Bekor qilish")
const shopSheetCancelBtn = document.getElementById("shopSheetCancelBtn");
if (shopSheetCancelBtn && !shopSheetCancelBtn.dataset.bound) {
  shopSheetCancelBtn.dataset.bound = "1";
  shopSheetCancelBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    closeShopSheet();
  });
}
    
    if (shopSheetBackdrop && !shopSheetBackdrop.dataset.bound) {
      shopSheetBackdrop.dataset.bound = "1";
      shopSheetBackdrop.addEventListener("click", (e) => {
        if (e.target === shopSheetBackdrop) closeShopSheet();
      });
      shopSheetBackdrop.querySelector(".store-sheet")?.addEventListener("click", e => e.stopPropagation());
    }

    function shopCard(shop, withActions = true){
      const div = document.createElement("div");
      div.className = "shop-card";

      div.innerHTML = `
        <div class="shop-card-avatar">${getInitials(shop.name)}</div>
        <div class="shop-card-main">
          <div class="shop-card-title">
            ${shop.name}
            ${shop.verified ? `<span style="color:#16a34a;font-weight:800;">‚úì</span>` : ""}
          </div>
          <div class="shop-card-meta">üìç ${shop.city} ¬∑ ${shop.category}</div>
          <div class="shop-card-stats">
            <span>‚≠ê ${shop.rating}</span>
            <span>üí¨ ${shop.reviews}</span>
            <span>üßæ ${shop.ads}</span>
            <span>üë• ${shop.subs}</span>
          </div>
        </div>
        ${withActions ? `<button class="shop-more-btn" type="button">‚ãØ</button>` : ``}
      `;

      if (withActions) {
        div.querySelector(".shop-more-btn").addEventListener("click", (e) => {
          e.stopPropagation();
          openShopSheet(shop);
        });
      }

      div.addEventListener("click", () => openShop(shop));
      return div;
    }

    function renderShops(){
      if (!shopsListEl || !topShopsRow) return;

      const q = (shopsSearchInput?.value || "").toLowerCase().trim();
      const blocked = getBlockedSet();

      let result = shopsData
        .filter(s => !blocked.has(s.id))
        .filter(s => !s._virtual) // ‚úÖ —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã –≤ —Å–ø–∏—Å–∫–µ
        .filter(s => {
          if (shopsFilterState.category !== "all" && s.category !== shopsFilterState.category) return false;
          if (shopsFilterState.city !== "all" && s.city !== shopsFilterState.city) return false;
          if (shopsFilterState.onlyVerified && !s.verified) return false;

          if (q) {
            const text = `${s.name} ${s.city} ${s.category}`.toLowerCase();
            if (!text.includes(q)) return false;
          }
          return true;
        });

      result.sort((a,b) => {
        if (shopsFilterState.sort === "rating") return (b.rating||0) - (a.rating||0);
        if (shopsFilterState.sort === "new")    return (b.ads||0) - (a.ads||0);
        return (b.subs||0) - (a.subs||0);
      });

      const top = [...shopsData]
  .filter(s => !blocked.has(s.id))
  .filter(s => s.verified)
  .filter(s => !s._virtual) // ‚úÖ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ù–ï –≤ —Ç–æ–ø–µ
  .map(s => ({ ...s, _score: calcShopScore(s) }))
  .sort((a,b) => b._score - a._score)
  .slice(0, 8);

      topShopsRow.innerHTML = "";
      top.forEach(s => topShopsRow.appendChild(topShopCardIG(s)));

      shopsListEl.innerHTML = "";
      if (!result.length) {
        if (shopsEmptyEl) shopsEmptyEl.style.display = "block";
        return;
      }
      if (shopsEmptyEl) shopsEmptyEl.style.display = "none";

      result.forEach(s => shopsListEl.appendChild(shopCard(s)));
    }

    if (shopsSearchInput && !shopsSearchInput.dataset.bound) {
      shopsSearchInput.dataset.bound = "1";
      shopsSearchInput.addEventListener("input", renderShops);
    }

    if (shopsCategoryRow && !shopsCategoryRow.dataset.bound) {
      shopsCategoryRow.dataset.bound = "1";
      shopsCategoryRow.addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        shopsCategoryRow.querySelectorAll(".chip").forEach(c => c.classList.remove("chip-filled"));
        chip.classList.add("chip-filled");
        shopsFilterState.category = chip.getAttribute("data-shopcat") || "all";
        renderShops();
      });
    }

    if (shopsFilterBtn && !shopsFilterBtn.dataset.bound) {
      shopsFilterBtn.dataset.bound = "1";
      shopsFilterBtn.addEventListener("click", () => {
        syncShopsFilterUI();
        openShopsFilterSheet();
      });
    }

    if (shopsFilterSheet && !shopsFilterSheet.dataset.bound) {
      shopsFilterSheet.dataset.bound = "1";
      shopsFilterSheet.addEventListener("click", (e) => {
        if (e.target === shopsFilterSheet) closeShopsFilterSheet();
      });
      const inner = shopsFilterSheet.querySelector(".store-sheet");
      if (inner) inner.addEventListener("click", (e) => e.stopPropagation());
    }

    if (shopsOnlyVerifiedBtn && !shopsOnlyVerifiedBtn.dataset.bound) {
      shopsOnlyVerifiedBtn.dataset.bound = "1";
      shopsOnlyVerifiedBtn.addEventListener("click", () => {
        shopsFilterState.onlyVerified = !shopsFilterState.onlyVerified;
        syncShopsFilterUI();
      });
    }

    if (shopsApplyBtn && !shopsApplyBtn.dataset.bound) {
      shopsApplyBtn.dataset.bound = "1";
      shopsApplyBtn.addEventListener("click", () => {
        shopsFilterState.city = shopsFilterCity?.value || "all";
        shopsFilterState.sort = shopsSort?.value || "popular";
        closeShopsFilterSheet();
        renderShops();
      });
    }

    if (shopsResetBtn && !shopsResetBtn.dataset.bound) {
      shopsResetBtn.dataset.bound = "1";
      shopsResetBtn.addEventListener("click", async () => {
        shopsFilterState.city = "all";
        shopsFilterState.sort = "popular";
        shopsFilterState.onlyVerified = false;
        shopsFilterState.category = "all";
        if (shopsSearchInput) shopsSearchInput.value = "";

        renderShopCategoryChips(); // ‚úÖ –ø–µ—Ä–µ—Å–æ–±–µ—Ä—ë—Ç –∏ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

        syncShopsFilterUI();
        closeShopsFilterSheet();
        await ensureShopsLoaded();
        renderShops();
      });
    }

    // ===== REPORT SHOP =====
    const shopSheetReport = document.getElementById("shopSheetReport");
    const reportBackdrop  = document.getElementById("reportSheetBackdrop");
    const reportOptions   = document.querySelectorAll(".report-option");
    let reportShop = null;

    function openReportSheet(){
      if (!reportBackdrop) return;
      reportBackdrop.classList.add("active");
      document.body.classList.add("sheet-open");
    }
    function closeReportSheet(){
      if (!reportBackdrop) return;
      reportBackdrop.classList.remove("active");
      document.body.classList.remove("sheet-open");
    }

    if (shopSheetReport && !shopSheetReport.dataset.bound) {
      shopSheetReport.dataset.bound = "1";
      shopSheetReport.addEventListener("click", () => {
        reportShop = sheetShop;
        if (shopSheetBackdrop) shopSheetBackdrop.classList.remove("active");
        openReportSheet();
      });
    }

    reportOptions.forEach(opt => {
      if (opt.dataset.bound) return;
      opt.dataset.bound = "1";

      opt.addEventListener("click", () => {
        if (!reportShop) return;

        const reason = opt.dataset.reason || "other";
        const complaints = JSON.parse(localStorage.getItem("zalvo_shop_reports") || "[]");
        complaints.push({ shopId: reportShop.id, shopName: reportShop.name, reason, ts: Date.now() });
        localStorage.setItem("zalvo_shop_reports", JSON.stringify(complaints));

        closeReportSheet();
        reportShop = null;

        showToast("Shikoyat yuborildi", "Adminlar tekshiradi ‚ö†Ô∏è");
      });
    });

    if (reportBackdrop && !reportBackdrop.dataset.bound) {
      reportBackdrop.dataset.bound = "1";
      reportBackdrop.addEventListener("click", (e) => {
        if (e.target === reportBackdrop) {
          closeReportSheet();
          reportShop = null;
        }
      });
      reportBackdrop.querySelector(".store-sheet")?.addEventListener("click", e => e.stopPropagation());
    }

    const reportCancelBtn = document.getElementById("reportCancelBtn");

if (reportCancelBtn && !reportCancelBtn.dataset.bound) {
  reportCancelBtn.dataset.bound = "1";

  // –Ω–∞ iOS –∏–Ω–æ–≥–¥–∞ click –≥–ª—é—á–∏—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º pointerup —Ç–æ–∂–µ
  const handler = (e) => {
    e.preventDefault();
    e.stopPropagation();
    closeReportSheet();
    reportShop = null;
  };

  reportCancelBtn.addEventListener("click", handler);
  reportCancelBtn.addEventListener("pointerup", handler);
}

    // ================== MY SHOP REGISTRATION (SAVE + PREVIEW) ==================
const MY_SHOP_KEY = "zalvo_my_shop_v1";

// ‚ö†Ô∏è –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω–∏ id –Ω–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑ HTML
const shopRegName = document.getElementById("shopRegName");
const shopRegCity = document.getElementById("shopRegCity");
const shopRegCategory = document.getElementById("shopRegCategory");
const shopRegPhone = document.getElementById("shopRegPhone");
const shopRegTg = document.getElementById("shopRegTg");

const shopSaveBtn = document.getElementById("shopSaveBtn");
const shopPreviewBtn = document.getElementById("shopPreviewBtn");

function loadMyShop(){
  try{
    const raw = localStorage.getItem(MY_SHOP_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveMyShop(obj){
  try{ localStorage.setItem(MY_SHOP_KEY, JSON.stringify(obj)); }catch(e){}
}

function upsertMyShopToShopsData(shop){
  if (!shop?.id) return;
  const i = shopsData.findIndex(s => String(s.id) === String(shop.id));
  if (i >= 0) shopsData[i] = { ...shopsData[i], ...shop, _virtual:false };
  else shopsData.unshift({ ...shop, _virtual:false });
}

function buildShopFromForm(){
  const name = (shopRegName?.value || "").trim();
  const city = (shopRegCity?.value || "").trim();
  const category = (shopRegCategory?.value || "").trim();
  const phone = (shopRegPhone?.value || "").trim();
  const tg = (shopRegTg?.value || "").trim().replace(/^@/,"");

  if (!name) { showToast("Xatolik", "Do‚Äòkon nomini kiriting"); return null; }
  if (!city) { showToast("Xatolik", "Shaharni tanlang"); return null; }
  if (!category) { showToast("Xatolik", "Kategoriya tanlang"); return null; }

  const id = "myshop_" + (tg || phone || "owner");
  return {
    id,
    name,
    city,
    category,
    subs: 0,
    rating: 0,
    reviews: 0,
    ads: 0,
    verified: false,
    last: "bugun",
    ownerTelegram: tg,
    ownerPhone: phone
  };
}

// SAVE
if (shopSaveBtn && !shopSaveBtn.dataset.bound){
  shopSaveBtn.dataset.bound = "1";
  shopSaveBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    const shop = buildShopFromForm();
    if (!shop) return;

    saveMyShop(shop);
    upsertMyShopToShopsData(shop);
    setUserHasShop();

    showToast("Saqlandi", "Do‚Äòkon yaratildi ‚úÖ");
    showScreen("myShop");
    renderShops();
  });
}

// PREVIEW
if (shopPreviewBtn && !shopPreviewBtn.dataset.bound){
  shopPreviewBtn.dataset.bound = "1";
  shopPreviewBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    const shop = buildShopFromForm();
    if (!shop) return;

    // –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å
    currentShop = shop;
    showScreen("shopView");
  });
}
// ================== /MY SHOP REGISTRATION ==================
   
(function () {
  // ---------- 1) showScreen (–≥–ª–æ–±–∞–ª—å–Ω–æ) ----------
  function showScreen(name) {
    const all = document.querySelectorAll(".screen");
    all.forEach(s => s.classList.remove("active"));

    const el = document.getElementById("screen-" + name);
    if (!el) {
      console.warn("‚ùå screen not found:", "screen-" + name);
      return;
    }
    el.classList.add("active");
    window.scrollTo(0, 0);
  }
  window.showScreen = showScreen;

  // ---------- 2) –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é ----------
  document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      showScreen(btn.dataset.screen);
    });
  });

  // ---------- 3) –ü–µ—Ä–µ—Ö–æ–¥—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è ----------
  const go = (id, screen) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("click", () => showScreen(screen));
  };

  go("settingsFavoritesRow", "favorites");
  go("settingsMyAdsRow", "my-ads");
  go("settingsHistoryRow", "history");
  go("settingsBlocksRow", "blocks");
  go("settingsAdminRow", "admin");
  go("settingsBusinessRow", "business");
  go("settingsMyShopRow", "my-shop");

  // ---------- 4) –ö–Ω–æ–ø–∫–∞ "Do‚Äòkonni bepul ochish" -> —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ----------
  const businessOpen = document.getElementById("businessOpenShopBtn");
  if (businessOpen) businessOpen.addEventListener("click", () => showScreen("shop-register"));

  // ---------- 5) –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞ –ù–ï–¢ ‚Äî —Å–æ–∑–¥–∞—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ----------
  if (!document.getElementById("screen-shop-register")) {
    const main = document.querySelector("main.screens");
    if (main) {
      const reg = document.createElement("section");
      reg.id = "screen-shop-register";
      reg.className = "screen";
      reg.innerHTML = `
        <div class="screen-title">Do‚Äòkon ochish</div>

        <div class="form-group">
          <label class="form-label">Do‚Äòkon nomi</label>
          <input id="shopRegName" class="form-input" type="text" placeholder="Masalan: Zalvo Phone Shop" />
        </div>

        <div class="form-group">
          <label class="form-label">Shahar</label>
          <select id="shopRegCity" class="form-select">
            <option value="Toshkent shahri">Toshkent shahri</option>
            <option value="Toshkent viloyati">Toshkent viloyati</option>
            <option value="Andijon">Andijon</option>
            <option value="Farg‚Äòona">Farg‚Äòona</option>
            <option value="Samarqand">Samarqand</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Kategoriya</label>
          <select id="shopRegCategory" class="form-select">
            <option value="Elektronika">Elektronika</option>
            <option value="Avto">Avto</option>
            <option value="Uy-rozg‚Äòor">Uy-rozg‚Äòor</option>
            <option value="Xizmatlar">Xizmatlar</option>
            <option value="Kiyim">Kiyim</option>
          </select>
        </div>

        <div class="filters-actions-row">
          <button id="shopPreviewBtn" class="outline-btn" type="button">Oldindan ko‚Äòrish</button>
          <button id="shopSaveBtn" class="primary-btn" type="button">Saqlash</button>
          <button id="shopRegBack" class="outline-btn" type="button">Orqaga</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          Saqlangandan keyin do‚Äòkon sahifasi ochiladi.
        </div>
      `;
      main.appendChild(reg);
    }
  }

  // ---------- 6) –õ–æ–≥–∏–∫–∞ "Preview / Save" ----------
  function readShopForm() {
    return {
      name: (document.getElementById("shopRegName")?.value || "").trim(),
      city: document.getElementById("shopRegCity")?.value || "",
      category: document.getElementById("shopRegCategory")?.value || ""
    };
  }

  function applyShopToMyShopScreen(shop) {
    // –æ–±–Ω–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –∏–º—è –∏ –≥–æ—Ä–æ–¥ –≤ —Ç–≤–æ—ë–º screen-my-shop (–µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã)
    const nameEl = document.querySelector("#screen-my-shop .store-name");
    if (nameEl && shop.name) nameEl.textContent = shop.name;

    // –≥–æ—Ä–æ–¥ ‚Äî —É —Ç–µ–±—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö —Å–µ–π—á–∞—Å —Ç–µ–∫—Å—Ç–æ–º, –Ω–∞–π–¥—ë–º —Å—Ç—Ä–æ–∫—É —Å üìç –∏ –∑–∞–º–µ–Ω–∏–º span
    const locRow = document.querySelectorAll("#screen-my-shop .store-contact-row");
    locRow.forEach(row => {
      if (row.textContent.includes("üìç")) {
        const spans = row.querySelectorAll("span");
        if (spans.length) spans[spans.length - 1].textContent = shop.city || spans[spans.length - 1].textContent;
      }
    });
  }

  // –¥–µ–ª–µ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –¥–∞–∂–µ –µ—Å–ª–∏ —ç–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω –ø–æ–∑–∂–µ)
  document.addEventListener("click", (e) => {
    const t = e.target;

    if (t && t.id === "shopRegBack") showScreen("business");

    if (t && t.id === "shopPreviewBtn") {
      const shop = readShopForm();
      if (!shop.name) return alert("Do‚Äòkon nomini kiriting");
      applyShopToMyShopScreen(shop);
      showScreen("my-shop");
    }

    if (t && t.id === "shopSaveBtn") {
      const shop = readShopForm();
      if (!shop.name) return alert("Do‚Äòkon nomini kiriting");

      localStorage.setItem("zalvo_my_shop", JSON.stringify(shop));
      applyShopToMyShopScreen(shop);
      showScreen("my-shop");
    }
  });

  // ---------- 7) –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω ----------
  try {
    const saved = localStorage.getItem("zalvo_my_shop");
    if (saved) applyShopToMyShopScreen(JSON.parse(saved));
  } catch (err) {}

  // ---------- 8) –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∂–µ–º home ----------
  showScreen("home");
})();

    function showScreen(name) {
  const id = `screen-${name}`;

  // 1) –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));

  // 2) –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π
  const el = document.getElementById(id);
  if (!el) {
    console.warn("showScreen: —ç–∫—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω:", id);
    return;
  }
  el.classList.add("active");

  // 3) –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  const btn = document.querySelector(`.nav-btn[data-screen="${name}"]`);
  if (btn) btn.classList.add("active");
}

// —á—Ç–æ–±—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ç–æ–∂–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ
window.showScreen = showScreen;
    
    // ================== START ==================
    applySavedProfilePhoto();
    showScreen("home");
    loadAds();

  } catch (err) {
    console.error("ZALVO SCRIPT ERROR:", err);
    alert("Script error: oching Console (F12) va xatoni ko‚Äòring. Men tuzataman.");
  }
});
</script>
</body>
</html>
