<!-- ===========================
     –ß–ê–°–¢–¨ 4 ‚Äî –ü–û–õ–ù–´–ô index.html
     –°–ö–û–ü–ò–†–û–í–ê–õ ‚Üí –°–û–•–†–ê–ù–ò–õ ‚Üí –û–¢–ö–†–´–õ
=========================== -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ZALVO Biznes uchun</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#0d172a;
      --muted:#9aa6bf;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.08);
      --accent:#6d5efc;
      --accent2:#14b8a6;
      --danger:#ef4444;
      --good:#22c55e;
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(900px 500px at 20% 0%, rgba(109,94,252,.28), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(20,184,166,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit}
    button,input,select,textarea{font:inherit}
    .app{
      width:100%;
      max-width:520px;
      margin:0 auto;
      min-height:100vh;
      padding-bottom:92px;
      position:relative;
    }

    /* ===== Top header ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      padding: 14px 14px 12px;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65));
      border-bottom: 1px solid var(--line);
    }
    .topbar-row{display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), #9b8cff);
      display:grid; place-items:center;
      box-shadow: 0 10px 22px rgba(109,94,252,.25);
      font-weight:900;
    }
    .brand-title{
      min-width:0;
      line-height:1.05;
    }
    .brand-title b{
      display:block;
      font-size:15px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-title span{
      display:block;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .topbar-actions{margin-left:auto; display:flex; gap:8px; align-items:center;}
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius: 14px;
      padding: 8px 10px;
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      transition:.15s;
    }
    .chip:active{transform:scale(.98)}
    .chip small{color:var(--muted)}
    .icon{
      width:18px; height:18px; display:inline-grid; place-items:center;
      opacity:.9;
    }

    /* ===== Screens ===== */
    .screen{display:none; padding:14px;}
    .screen.active{display:block;}

    .section-title{
      font-size:14px;
      margin: 10px 0 10px;
      color:rgba(234,240,255,.92);
      letter-spacing:.2px;
    }
    .hint{color:var(--muted); padding:14px; text-align:center}

    /* ===== Cards ===== */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card + .card{margin-top:12px}

    /* ===== Category Grid ===== */
    .cat-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .category-card{
      text-align:left;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      transition:.15s;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .category-card:active{transform:scale(.99)}
    .category-card-title{font-weight:800; font-size:14px}
    .category-card-sub{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.2}

    /* ===== Ads list ===== */
    .ad-list{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .ad-list.grid-mode{
      grid-template-columns: 1fr 1fr;
    }
    .ad-card{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      box-shadow: 0 14px 28px rgba(0,0,0,.28);
    }
    .ad-card:active{transform:scale(.997)}
    .ad-card-thumb{
      width:100%;
      height: 140px;
      object-fit: cover;
      display:block;
      filter:saturate(1.05) contrast(1.05);
    }
    .ad-card-body{padding: 10px 10px 12px}
    .ad-card-title{
      font-size:13px; font-weight:800;
      line-height:1.2;
      min-height: 32px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .ad-card-price{
      margin-top:6px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .ad-card-meta{
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      font-size:11px;
      color:rgba(234,240,255,.92);
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .badge.usd{border-color: rgba(109,94,252,.35); background: rgba(109,94,252,.12)}
    .badge.good{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .ad-card-top{
      position:absolute; top:10px; left:10px;
      background: rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.35);
      padding:6px 9px;
      border-radius: 999px;
      font-weight:900;
      font-size:11px;
      letter-spacing:.6px;
    }
    .ad-card-fav{
      position:absolute; top:10px; right:10px;
      width:36px; height:36px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(11,18,32,.55);
      backdrop-filter: blur(10px);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      font-size:16px;
    }
    .ad-card-fav:active{transform:scale(.96)}

    /* ===== Search bar ===== */
    .searchbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
    }
    .searchbar input{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:.15s;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      background: linear-gradient(135deg, var(--accent), #9b8cff);
      border-color: rgba(255,255,255,.14);
      font-weight:900;
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
      color: #ffd2d2;
    }
    .btn.slim{padding:10px 12px; border-radius: 12px}

    /* ===== Detail ===== */
    .detail-hero{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .detail-hero img{width:100%; height:220px; object-fit:cover; display:block}
    .detail-thumbs{
      display:flex; gap:8px; margin-top:10px; overflow:auto; padding-bottom:2px;
    }
    .detail-thumbs img{
      width:74px; height:52px; object-fit:cover; border-radius: 12px;
      border:1px solid var(--line);
      opacity:.95;
      cursor:pointer;
    }
    .detail-title{font-size:16px; font-weight:900; margin: 12px 0 6px}
    .detail-price{font-size:18px; font-weight:1000}
    .detail-meta{color:var(--muted); margin-top:6px; font-size:12px}
    .detail-desc{
      margin-top:12px;
      white-space:pre-wrap;
      color: rgba(234,240,255,.92);
      line-height:1.35;
      font-size:13px;
    }
    .seller-row{
      margin-top:12px;
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 12px;
      border-radius: 16px;
    }
    .seller-avatar{
      width:42px; height:42px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(20,184,166,.8), rgba(109,94,252,.7));
      display:grid; place-items:center;
      font-weight:1000;
    }
    .seller-info{min-width:0}
    .seller-info b{display:block; font-size:14px}
    .seller-info span{display:block; color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .seller-status{margin-left:auto; font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.03)}
    .actions-row{
      display:flex; gap:10px; margin-top:12px;
    }
    .actions-row .btn{flex:1}

    /* ===== Chat ===== */
    .chat-head{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px;
      display:flex; align-items:center; gap:10px;
    }
    .chat-head .back{width:38px; height:38px; border-radius: 14px}
    .chat-title{min-width:0}
    .chat-title b{display:block}
    .chat-title span{display:block; color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chat-body{
      margin-top:12px;
      height: 54vh;
      overflow:auto;
      padding: 10px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .msg-bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 16px;
      margin: 8px 0;
      font-size: 13px;
      line-height:1.35;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .msg-me{
      margin-left:auto;
      background: rgba(109,94,252,.14);
      border-color: rgba(109,94,252,.35);
    }
    .msg-them{
      background: rgba(20,184,166,.10);
      border-color: rgba(20,184,166,.28);
    }
    .chat-input{
      margin-top:10px;
      display:flex; gap:10px;
    }
    .chat-input input{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }

    /* ===== Profile ===== */
    .profile-head{
      display:flex; align-items:center; gap:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 14px;
      border-radius: 18px;
    }
    .profile-avatar{
      width:52px; height:52px; border-radius: 18px;
      background: linear-gradient(135deg, rgba(109,94,252,.85), rgba(20,184,166,.65));
      display:grid; place-items:center;
      font-weight:1000;
      font-size:18px;
    }
    .profile-info b{display:block; font-size:15px}
    .profile-info span{display:block; color:var(--muted); font-size:12px}
    .profile-actions{
      margin-top:12px;
      display:grid; gap:10px;
    }

    /* ===== Store ===== */
    .store-hero{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .store-badge{
      margin-left:auto;
      display:flex; align-items:center; gap:8px;
    }
    .dots-btn{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      display:grid; place-items:center;
    }

    .work-hours{
      margin-top:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
    }
    .work-hours .row{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
    }
    .wh-chip{
      flex:0 0 auto;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      border-radius: 14px;
      min-width: 132px;
    }
    .wh-chip b{display:block; font-size:12px}
    .wh-chip span{display:block; color:var(--muted); font-size:11px; margin-top:4px}

    /* ===== Admin ===== */
    .admin-stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
    }
    .stat b{display:block; font-size:22px}
    .stat span{display:block; color:var(--muted); font-size:12px}

    .admin-item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px;
      margin-top:10px;
    }
    .admin-item-title{font-weight:900}
    .admin-item-sub{color:var(--muted); font-size:12px; margin-top:4px}

    /* ===== Filters ===== */
    .form{
      display:grid; gap:10px;
    }
    .field label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin: 0 0 6px 2px;
    }
    .field input, .field select{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .checkrow{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px 14px;
    }
    .checkrow input{width:18px; height:18px}

    /* ===== Add Ad ===== */
    textarea{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      resize:vertical;
      min-height: 110px;
    }
    .photo-preview{
      width: 72px;
      height: 54px;
      object-fit: cover;
      border-radius: 12px;
      border:1px solid var(--line);
    }
    .photos-row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

    /* ===== Bottom Nav ===== */
    .bottom-nav{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 12px;
      width: calc(100% - 22px);
      max-width: 520px;
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(11,18,32,.70);
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 38px rgba(0,0,0,.45);
      padding: 10px 10px;
      display:flex;
      gap: 8px;
      z-index:60;
    }
    .nav-btn{
      flex:1;
      border-radius: 18px;
      border:1px solid transparent;
      background: transparent;
      color: rgba(234,240,255,.85);
      padding: 10px 8px;
      cursor:pointer;
      display:flex; flex-direction:column;
      align-items:center; gap:4px;
      font-size:11px;
    }
    .nav-btn .ico{font-size:18px; line-height:1}
    .nav-btn.active{
      background: rgba(109,94,252,.16);
      border-color: rgba(109,94,252,.25);
      color: #fff;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      top: 16px;
      width: calc(100% - 22px);
      max-width:520px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(11,18,32,.78);
      backdrop-filter: blur(16px);
      box-shadow: 0 16px 34px rgba(0,0,0,.45);
      padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
      opacity:0; pointer-events:none;
      transition:.18s;
      z-index:100;
    }
    .toast.show{opacity:1; pointer-events:auto}
    .toast .ticon{
      width:38px; height:38px; border-radius: 16px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:18px;
    }
    .toast b{display:block}
    .toast span{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    /* ===== Lightbox ===== */
    .lightbox{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:120;
      padding: 18px;
    }
    .lightbox.show{display:flex}
    .lightbox-inner{
      width:100%;
      max-width:520px;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.9);
      box-shadow: 0 20px 50px rgba(0,0,0,.55);
    }
    .lightbox-inner img{
      width:100%;
      height: 62vh;
      object-fit:contain;
      display:block;
      background: rgba(0,0,0,.25);
    }
    .lightbox-controls{
      display:flex;
      gap:10px;
      padding: 10px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .lightbox-controls .btn{flex:1}

    /* ===== Store Sheet (3 dots menu) ===== */
    .sheet-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:110;
      padding: 16px;
      align-items:flex-end;
      justify-content:center;
    }
    .sheet-backdrop.show{display:flex}
    .sheet{
      width:100%;
      max-width:520px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.92);
      backdrop-filter: blur(16px);
      box-shadow: 0 20px 50px rgba(0,0,0,.55);
      padding: 12px;
    }
    .sheet .sheet-btn{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      margin-top:10px;
      display:flex; align-items:center; gap:10px;
    }
    .sheet .sheet-btn:active{transform:scale(.995)}
    .sheet .sheet-btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.30);
    }

    /* ===== Small responsive ===== */
    @media (max-width:380px){
      .ad-card-thumb{height:128px}
      .detail-hero img{height:200px}
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-row">
        <div class="brand">
          <div class="logo">Z</div>
          <div class="brand-title">
            <b>Zalvo biznes uchun</b>
            <span>Mini App ‚Ä¢ Marketplace</span>
          </div>
        </div>

        <div class="topbar-actions">
          <button class="chip" id="toggleViewBtn" title="View">
            <span class="icon">üî≥</span><small>View</small>
          </button>
          <button class="chip" id="createAdBtn" title="Add">
            <span class="icon">‚ûï</span><small>Add</small>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== SCREENS ===== -->

    <!-- HOME -->
    <section class="screen" id="home">
      <div class="section-title">Kategoriyalar</div>
      <div class="cat-grid" id="categoryGrid"></div>

      <div class="section-title" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <span>Yangi e‚Äôlonlar</span>
        <button class="btn slim" id="openFiltersBtn">üéõÔ∏è Filtr</button>
      </div>

      <div class="ad-list" id="homeAdList"></div>
    </section>

    <!-- SEARCH -->
    <section class="screen" id="search">
      <div class="searchbar">
        <input id="searchInput" placeholder="Qidirish: telefon, mashina, uy..." />
        <button class="btn" id="openFiltersBtn2" title="Filters">üéõÔ∏è</button>
      </div>
      <div class="ad-list grid-mode" id="searchAdList"></div>
    </section>

    <!-- FAVORITES -->
    <section class="screen" id="favorites">
      <div class="section-title">Sevimlilar</div>
      <div class="ad-list grid-mode" id="favoritesAdList"></div>
    </section>

    <!-- PROFILE -->
    <section class="screen" id="profile">
      <div class="profile-head">
        <div class="profile-avatar">B</div>
        <div class="profile-info">
          <b id="profileName">‚Äî</b>
          <span id="profileUsername">‚Äî</span>
        </div>
      </div>

      <div class="profile-actions">
        <button class="btn primary" id="goMyStoreBtn">üè™ Mening do‚Äòkonim</button>
        <button class="btn" id="goAdminBtn">üõ°Ô∏è Admin panel</button>
        <button class="btn danger" id="clearLocalBtn">üßπ Local reset (demo)</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title" style="margin:0 0 8px">Eslatma</div>
        <div style="color:var(--muted); font-size:13px; line-height:1.35">
          Bu demo-versiya. Keyin serverga ulanganda login/SMS, do‚Äòkonlar, e‚Äôlon joylash, chat real bo‚Äòladi.
        </div>
      </div>
    </section>

    <!-- FILTERS -->
    <section class="screen" id="filters">
      <div class="card">
        <div class="section-title" style="margin:0 0 10px">Filtrlar</div>

        <div class="form">
          <div class="field">
            <label>Qidiruv so‚Äòzi</label>
            <input id="filterQuery" placeholder="Masalan: iPhone, lacetti..." />
          </div>

          <div class="field">
            <label>Shahar</label>
            <input id="filterCity" placeholder="Masalan: Toshkent" />
          </div>

          <div class="field">
            <label>Valyuta</label>
            <select id="filterPriceType">
              <option value="">Hammasi</option>
              <option value="uzs">UZS</option>
              <option value="usd">USD</option>
            </select>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="field">
              <label>Min narx</label>
              <input id="filterMinPrice" inputmode="numeric" placeholder="0" />
            </div>
            <div class="field">
              <label>Max narx</label>
              <input id="filterMaxPrice" inputmode="numeric" placeholder="999999999" />
            </div>
          </div>

          <div class="checkrow">
            <input type="checkbox" id="filterOnlyTop" />
            <label for="filterOnlyTop" style="margin:0; color:rgba(234,240,255,.92)">Faqat TOP</label>
          </div>

          <div style="display:flex; gap:10px; margin-top:4px;">
            <button class="btn danger" id="resetFiltersBtn">üßº Reset</button>
            <button class="btn primary" id="applyFiltersBtn" style="flex:1">üéØ Apply</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DETAIL -->
    <section class="screen" id="detail">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button class="btn slim" id="detailBackBtn">‚Üê Orqaga</button>
        <div style="color:var(--muted); font-size:12px;">E‚Äôlon</div>
      </div>

      <div class="detail-hero" id="detailMainImage"></div>
      <div class="detail-thumbs" id="detailThumbs"></div>

      <div class="detail-title" id="detailTitle">‚Äî</div>
      <div class="detail-price" id="detailPrice">‚Äî</div>
      <div class="detail-meta" id="detailMeta">‚Äî</div>

      <div class="seller-row">
        <div class="seller-avatar">S</div>
        <div class="seller-info">
          <b id="detailSellerName">‚Äî</b>
          <span id="detailSellerSub">‚Äî</span>
        </div>
        <div class="seller-status" id="detailSellerStatus">‚Äî</div>
      </div>

      <div class="actions-row">
        <button class="btn" id="detailCallBtn">üìû Call</button>
        <button class="btn primary" id="detailMsgBtn">üí¨ Message</button>
      </div>

      <div class="detail-desc" id="detailDesc"></div>

      <div class="section-title">O‚Äòxshash e‚Äôlonlar</div>
      <div class="ad-list grid-mode" id="detailSimilarList"></div>
    </section>

    <!-- CHAT -->
    <section class="screen" id="chat">
      <div class="chat-head">
        <button class="btn back" data-back>‚Üê</button>
        <div class="chat-title">
          <b id="chatTitle">‚Äî</b>
          <span id="chatSub">‚Äî</span>
        </div>
      </div>

      <div class="chat-body" id="chatMessages"></div>

      <div class="chat-input">
        <input id="chatInput" placeholder="Xabar yozing..." />
        <button class="btn primary" id="chatSendBtn">‚û§</button>
      </div>
    </section>

    <!-- STORE -->
    <section class="screen" id="store">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button class="btn slim" data-back>‚Üê Orqaga</button>
        <div style="color:var(--muted); font-size:12px;">Mening do‚Äòkonim</div>
      </div>

      <div class="store-hero">
        <div class="profile-avatar" style="width:46px;height:46px;border-radius:16px;">üè™</div>
        <div style="min-width:0">
          <b id="storeName">‚Äî</b>
          <div id="storeSub" style="color:var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">‚Äî</div>
        </div>

        <div class="store-badge">
          <button class="dots-btn" id="storeMenuBtn" title="Menu">‚ãØ</button>
        </div>
      </div>

      <div class="work-hours">
        <div class="section-title" style="margin:0 0 10px">Grafik ish vaqti</div>
        <div class="row">
          <div class="wh-chip"><b>Dushanba</b><span>09:00 ‚Äì 19:00</span></div>
          <div class="wh-chip"><b>Seshanba</b><span>09:00 ‚Äì 19:00</span></div>
          <div class="wh-chip"><b>Chorshanba</b><span>09:00 ‚Äì 19:00</span></div>
          <div class="wh-chip"><b>Payshanba</b><span>09:00 ‚Äì 19:00</span></div>
          <div class="wh-chip"><b>Juma</b><span>09:00 ‚Äì 19:00</span></div>
          <div class="wh-chip"><b>Shanba</b><span>10:00 ‚Äì 17:00</span></div>
          <div class="wh-chip"><b>Yakshanba</b><span>Dam olish</span></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title" style="margin:0 0 8px">Do‚Äòkon sozlamalari</div>
        <div style="display:grid; gap:10px">
          <button class="btn">‚úèÔ∏è Profilni tahrirlash (demo)</button>
          <button class="btn">üì¶ Mahsulotlarim (demo)</button>
          <button class="btn primary">‚ûï E‚Äôlon qo‚Äòshish</button>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section class="screen" id="admin">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button class="btn slim" data-back>‚Üê Orqaga</button>
        <div style="color:var(--muted); font-size:12px;">Admin</div>
      </div>

      <div class="admin-stats">
        <div class="stat">
          <b id="adminTotalAds">0</b>
          <span>Jami e‚Äôlonlar</span>
        </div>
        <div class="stat">
          <b id="adminTotalFavs">0</b>
          <span>Jami sevimlilar</span>
        </div>
      </div>

      <div class="section-title">Oxirgi e‚Äôlonlar</div>
      <div id="adminLatestList"></div>

      <div class="card" style="margin-top:12px">
        <div class="section-title" style="margin:0 0 8px">Moderator actions (demo)</div>
        <div style="display:grid; gap:10px">
          <button class="btn">‚úÖ Tasdiqlash</button>
          <button class="btn danger">‚õî Bloklash</button>
          <button class="btn">üìù Shikoyatlar</button>
        </div>
      </div>
    </section>

    <!-- ADD AD -->
    <section class="screen" id="addAd">
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button class="btn slim" data-back>‚Üê Orqaga</button>
        <div style="color:var(--muted); font-size:12px;">E‚Äôlon qo‚Äòshish</div>
      </div>

      <div class="card">
        <div class="form">
          <div class="field">
            <label>Sarlavha</label>
            <input id="adCreateTitle" placeholder="Masalan: iPhone 13 Pro..." />
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="field">
              <label>Narx</label>
              <input id="adCreatePrice" inputmode="numeric" placeholder="0" />
            </div>
            <div class="field">
              <label>Valyuta</label>
              <select id="adCreatePriceType">
                <option value="uzs">UZS</option>
                <option value="usd">USD</option>
              </select>
            </div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="field">
              <label>Shahar</label>
              <input id="adCreateCity" placeholder="Toshkent" />
            </div>
            <div class="field">
              <label>Tuman</label>
              <input id="adCreateDistrict" placeholder="Yunusobod" />
            </div>
          </div>

          <div class="field">
            <label>Rasmlar (demo)</label>
            <input id="adCreatePhotosInput" type="file" accept="image/*" multiple />
            <div class="photos-row" id="adCreatePhotosPreview"></div>
          </div>

          <div class="field">
            <label>Tavsif</label>
            <textarea id="adCreateDesc" placeholder="Qisqa tavsif yozing..."></textarea>
          </div>

          <button class="btn primary" id="adCreateSubmitBtn">‚úÖ E‚Äôlonni saqlash</button>
        </div>
      </div>
    </section>

  </div><!-- /app -->

  <!-- ===== BOTTOM NAV ===== -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-nav="home"><div class="ico">üè†</div>Home</button>
    <button class="nav-btn" data-nav="search"><div class="ico">üîé</div>Search</button>
    <button class="nav-btn" data-nav="favorites"><div class="ico">‚ù§Ô∏è</div>Fav</button>
    <button class="nav-btn" data-nav="profile"><div class="ico">üë§</div>Profile</button>
  </nav>

  <!-- ===== TOAST ===== -->
  <div class="toast" id="toast">
    <div class="ticon" id="toastIcon">‚úÖ</div>
    <div>
      <b id="toastMain">‚Äî</b>
      <span id="toastSub">‚Äî</span>
    </div>
  </div>

  <!-- ===== LIGHTBOX ===== -->
  <div class="lightbox" id="lightbox">
    <div class="lightbox-inner">
      <img id="lightboxImg" src="" alt="">
      <div class="lightbox-controls">
        <button class="btn" id="lightboxPrev">‚¨ÖÔ∏è Prev</button>
        <button class="btn primary" id="lightboxNext">Next ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <!-- ===== STORE SHEET ===== -->
  <div class="sheet-backdrop" id="storeSheetBackdrop">
    <div class="sheet">
      <div style="color:var(--muted); font-size:12px; padding: 4px 4px 0;">Do‚Äòkon menyu</div>
      <button class="sheet-btn" id="storeSheetShare">üîó Ulashish</button>
      <button class="sheet-btn" id="storeSheetReport">üö© Shikoyat</button>
      <button class="sheet-btn danger" id="storeSheetBlock">‚õî Bloklash</button>
      <button class="sheet-btn" onclick="document.getElementById('storeSheetBackdrop').classList.remove('show')">‚úñÔ∏è Yopish</button>
    </div>
  </div>

  <!-- ===========================
       JS (–ß–ê–°–¢–¨ 3 –í–°–¢–†–û–ï–ù–ê)
  ============================ -->
  <script>
  /* =========================================================
     ZALVO MINI APP ‚Äî JS
     –°–µ—Ä–≤–µ—Ä: –∑–∞–≥–ª—É—à–∫–∏ (–ø–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏–º).
  ========================================================= */

  const API_BASE_URL = "https://YOUR-SERVER-DOMAIN.COM/api"; // <-- –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—à—å
  const UPLOADS_BASE_URL = "https://YOUR-SERVER-DOMAIN.COM/uploads"; // <-- –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—à—å

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function formatMoneyUZS(n){
    const num = typeof n === "string" ? Number(String(n).replace(/[^\d.-]/g,"")) : n;
    if (!Number.isFinite(num)) return String(n);
    return new Intl.NumberFormat("ru-RU").format(num) + " so'm";
  }
  function formatMoneyUSD(n){
    const num = typeof n === "string" ? Number(String(n).replace(/[^\d.-]/g,"")) : n;
    if (!Number.isFinite(num)) return String(n);
    return "$" + new Intl.NumberFormat("en-US", {maximumFractionDigits:0}).format(num);
  }
  function nowISO(){ return new Date().toISOString(); }
  function safeJSONParse(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
  function uuid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  const Storage = {
    get(key, fallback){ return safeJSONParse(localStorage.getItem(key), fallback); },
    set(key, value){ localStorage.setItem(key, JSON.stringify(value)); },
    del(key){ localStorage.removeItem(key); }
  };

  let toastTimer=null;
  function showToast(main, sub="", icon="‚úÖ"){
    const toast=$("#toast"); if(!toast) return;
    $("#toastIcon").textContent=icon;
    $("#toastMain").textContent=main;
    $("#toastSub").textContent=sub;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>toast.classList.remove("show"), 2200);
  }

  const Router = {
    current:null,
    stack:[],
    go(screenId, opts={}){
      $$(".screen").forEach(s=>s.classList.remove("active"));
      const target=document.getElementById(screenId);
      if(!target){ console.warn("Screen not found:", screenId); return; }
      target.classList.add("active");
      this.current=screenId;

      if(!opts.replace){
        if(this.stack.length===0 || this.stack[this.stack.length-1]!==screenId) this.stack.push(screenId);
      } else {
        if(this.stack.length) this.stack[this.stack.length-1]=screenId;
        else this.stack.push(screenId);
      }
      Hooks.onEnter(screenId);
    },
    back(){
      if(this.stack.length<=1){ this.go("home",{replace:true}); return; }
      this.stack.pop();
      const prev=this.stack[this.stack.length-1];
      this.go(prev,{replace:true});
    }
  };

  const Hooks = {
    onEnter(screenId){
      if(screenId==="home"){ App.renderHome(); BottomNav.setActive("home"); }
      if(screenId==="search"){ App.renderSearch(); BottomNav.setActive("search"); $("#searchInput")?.focus(); }
      if(screenId==="favorites"){ App.renderFavorites(); BottomNav.setActive("favorites"); }
      if(screenId==="profile"){ App.renderProfile(); BottomNav.setActive("profile"); }
      if(screenId==="store"){ App.renderStore(); }
      if(screenId==="admin"){ App.renderAdmin(); }
      if(screenId==="chat"){ Chat.render(); }
      if(screenId==="filters"){ Filters.syncUIFromState(); }
    }
  };

  const BottomNav = {
    setActive(key){
      $$(".nav-btn").forEach(btn=>btn.classList.remove("active"));
      const btn=$(`.nav-btn[data-nav="${key}"]`);
      if(btn) btn.classList.add("active");
    },
    init(){
      $$(".nav-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const nav=btn.dataset.nav;
          if(nav==="home") Router.go("home");
          if(nav==="search") Router.go("search");
          if(nav==="favorites") Router.go("favorites");
          if(nav==="profile") Router.go("profile");
        });
      });
    }
  };

  const Mock = {
    categories:[
      {id:"transport", title:"Transport", sub:"Mashina ‚Ä¢ Moto ‚Ä¢ Zapchast"},
      {id:"realty", title:"Uy-joy", sub:"Kvartira ‚Ä¢ Hovli ‚Ä¢ Ijara"},
      {id:"jobs", title:"Ish", sub:"Vakansiya ‚Ä¢ Xizmatlar"},
      {id:"electronics", title:"Texnika", sub:"Telefon ‚Ä¢ Noutbuk ‚Ä¢ TV"},
      {id:"services", title:"Xizmatlar", sub:"Usta ‚Ä¢ Ta‚Äômir ‚Ä¢ SMM"},
      {id:"kids", title:"Bolalar", sub:"Kiyim ‚Ä¢ O‚Äòyinchoq ‚Ä¢ Arava"},
    ],
    ads(){
      return [
        {
          id:"a1",
          title:"iPhone 13 Pro 256GB, ideal holat",
          priceType:"usd",
          price:650,
          city:"Toshkent",
          district:"Yunusobod",
          condition:"Like new",
          isTop:true,
          imgs:[
            "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=1200&q=70",
            "https://images.unsplash.com/photo-1510557880182-3b3f4dbf0e30?auto=format&fit=crop&w=1200&q=70",
            "https://images.unsplash.com/photo-1523206489230-c012c64b2b48?auto=format&fit=crop&w=1200&q=70"
          ],
          desc:"Telefon juda ehtiyot qilingan.\nAkkum 88%.\nKomplekt: quti, zaryadka.",
          seller:{name:"Aziz", phone:"+998 90 123 45 67", online:true}
        },
        {
          id:"a2",
          title:"Lacetti 1.8 avtomat, 2019, 78 000 km",
          priceType:"uzs",
          price:119000000,
          city:"Farg‚Äòona",
          district:"Markaz",
          condition:"Used",
          isTop:false,
          imgs:[
            "https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=1200&q=70",
            "https://images.unsplash.com/photo-1489824904134-891ab64532f1?auto=format&fit=crop&w=1200&q=70"
          ],
          desc:"Mashina yaxshi holatda.\nYangi rezina.\nHujjatlar joyida.",
          seller:{name:"Bek", phone:"+998 91 555 77 11", online:false}
        },
        {
          id:"a3",
          title:"Usta: gipsokarton / shpatlyovka / bo‚Äòyoq",
          priceType:"uzs",
          price:0,
          city:"Samarqand",
          district:"Urgut",
          condition:"Service",
          isTop:true,
          imgs:[
            "https://images.unsplash.com/photo-1581579185169-553dcd2a1601?auto=format&fit=crop&w=1200&q=70",
            "https://images.unsplash.com/photo-1523413651479-597eb2da0ad6?auto=format&fit=crop&w=1200&q=70"
          ],
          desc:"Tez va sifatli.\nNarx kelishiladi.\nTelefon qiling.",
          seller:{name:"Rustam", phone:"+998 93 222 11 22", online:true}
        },
        {
          id:"a4",
          title:"2 xonali kvartira, ijaraga, metro yaqin",
          priceType:"usd",
          price:450,
          city:"Toshkent",
          district:"Chilonzor",
          condition:"Rent",
          isTop:false,
          imgs:[
            "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&w=1200&q=70",
            "https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=1200&q=70"
          ],
          desc:"Toza kvartira.\nDepozit bor.\nOilaga beriladi.",
          seller:{name:"Dilnoza", phone:"+998 97 444 33 22", online:true}
        }
      ];
    }
  };

  const State = {
    user: Storage.get("zalvo_user", {
      id:"u_demo",
      name:"Baxirjon",
      username:"@zalvo_user",
      phone:"+1 (___) ___-____",
      city:"Chicago",
      isSeller:true,
      createdAt: nowISO()
    }),
    favorites: new Set(Storage.get("zalvo_favs", [])),
    ads: [],
    activeAd: null,
    filters: Storage.get("zalvo_filters", {
      category:null,
      city:null,
      priceType:null,
      minPrice:null,
      maxPrice:null,
      onlyTop:false,
      query:""
    }),
    ui: { homeView: Storage.get("zalvo_home_view", "list") },
    chat: Storage.get("zalvo_chat", { threads:{} })
  };

  function persist(){
    Storage.set("zalvo_user", State.user);
    Storage.set("zalvo_favs", Array.from(State.favorites));
    Storage.set("zalvo_filters", State.filters);
    Storage.set("zalvo_home_view", State.ui.homeView);
    Storage.set("zalvo_chat", State.chat);
  }

  const API = {
    async fetchAds(){
      return new Promise(resolve=> setTimeout(()=> resolve(Mock.ads()), 150));
    },
    async createAd(payload){
      return new Promise(resolve=> setTimeout(()=> resolve({ok:true, id:uuid(), ...payload}), 250));
    }
  };

  function adToPriceText(ad){
    if(ad.price===0) return "Kelishiladi";
    return ad.priceType==="usd" ? formatMoneyUSD(ad.price) : formatMoneyUZS(ad.price);
  }

  function makeAdCard(ad){
    const isFav = State.favorites.has(ad.id);
    const badges=[];
    if(ad.priceType==="usd") badges.push(`<span class="badge usd">USD</span>`);
    if(ad.condition) badges.push(`<span class="badge">${escapeHtml(ad.condition)}</span>`);
    if(ad.isTop) badges.push(`<span class="badge good">TOP</span>`);

    return `
      <div class="ad-card" data-ad-id="${ad.id}">
        ${ad.isTop ? `<div class="ad-card-top">TOP</div>` : ``}
        <button class="ad-card-fav" data-fav="${ad.id}" aria-label="favorite">${isFav ? "‚ù§Ô∏è" : "ü§ç"}</button>
        <img class="ad-card-thumb" src="${ad.imgs?.[0] || ""}" alt="">
        <div class="ad-card-body">
          <div class="ad-card-title">${escapeHtml(ad.title)}</div>
          <div class="ad-card-price">${adToPriceText(ad)}</div>
          <div class="ad-card-meta">
            <span class="badge">${escapeHtml(ad.city || "")}</span>
            <span class="badge">${escapeHtml(ad.district || "")}</span>
            ${badges.join("")}
          </div>
        </div>
      </div>
    `;
  }

  const Filters = {
    apply(list){
      const f=State.filters;
      let out=[...list];

      if(f.query){
        const q=f.query.trim().toLowerCase();
        out=out.filter(a =>
          (a.title||"").toLowerCase().includes(q) ||
          (a.desc||"").toLowerCase().includes(q) ||
          (a.city||"").toLowerCase().includes(q) ||
          (a.district||"").toLowerCase().includes(q)
        );
      }
      if(f.category){ out=out.filter(a => a.category===f.category); } // mock –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
      if(f.city){ out=out.filter(a => (a.city||"").toLowerCase()===f.city.toLowerCase()); }
      if(f.priceType){ out=out.filter(a => a.priceType===f.priceType); }
      if(f.onlyTop){ out=out.filter(a => !!a.isTop); }

      const min = f.minPrice!=null && f.minPrice!=="" ? Number(f.minPrice) : null;
      const max = f.maxPrice!=null && f.maxPrice!=="" ? Number(f.maxPrice) : null;
      if(Number.isFinite(min)) out=out.filter(a => (a.price||0) >= min);
      if(Number.isFinite(max)) out=out.filter(a => (a.price||0) <= max || a.price===0);

      return out;
    },
    reset(){
      State.filters={category:null,city:null,priceType:null,minPrice:null,maxPrice:null,onlyTop:false,query:""};
      persist();
      showToast("Filtrlar tozalandi","Hammasi qayta tiklandi","üßº");
    },
    syncUIFromState(){
      const f=State.filters;
      $("#filterQuery") && ($("#filterQuery").value = f.query || "");
      $("#filterCity") && ($("#filterCity").value = f.city || "");
      $("#filterPriceType") && ($("#filterPriceType").value = f.priceType || "");
      $("#filterMinPrice") && ($("#filterMinPrice").value = f.minPrice ?? "");
      $("#filterMaxPrice") && ($("#filterMaxPrice").value = f.maxPrice ?? "");
      $("#filterOnlyTop") && ($("#filterOnlyTop").checked = !!f.onlyTop);
    },
    readUIToState(){
      State.filters.query = ($("#filterQuery")?.value ?? "").trim();
      const city = ($("#filterCity")?.value ?? "").trim();
      State.filters.city = city || null;
      const type = ($("#filterPriceType")?.value ?? "").trim();
      State.filters.priceType = type || null;
      const min = ($("#filterMinPrice")?.value ?? "").trim();
      const max = ($("#filterMaxPrice")?.value ?? "").trim();
      State.filters.minPrice = min || null;
      State.filters.maxPrice = max || null;
      State.filters.onlyTop = !!($("#filterOnlyTop")?.checked ?? false);
      persist();
    }
  };

  const Ads = {
    toggleFav(adId){
      if(State.favorites.has(adId)){ State.favorites.delete(adId); showToast("Sevimlilardan olib tashlandi","","üíî"); }
      else { State.favorites.add(adId); showToast("Sevimlilarga qo‚Äòshildi","","‚ù§Ô∏è"); }
      persist();
    },
    openDetail(adId){
      const ad=State.ads.find(a=>a.id===adId);
      if(!ad){ showToast("E‚Äôlon topilmadi","","‚ö†Ô∏è"); return; }
      State.activeAd=ad;
      this.renderDetail(ad);
      Router.go("detail");
    },
    renderDetail(ad){
      $("#detailTitle").textContent = ad.title;
      $("#detailPrice").textContent = adToPriceText(ad);
      $("#detailMeta").textContent = `${ad.city} ‚Ä¢ ${ad.district}`;
      $("#detailDesc").textContent = ad.desc || "";

      $("#detailSellerName").textContent = ad.seller?.name || "Seller";
      $("#detailSellerSub").textContent = ad.seller?.phone || "";
      $("#detailSellerStatus").textContent = ad.seller?.online ? "Online" : "Offline";

      const main=$("#detailMainImage");
      const thumbs=$("#detailThumbs");
      if(main){
        main.innerHTML = `<img src="${ad.imgs?.[0] || ""}" alt="">`;
        main.onclick = ()=> Lightbox.open(ad.imgs||[],0);
      }
      if(thumbs){
        thumbs.innerHTML = (ad.imgs||[]).map((src,idx)=>`<img src="${src}" data-idx="${idx}" alt="">`).join("");
        $$("img", thumbs).forEach(img=>{
          img.addEventListener("click", ()=>{
            const idx=Number(img.dataset.idx||"0");
            if(main) main.innerHTML = `<img src="${ad.imgs[idx]}" alt="">`;
          });
          img.addEventListener("dblclick", ()=>{
            const idx=Number(img.dataset.idx||"0");
            Lightbox.open(ad.imgs||[], idx);
          });
        });
      }

      $("#detailCallBtn").onclick = ()=>{
        const phone = ad.seller?.phone || "";
        if(!phone){ showToast("Telefon yo‚Äòq","","‚òéÔ∏è"); return; }
        window.location.href = `tel:${phone.replace(/\s+/g,"")}`;
      };
      $("#detailMsgBtn").onclick = ()=>{
        Chat.openThreadForAd(ad);
        Router.go("chat");
      };

      const similar=$("#detailSimilarList");
      if(similar){
        const pool=State.ads.filter(x=>x.id!==ad.id).slice(0,4);
        similar.innerHTML = pool.map(makeAdCard).join("");
        App.bindAdCards(similar);
      }
    }
  };

  const Lightbox = {
    imgs:[],
    idx:0,
    open(imgs, idx=0){
      const box=$("#lightbox"); if(!box) return;
      this.imgs = imgs || [];
      this.idx = clamp(idx,0,this.imgs.length-1);
      $("#lightboxImg").src = this.imgs[this.idx] || "";
      box.classList.add("show");
    },
    close(){ $("#lightbox")?.classList.remove("show"); },
    prev(){
      if(!this.imgs.length) return;
      this.idx = (this.idx - 1 + this.imgs.length) % this.imgs.length;
      $("#lightboxImg").src = this.imgs[this.idx];
    },
    next(){
      if(!this.imgs.length) return;
      this.idx = (this.idx + 1) % this.imgs.length;
      $("#lightboxImg").src = this.imgs[this.idx];
    },
    init(){
      $("#lightbox")?.addEventListener("click",(e)=>{ if(e.target.id==="lightbox") this.close(); });
      $("#lightboxPrev")?.addEventListener("click",(e)=>{ e.stopPropagation(); this.prev(); });
      $("#lightboxNext")?.addEventListener("click",(e)=>{ e.stopPropagation(); this.next(); });
    }
  };

  const Chat = {
    currentThreadId:null,
    openThreadForAd(ad){
      const threadId="t_"+ad.id;
      if(!State.chat.threads[threadId]){
        State.chat.threads[threadId]={
          adId:ad.id,
          sellerName: ad.seller?.name || "Seller",
          messages:[
            {from:"them", text:`Salom! ${ad.title} bo‚Äòyicha savolingiz bormi?`, ts:nowISO()}
          ]
        };
        persist();
      }
      this.currentThreadId=threadId;
      $("#chatTitle").textContent = State.chat.threads[threadId].sellerName;
      $("#chatSub").textContent = ad.title;
    },
    render(){
      const root=$("#chatMessages"); if(!root) return;
      const t=State.chat.threads[this.currentThreadId];
      if(!t){ root.innerHTML=`<div class="hint">Chat yo‚Äòq</div>`; return; }
      root.innerHTML = t.messages.map(m=>`
        <div class="msg-bubble ${m.from==="me" ? "msg-me" : "msg-them"}">${escapeHtml(m.text)}</div>
      `).join("");
      root.scrollTop = root.scrollHeight;
    },
    sendFromInput(){
      const input=$("#chatInput"); if(!input) return;
      const text=input.value.trim();
      if(!text) return;
      const t=State.chat.threads[this.currentThreadId];
      if(!t) return;
      t.messages.push({from:"me", text, ts:nowISO()});
      input.value="";
      persist();
      this.render();

      setTimeout(()=>{
        t.messages.push({from:"them", text:"Qabul qilindi ‚úÖ Tez orada javob beraman.", ts:nowISO()});
        persist();
        this.render();
      }, 650);
    }
  };

  const StoreSheet = {
    open(){ $("#storeSheetBackdrop")?.classList.add("show"); },
    close(){ $("#storeSheetBackdrop")?.classList.remove("show"); },
    init(){
      $("#storeMenuBtn")?.addEventListener("click", ()=> this.open());
      $("#storeSheetBackdrop")?.addEventListener("click", (e)=>{ if(e.target.id==="storeSheetBackdrop") this.close(); });
      $("#storeSheetShare")?.addEventListener("click", ()=>{
        this.close();
        showToast("Ulashish","Link nusxalandi (demo)","üîó");
        navigator.clipboard?.writeText("https://zalvo.uz/store/demo").catch(()=>{});
      });
      $("#storeSheetReport")?.addEventListener("click", ()=>{ this.close(); showToast("Shikoyat yuborildi","Moderator ko‚Äòradi (demo)","üö©"); });
      $("#storeSheetBlock")?.addEventListener("click", ()=>{ this.close(); showToast("Blok qilindi","Siz bu do‚Äòkonni ko‚Äòrmaysiz (demo)","‚õî"); });
    }
  };

  const AdsCreate = {
    selectedFiles:[],
    previewPhotos(e){
      const files=Array.from(e.target.files||[]);
      this.selectedFiles=files;
      const preview=$("#adCreatePhotosPreview"); if(!preview) return;
      preview.innerHTML="";
      files.slice(0,6).forEach(file=>{
        const url=URL.createObjectURL(file);
        const img=document.createElement("img");
        img.className="photo-preview";
        img.src=url;
        preview.appendChild(img);
      });
    },
    async submit(){
      const title=$("#adCreateTitle")?.value?.trim()||"";
      const price=$("#adCreatePrice")?.value?.trim()||"";
      const priceType=$("#adCreatePriceType")?.value?.trim()||"uzs";
      const city=$("#adCreateCity")?.value?.trim()||"";
      const district=$("#adCreateDistrict")?.value?.trim()||"";
      const desc=$("#adCreateDesc")?.value?.trim()||"";

      if(title.length<3){ showToast("Sarlavha kerak","Kamida 3 ta belgi","‚ö†Ô∏è"); return; }

      const payload={
        title,
        priceType,
        price: price ? Number(price) : 0,
        city, district,
        desc,
        imgs: this.selectedFiles.length
          ? ["https://images.unsplash.com/photo-1523413651479-597eb2da0ad6?auto=format&fit=crop&w=1200&q=70"]
          : ["https://images.unsplash.com/photo-1523413651479-597eb2da0ad6?auto=format&fit=crop&w=1200&q=70"],
        seller:{name:State.user.name, phone:State.user.phone, online:true},
        isTop:false,
        condition:"New"
      };

      const created=await API.createAd(payload);
      if(created?.ok){
        State.ads.unshift({id:created.id, ...payload});
        persist();
        showToast("E‚Äôlon qo‚Äòshildi","Tabriklayman!","‚úÖ");

        ["adCreateTitle","adCreatePrice","adCreateCity","adCreateDistrict","adCreateDesc"].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value="";
        });
        $("#adCreatePhotosInput") && ($("#adCreatePhotosInput").value="");
        $("#adCreatePhotosPreview") && ($("#adCreatePhotosPreview").innerHTML="");

        Router.go("home");
      } else {
        showToast("Xatolik","Keyinroq urinib ko‚Äòring","‚ùå");
      }
    }
  };

  const App = {
    async init(){
      BottomNav.init();
      this.bindGlobalButtons();
      State.ads = await API.fetchAds();
      Router.go("home",{replace:true});
    },

    bindGlobalButtons(){
      // search input
      $("#searchInput")?.addEventListener("input", (e)=>{
        State.filters.query = e.target.value;
        persist();
        this.renderSearch();
      });

      // open filters (–¥–≤–µ –∫–Ω–æ–ø–∫–∏ ‚Äî home –∏ search)
      $("#openFiltersBtn")?.addEventListener("click", ()=> Router.go("filters"));
      $("#openFiltersBtn2")?.addEventListener("click", ()=> Router.go("filters"));

      $("#applyFiltersBtn")?.addEventListener("click", ()=>{
        Filters.readUIToState();
        showToast("Filtrlar qo‚Äòllandi","Natijalar yangilandi","üéØ");
        Router.back();
        this.renderHome();
        this.renderSearch();
      });

      $("#resetFiltersBtn")?.addEventListener("click", ()=>{
        Filters.reset();
        Filters.syncUIFromState();
        this.renderHome();
        this.renderSearch();
      });

      $("#detailBackBtn")?.addEventListener("click", ()=> Router.back());

      $("#goMyStoreBtn")?.addEventListener("click", ()=> Router.go("store"));
      $("#goAdminBtn")?.addEventListener("click", ()=> Router.go("admin"));

      $("#chatSendBtn")?.addEventListener("click", ()=> Chat.sendFromInput());
      $("#chatInput")?.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){ e.preventDefault(); Chat.sendFromInput(); }
      });

      $("#createAdBtn")?.addEventListener("click", ()=> Router.go("addAd"));
      $("#adCreateSubmitBtn")?.addEventListener("click", ()=> AdsCreate.submit());
      $("#adCreatePhotosInput")?.addEventListener("change", (e)=> AdsCreate.previewPhotos(e));

      $("#toggleViewBtn")?.addEventListener("click", ()=>{
        State.ui.homeView = (State.ui.homeView==="list") ? "grid" : "list";
        persist();
        this.renderHome();
      });

      // local reset
      $("#clearLocalBtn")?.addEventListener("click", ()=>{
        localStorage.removeItem("zalvo_user");
        localStorage.removeItem("zalvo_favs");
        localStorage.removeItem("zalvo_filters");
        localStorage.removeItem("zalvo_home_view");
        localStorage.removeItem("zalvo_chat");
        showToast("Tozalandi","LocalStorage reset","üßπ");
        location.reload();
      });

      // universal back
      $$("[data-back]").forEach(btn=> btn.addEventListener("click", ()=> Router.back()));
    },

    renderHome(){
      const cat=$("#categoryGrid");
      if(cat){
        cat.innerHTML = Mock.categories.map(c=>`
          <button class="category-card" data-cat="${c.id}">
            <div class="category-card-title">${escapeHtml(c.title)}</div>
            <div class="category-card-sub">${escapeHtml(c.sub)}</div>
          </button>
        `).join("");
        $$(".category-card", cat).forEach(btn=>{
          btn.addEventListener("click", ()=>{
            State.filters.category = btn.dataset.cat;
            persist();
            showToast("Kategoriya tanlandi","Qidiruvga o‚Äòtdik","üìå");
            Router.go("search");
          });
        });
      }

      const listRoot=$("#homeAdList");
      if(!listRoot) return;
      const filtered=Filters.apply(State.ads);
      listRoot.classList.toggle("grid-mode", State.ui.homeView==="grid");
      listRoot.innerHTML = filtered.map(makeAdCard).join("") || `<div class="hint">Hozircha e‚Äôlon yo‚Äòq</div>`;
      this.bindAdCards(listRoot);
    },

    renderSearch(){
      const listRoot=$("#searchAdList");
      if(!listRoot) return;
      const si=$("#searchInput");
      if(si && si.value !== (State.filters.query||"")) si.value = State.filters.query||"";
      const filtered=Filters.apply(State.ads);
      listRoot.innerHTML = filtered.map(makeAdCard).join("") || `<div class="hint">Natija topilmadi</div>`;
      this.bindAdCards(listRoot);
    },

    renderFavorites(){
      const listRoot=$("#favoritesAdList");
      if(!listRoot) return;
      const favAds=State.ads.filter(a=>State.favorites.has(a.id));
      listRoot.innerHTML = favAds.map(makeAdCard).join("") || `<div class="hint">Sevimlilar bo‚Äòsh</div>`;
      this.bindAdCards(listRoot);
    },

    renderProfile(){
      $("#profileName") && ($("#profileName").textContent = State.user.name);
      $("#profileUsername") && ($("#profileUsername").textContent = State.user.username);
      // avatar –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞
      const av=$(".profile-avatar");
      if(av) av.textContent = (State.user.name||"B").trim().slice(0,1).toUpperCase();
    },

    renderStore(){
      $("#storeName") && ($("#storeName").textContent = "Zalvo Do‚Äòkoni");
      $("#storeSub") && ($("#storeSub").textContent = "Premium ‚Ä¢ Ishonchli sotuvchi");
    },

    renderAdmin(){
      $("#adminTotalAds") && ($("#adminTotalAds").textContent = String(State.ads.length));
      $("#adminTotalFavs") && ($("#adminTotalFavs").textContent = String(State.favorites.size));
      const list=$("#adminLatestList");
      if(list){
        const latest=[...State.ads].slice(0,4);
        list.innerHTML = latest.map(a=>`
          <div class="admin-item">
            <div class="admin-item-title">${escapeHtml(a.title)}</div>
            <div class="admin-item-sub">${escapeHtml(a.city)} ‚Ä¢ ${adToPriceText(a)}</div>
          </div>
        `).join("");
      }
    },

    bindAdCards(root){
      $$(".ad-card", root).forEach(card=>{
        card.addEventListener("click", (e)=>{
          const heart=e.target.closest("[data-fav]");
          if(heart) return;
          const id=card.dataset.adId;
          if(!id) return;
          Ads.openDetail(id);
        });
      });

      $$("[data-fav]", root).forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();
          const id=btn.getAttribute("data-fav");
          if(!id) return;
          Ads.toggleFav(id);
          this.refreshCurrent();
        });
      });
    },

    refreshCurrent(){
      const s=Router.current;
      if(s==="home") this.renderHome();
      if(s==="search") this.renderSearch();
      if(s==="favorites") this.renderFavorites();
      if(s==="admin") this.renderAdmin();
      if(s==="store") this.renderStore();
    }
  };

  document.addEventListener("DOMContentLoaded", ()=>{
    Lightbox.init();
    StoreSheet.init();
    App.init().catch(err=>{
      console.error(err);
      showToast("Xatolik","App ishga tushmadi","‚ö†Ô∏è");
    });
  });
  </script>
</body>
</html>
